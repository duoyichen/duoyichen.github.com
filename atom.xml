<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Duoyi&#39;s Blog</title>
  
  <subtitle>一个学习的小天地</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://www.duoyichen.xyz/"/>
  <updated>2018-10-01T23:21:34.155Z</updated>
  <id>http://www.duoyichen.xyz/</id>
  
  <author>
    <name>DuoyiChen</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>OpenStack Mitaka + CentOS7.2 安装部署 06</title>
    <link href="http://www.duoyichen.xyz/2018-10/openstack-m-centos-6/"/>
    <id>http://www.duoyichen.xyz/2018-10/openstack-m-centos-6/</id>
    <published>2018-10-01T20:36:18.000Z</published>
    <updated>2018-10-01T23:21:34.155Z</updated>
    
    <content type="html"><![CDATA[<p><br></p><h1 id="八、安装存储服务（cinder）"><a href="#八、安装存储服务（cinder）" class="headerlink" title="八、安装存储服务（cinder）"></a>八、安装存储服务（cinder）</h1><h2 id="8-1安装controller节点"><a href="#8-1安装controller节点" class="headerlink" title="8.1安装controller节点"></a>8.1安装controller节点</h2><h3 id="8-1-1创建数据库"><a href="#8-1-1创建数据库" class="headerlink" title="8.1.1创建数据库"></a>8.1.1创建数据库</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -popenstack -e&quot;CREATE DATABASE cinder;&quot;</span><br><span class="line">mysql -uroot -popenstack -e&quot;GRANT ALL PRIVILEGES ON cinder.* TO &apos;cinder&apos;@&apos;controller&apos; \</span><br><span class="line">  IDENTIFIED BY &apos;openstack&apos;;&quot;</span><br><span class="line">mysql -uroot -popenstack -e&quot;GRANT ALL PRIVILEGES ON cinder.* TO &apos;cinder&apos;@&apos;%&apos; \</span><br><span class="line">  IDENTIFIED BY &apos;openstack&apos;;&quot;</span><br></pre></td></tr></table></figure><h3 id="8-1-2创建cinder用户"><a href="#8-1-2创建cinder用户" class="headerlink" title="8.1.2创建cinder用户"></a>8.1.2创建cinder用户</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack user create --domain default --password=cinder cinder</span><br></pre></td></tr></table></figure><h3 id="8-1-3添加admin角色到cinder用户"><a href="#8-1-3添加admin角色到cinder用户" class="headerlink" title="8.1.3添加admin角色到cinder用户"></a>8.1.3添加admin角色到cinder用户</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack role add --project service --user cinder admin</span><br></pre></td></tr></table></figure><h3 id="8-1-4创建cinder服务"><a href="#8-1-4创建cinder服务" class="headerlink" title="8.1.4创建cinder服务"></a>8.1.4创建cinder服务</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">openstack service create --name cinder --description "OpenStack Block Storage" volume</span><br><span class="line">openstack service create --name cinderv2 --description "OpenStack Block Storage" volumev2</span><br></pre></td></tr></table></figure><h3 id="8-1-5创建cinder的api"><a href="#8-1-5创建cinder的api" class="headerlink" title="8.1.5创建cinder的api"></a>8.1.5创建cinder的api</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">openstack endpoint create --region RegionOne \</span><br><span class="line">  volume public http://controller:8776/v1/%\(tenant_id\)s</span><br><span class="line">openstack endpoint create --region RegionOne \</span><br><span class="line">  volume internal http://controller:8776/v1/%\(tenant_id\)s</span><br><span class="line">openstack endpoint create --region RegionOne \</span><br><span class="line">  volume admin http://controller:8776/v1/%\(tenant_id\)s</span><br><span class="line">openstack endpoint create --region RegionOne \</span><br><span class="line">  volumev2 public http://controller:8776/v2/%\(tenant_id\)s</span><br><span class="line">openstack endpoint create --region RegionOne \</span><br><span class="line">  volumev2 internal http://controller:8776/v2/%\(tenant_id\)s</span><br><span class="line">openstack endpoint create --region RegionOne \</span><br><span class="line">  volumev2 admin http://controller:8776/v2/%\(tenant_id\)s</span><br></pre></td></tr></table></figure><h3 id="8-1-6安装cinder"><a href="#8-1-6安装cinder" class="headerlink" title="8.1.6安装cinder"></a>8.1.6安装cinder</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y openstack-cinder</span><br></pre></td></tr></table></figure><h3 id="8-1-7配置数据库"><a href="#8-1-7配置数据库" class="headerlink" title="8.1.7配置数据库"></a>8.1.7配置数据库</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack-config --set /etc/cinder/cinder.conf database connection mysql+pymysql://cinder:openstack@controller/cinder</span><br></pre></td></tr></table></figure><h3 id="8-1-8配置rabbitmq"><a href="#8-1-8配置rabbitmq" class="headerlink" title="8.1.8配置rabbitmq"></a>8.1.8配置rabbitmq</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">openstack-config --set /etc/cinder/cinder.conf DEFAULT rpc_backend rabbit</span><br><span class="line">openstack-config --set /etc/cinder/cinder.conf oslo_messaging_rabbit rabbit_host controller</span><br><span class="line">openstack-config --set /etc/cinder/cinder.conf oslo_messaging_rabbit rabbit_userid openstack</span><br><span class="line">openstack-config --set /etc/cinder/cinder.conf oslo_messaging_rabbit rabbit_password openstack</span><br></pre></td></tr></table></figure><h3 id="8-1-9配置keystone"><a href="#8-1-9配置keystone" class="headerlink" title="8.1.9配置keystone"></a>8.1.9配置keystone</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">openstack-config --set /etc/cinder/cinder.conf DEFAULT auth_strategy keystone</span><br><span class="line">openstack-config --set /etc/cinder/cinder.conf keystone_authtoken auth_uri http://controller:5000</span><br><span class="line">openstack-config --set /etc/cinder/cinder.conf keystone_authtoken auth_url http://controller:35357</span><br><span class="line">openstack-config --set /etc/cinder/cinder.conf keystone_authtoken memcached_servers controller:11211</span><br><span class="line">openstack-config --set /etc/cinder/cinder.conf keystone_authtoken auth_type password</span><br><span class="line">openstack-config --set /etc/cinder/cinder.conf keystone_authtoken project_domain_name default</span><br><span class="line">openstack-config --set /etc/cinder/cinder.conf keystone_authtoken user_domain_name default</span><br><span class="line">openstack-config --set /etc/cinder/cinder.conf keystone_authtoken project_name service</span><br><span class="line">openstack-config --set /etc/cinder/cinder.conf keystone_authtoken username cinder</span><br><span class="line">openstack-config --set /etc/cinder/cinder.conf keystone_authtoken password cinder</span><br></pre></td></tr></table></figure><h3 id="8-1-10锁路径"><a href="#8-1-10锁路径" class="headerlink" title="8.1.10锁路径"></a>8.1.10锁路径</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack-config --set /etc/cinder/cinder.conf oslo_concurrency lock_path /var/lib/cinder/tmp</span><br></pre></td></tr></table></figure><h3 id="8-1-11初始化数据库"><a href="#8-1-11初始化数据库" class="headerlink" title="8.1.11初始化数据库"></a>8.1.11初始化数据库</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">su -s /bin/sh -c "cinder-manage db sync" cinder</span><br></pre></td></tr></table></figure><h3 id="8-1-12配置nova使用cinder"><a href="#8-1-12配置nova使用cinder" class="headerlink" title="8.1.12配置nova使用cinder"></a>8.1.12配置nova使用cinder</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">penstack-config --set /etc/nova/nova.conf cinder os_region_name RegionOne</span><br></pre></td></tr></table></figure><h3 id="8-1-13重启nova-api"><a href="#8-1-13重启nova-api" class="headerlink" title="8.1.13重启nova-api"></a>8.1.13重启nova-api</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart openstack-nova-api.service</span><br></pre></td></tr></table></figure><h3 id="8-1-14启动cinder"><a href="#8-1-14启动cinder" class="headerlink" title="8.1.14启动cinder"></a>8.1.14启动cinder</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable openstack-cinder-api.service openstack-cinder-scheduler.service</span><br><span class="line">systemctl start openstack-cinder-api.service openstack-cinder-scheduler.service</span><br></pre></td></tr></table></figure><h2 id="8-2安装存储节点"><a href="#8-2安装存储节点" class="headerlink" title="8.2安装存储节点"></a>8.2安装存储节点</h2><h3 id="8-2-1安装lvm"><a href="#8-2-1安装lvm" class="headerlink" title="8.2.1安装lvm"></a>8.2.1安装lvm</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install lvm2 -y</span><br></pre></td></tr></table></figure><h3 id="8-2-2启动lvm"><a href="#8-2-2启动lvm" class="headerlink" title="8.2.2启动lvm"></a>8.2.2启动lvm</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable lvm2-lvmetad.service</span><br><span class="line">systemctl start lvm2-lvmetad.service</span><br></pre></td></tr></table></figure><h3 id="8-2-3配置物理卷并创建卷组"><a href="#8-2-3配置物理卷并创建卷组" class="headerlink" title="8.2.3配置物理卷并创建卷组"></a>8.2.3配置物理卷并创建卷组</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pvcreate /dev/sdb</span><br><span class="line">vgcreate cinder-volumes /dev/sdb</span><br></pre></td></tr></table></figure><h3 id="8-2-4配置lvm-etc-lvm-lvm-conf"><a href="#8-2-4配置lvm-etc-lvm-lvm-conf" class="headerlink" title="8.2.4配置lvm(/etc/lvm/lvm.conf)"></a>8.2.4配置lvm(/etc/lvm/lvm.conf)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">devices &#123;</span><br><span class="line">...</span><br><span class="line">filter = [ &quot;a/sdb/&quot;, &quot;r/.*/&quot;]</span><br></pre></td></tr></table></figure><h3 id="8-2-4安装cinder"><a href="#8-2-4安装cinder" class="headerlink" title="8.2.4安装cinder"></a>8.2.4安装cinder</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install openstack-cinder targetcli python-keystone -y</span><br></pre></td></tr></table></figure><h3 id="8-2-5配置rabbitmq"><a href="#8-2-5配置rabbitmq" class="headerlink" title="8.2.5配置rabbitmq"></a>8.2.5配置rabbitmq</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">openstack-config --set /etc/cinder/cinder.conf DEFAULT rpc_backend rabbit</span><br><span class="line">openstack-config --set /etc/cinder/cinder.conf oslo_messaging_rabbit rabbit_host controller</span><br><span class="line">openstack-config --set /etc/cinder/cinder.conf oslo_messaging_rabbit rabbit_userid openstack</span><br><span class="line">openstack-config --set /etc/cinder/cinder.conf oslo_messaging_rabbit rabbit_password openstack</span><br></pre></td></tr></table></figure><h3 id="8-2-6配置keystone"><a href="#8-2-6配置keystone" class="headerlink" title="8.2.6配置keystone"></a>8.2.6配置keystone</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">openstack-config --set /etc/cinder/cinder.conf DEFAULT auth_strategy keystone</span><br><span class="line">openstack-config --set /etc/cinder/cinder.conf keystone_authtoken auth_uri http://controller:5000</span><br><span class="line">openstack-config --set /etc/cinder/cinder.conf keystone_authtoken auth_url http://controller:35357</span><br><span class="line">openstack-config --set /etc/cinder/cinder.conf keystone_authtoken memcached_servers controller:11211</span><br><span class="line">openstack-config --set /etc/cinder/cinder.conf keystone_authtoken auth_type password</span><br><span class="line">openstack-config --set /etc/cinder/cinder.conf keystone_authtoken project_domain_name default</span><br><span class="line">openstack-config --set /etc/cinder/cinder.conf keystone_authtoken user_domain_name default</span><br><span class="line">openstack-config --set /etc/cinder/cinder.conf keystone_authtoken project_name service</span><br><span class="line">openstack-config --set /etc/cinder/cinder.conf keystone_authtoken username cinder</span><br><span class="line">openstack-config --set /etc//cinder/cinder.conf keystone_authtoken password cinder</span><br></pre></td></tr></table></figure><h3 id="8-2-7配置ip和锁路径"><a href="#8-2-7配置ip和锁路径" class="headerlink" title="8.2.7配置ip和锁路径"></a>8.2.7配置ip和锁路径</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">openstack-config --set /etc//cinder/cinder.conf DEFAULT my_ip 10.0.20.30</span><br><span class="line">openstack-config --set /etc//cinder/cinder.conf oslo_concurrency lock_path /var/lib/cinder/tmp</span><br></pre></td></tr></table></figure><h3 id="8-2-8配置cinder使用lvm"><a href="#8-2-8配置cinder使用lvm" class="headerlink" title="8.2.8配置cinder使用lvm"></a>8.2.8配置cinder使用lvm</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">openstack-config --set /etc/cinder/cinder.conf lvm volume_driver cinder.volume.drivers.lvm.LVMVolumeDriver</span><br><span class="line">openstack-config --set /etc/cinder/cinder.conf lvm volume_group cinder-volumes</span><br><span class="line">openstack-config --set /etc/cinder/cinder.conf lvm iscsi_protocol iscsi</span><br><span class="line">openstack-config --set /etc/cinder/cinder.conf lvm iscsi_helper lioadm</span><br><span class="line">openstack-config --set /etc/cinder/cinder.conf DEFAULT enabled_backends lvm</span><br></pre></td></tr></table></figure><h3 id="8-2-9配置数据库"><a href="#8-2-9配置数据库" class="headerlink" title="8.2.9配置数据库"></a>8.2.9配置数据库</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack-config --set /etc/cinder/cinder.conf database connection mysql+pymysql://cinder:openstack@controller/cinder</span><br></pre></td></tr></table></figure><h3 id="8-2-10启动cinder"><a href="#8-2-10启动cinder" class="headerlink" title="8.2.10启动cinder"></a>8.2.10启动cinder</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable openstack-cinder-volume.service target.service</span><br><span class="line">systemctl start openstack-cinder-volume.service target.service</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      descriptions
    
    </summary>
    
      <category term="云计算" scheme="http://www.duoyichen.xyz/categories/%E4%BA%91%E8%AE%A1%E7%AE%97/"/>
    
    
      <category term="python" scheme="http://www.duoyichen.xyz/tags/python/"/>
    
      <category term="openstack" scheme="http://www.duoyichen.xyz/tags/openstack/"/>
    
      <category term="云计算" scheme="http://www.duoyichen.xyz/tags/%E4%BA%91%E8%AE%A1%E7%AE%97/"/>
    
  </entry>
  
  <entry>
    <title>OpenStack Mitaka + CentOS7.2 安装部署 05</title>
    <link href="http://www.duoyichen.xyz/2018-10/openstack-m-centos-5/"/>
    <id>http://www.duoyichen.xyz/2018-10/openstack-m-centos-5/</id>
    <published>2018-10-01T20:36:17.000Z</published>
    <updated>2018-10-01T23:21:15.572Z</updated>
    
    <content type="html"><![CDATA[<p><br></p><h1 id="七、安装dashboard"><a href="#七、安装dashboard" class="headerlink" title="七、安装dashboard"></a>七、安装dashboard</h1><h2 id="7-1安装"><a href="#7-1安装" class="headerlink" title="7.1安装"></a>7.1安装</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install openstack-dashboard -y</span><br></pre></td></tr></table></figure><h2 id="7-2配置"><a href="#7-2配置" class="headerlink" title="7.2配置"></a>7.2配置</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">sed -i &quot;s#OPENSTACK_HOST = \&quot;127.0.0.1\&quot;#OPENSTACK_HOST = \&quot;controller\&quot;#g&quot; /etc/openstack-dashboard/local_settings</span><br><span class="line">sed -i &quot;s#ALLOWED_HOSTS = \[&apos;horizon.example.com&apos;, &apos;localhost&apos;\]#ALLOWED_HOSTS = \[&apos;*&apos;, \]#g&quot; /etc/openstack-dashboard/local_settings</span><br><span class="line">echo &quot;SESSION_ENGINE = &apos;django.contrib.sessions.backends.cache&apos;&quot; &gt;&gt; /etc/openstack-dashboard/local_settings</span><br><span class="line">sed -i &quot;s@#CACHES = &#123;@CACHES = &#123;@g&quot; /etc/openstack-dashboard/local_settings</span><br><span class="line">sed -i &quot;s@#    &apos;default&apos;: &#123;@    &apos;default&apos;: &#123;@g&quot; /etc/openstack-dashboard/local_settings</span><br><span class="line">sed -i &quot;s@#        &apos;BACKEND&apos;: &apos;django.core.cache.backends.memcached.MemcachedCache&apos;,@        &apos;BACKEND&apos;: &apos;django.core.cache.backends.memcached.MemcachedCache&apos;,@g&quot; /etc/openstack-dashboard/local_settings</span><br><span class="line">sed -i &quot;s@#        &apos;LOCATION&apos;: &apos;127.0.0.1:11211&apos;,@        &apos;LOCATION&apos;: &apos;controller:11211&apos;,@g&quot; /etc/openstack-dashboard/local_settings</span><br><span class="line">sed -i &quot;s@#    &#125;,@    &#125;,@g&quot; /etc/openstack-dashboard/local_settings</span><br><span class="line">sed -i &quot;s@#OPENSTACK_KEYSTONE_MULTIDOMAIN_SUPPORT = False@OPENSTACK_KEYSTONE_MULTIDOMAIN_SUPPORT = True@g&quot; /etc/openstack-dashboard/local_settings</span><br><span class="line">sed -i &quot;s@OPENSTACK_KEYSTONE_DEFAULT_ROLE = \&quot;_member_\&quot;@OPENSTACK_KEYSTONE_DEFAULT_ROLE = \&quot;user\&quot;@g&quot; /etc/openstack-dashboard/local_settings</span><br><span class="line">sed -i &quot;s@#OPENSTACK_KEYSTONE_DEFAULT_DOMAIN = &apos;default&apos;@OPENSTACK_KEYSTONE_DEFAULT_DOMAIN = &apos;default&apos;@g&quot; /etc/openstack-dashboard/local_settings</span><br><span class="line">sed -i &quot;s@#OPENSTACK_API_VERSIONS@OPENSTACK_API_VERSIONS@g&quot; /etc/openstack-dashboard/local_settings</span><br><span class="line">sed -i &quot;s@#    \&quot;identity\&quot;: 3,@    \&quot;identity\&quot;: 3,@g&quot; /etc/openstack-dashboard/local_settings</span><br><span class="line">sed -i &quot;s@#    \&quot;volume\&quot;: 2@    \&quot;volume\&quot;: 2@g&quot; /etc/openstack-dashboard/local_settings</span><br><span class="line">sed -i &quot;s@#    \&quot;compute\&quot;: 2,@    \&quot;compute\&quot;: 2,@g&quot; /etc/openstack-dashboard/local_settings</span><br><span class="line">sed -i &quot;133s@#@@g&quot; /etc/openstack-dashboard/local_settings</span><br><span class="line">sed -i &quot;132s@#@@g&quot; /etc/openstack-dashboard/local_settings</span><br><span class="line">sed -i &quot;60s@#@@g&quot; /etc/openstack-dashboard/local_settings</span><br></pre></td></tr></table></figure><h3 id="7-3重启apache"><a href="#7-3重启apache" class="headerlink" title="7.3重启apache"></a>7.3重启apache</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart httpd</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      descriptions
    
    </summary>
    
      <category term="云计算" scheme="http://www.duoyichen.xyz/categories/%E4%BA%91%E8%AE%A1%E7%AE%97/"/>
    
    
      <category term="python" scheme="http://www.duoyichen.xyz/tags/python/"/>
    
      <category term="openstack" scheme="http://www.duoyichen.xyz/tags/openstack/"/>
    
      <category term="云计算" scheme="http://www.duoyichen.xyz/tags/%E4%BA%91%E8%AE%A1%E7%AE%97/"/>
    
  </entry>
  
  <entry>
    <title>OpenStack Mitaka + CentOS7.2 安装部署 04</title>
    <link href="http://www.duoyichen.xyz/2018-10/openstack-m-centos-4/"/>
    <id>http://www.duoyichen.xyz/2018-10/openstack-m-centos-4/</id>
    <published>2018-10-01T20:36:16.000Z</published>
    <updated>2018-10-01T23:19:50.890Z</updated>
    
    <content type="html"><![CDATA[<p><br></p><h1 id="六、安装网络服务（neutron）"><a href="#六、安装网络服务（neutron）" class="headerlink" title="六、安装网络服务（neutron）"></a>六、安装网络服务（neutron）</h1><h2 id="6-1安装控制节点（controller）"><a href="#6-1安装控制节点（controller）" class="headerlink" title="6.1安装控制节点（controller）"></a>6.1安装控制节点（controller）</h2><h3 id="6-1-1创建数据库"><a href="#6-1-1创建数据库" class="headerlink" title="6.1.1创建数据库"></a>6.1.1创建数据库</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -popenstack -e"CREATE DATABASE neutron;"</span><br><span class="line">mysql -uroot -popenstack -e"GRANT ALL PRIVILEGES ON neutron.* TO 'neutron'@'controller' IDENTIFIED BY 'openstack';"</span><br><span class="line">mysql -uroot -popenstack -e"GRANT ALL PRIVILEGES ON neutron.* TO 'neutron'@'%' IDENTIFIED BY 'openstack';"</span><br></pre></td></tr></table></figure><h3 id="6-1-2创建neutron用户"><a href="#6-1-2创建neutron用户" class="headerlink" title="6.1.2创建neutron用户"></a>6.1.2创建neutron用户</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack user create --domain default --password=neutron neutron</span><br></pre></td></tr></table></figure><h3 id="6-1-3添加admin角色到neutron角色"><a href="#6-1-3添加admin角色到neutron角色" class="headerlink" title="6.1.3添加admin角色到neutron角色"></a>6.1.3添加admin角色到neutron角色</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack role add --project service --user neutron admin</span><br></pre></td></tr></table></figure><h3 id="6-1-4创建neutron服务"><a href="#6-1-4创建neutron服务" class="headerlink" title="6.1.4创建neutron服务"></a>6.1.4创建neutron服务</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack service create --name neutron --description "OpenStack Networking" network</span><br></pre></td></tr></table></figure><h3 id="6-1-5创建neutron的api"><a href="#6-1-5创建neutron的api" class="headerlink" title="6.1.5创建neutron的api"></a>6.1.5创建neutron的api</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">openstack endpoint create --region RegionOne network public http://controller:9696</span><br><span class="line">openstack endpoint create --region RegionOne network internal http://controller:9696</span><br><span class="line">openstack endpoint create --region RegionOne network admin http://controller:9696</span><br></pre></td></tr></table></figure><h3 id="6-1-6安装相关组件"><a href="#6-1-6安装相关组件" class="headerlink" title="6.1.6安装相关组件"></a>6.1.6安装相关组件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y openstack-neutron openstack-neutron-ml2 openstack-neutron-linuxbridge ebtables</span><br></pre></td></tr></table></figure><h3 id="6-1-7配置数据库连接"><a href="#6-1-7配置数据库连接" class="headerlink" title="6.1.7配置数据库连接"></a>6.1.7配置数据库连接</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack-config --set /etc/neutron/neutron.conf database connection mysql+pymysql://neutron:openstack@controller/neutron</span><br></pre></td></tr></table></figure><h3 id="6-1-8配置使用ml2插件"><a href="#6-1-8配置使用ml2插件" class="headerlink" title="6.1.8配置使用ml2插件"></a>6.1.8配置使用ml2插件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">openstack-config --set /etc/neutron/neutron.conf DEFAULT core_plugin ml2</span><br><span class="line">openstack-config --set /etc/neutron/neutron.conf DEFAULT service_plugins router</span><br><span class="line">openstack-config --set /etc/neutron/neutron.conf DEFAULT allow_overlapping_ips True</span><br></pre></td></tr></table></figure><h3 id="6-1-9配置rabbitmq"><a href="#6-1-9配置rabbitmq" class="headerlink" title="6.1.9配置rabbitmq"></a>6.1.9配置rabbitmq</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">openstack-config --set /etc/neutron/neutron.conf DEFAULT rpc_backend rabbit</span><br><span class="line">openstack-config --set /etc/neutron/neutron.conf oslo_messaging_rabbit rabbit_host controller</span><br><span class="line">openstack-config --set /etc/neutron/neutron.conf oslo_messaging_rabbit rabbit_userid openstack</span><br><span class="line">openstack-config --set /etc/neutron/neutron.conf oslo_messaging_rabbit rabbit_password openstack</span><br></pre></td></tr></table></figure><h3 id="6-1-10配置keystone"><a href="#6-1-10配置keystone" class="headerlink" title="6.1.10配置keystone"></a>6.1.10配置keystone</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">openstack-config --set /etc/neutron/neutron.conf DEFAULT auth_strategy keystone</span><br><span class="line">openstack-config --set /etc/neutron/neutron.conf keystone_authtoken auth_uri http://controller:5000</span><br><span class="line">openstack-config --set /etc/neutron/neutron.conf keystone_authtoken auth_url http://controller:35357</span><br><span class="line">openstack-config --set /etc/neutron/neutron.conf keystone_authtoken memcached_servers controller:11211</span><br><span class="line">openstack-config --set /etc/neutron/neutron.conf keystone_authtoken auth_type password</span><br><span class="line">openstack-config --set /etc/neutron/neutron.conf keystone_authtoken project_domain_name default</span><br><span class="line">openstack-config --set /etc/neutron/neutron.conf keystone_authtoken user_domain_name default</span><br><span class="line">openstack-config --set /etc/neutron/neutron.conf keystone_authtoken project_name service</span><br><span class="line">openstack-config --set /etc/neutron/neutron.conf keystone_authtoken username neutron</span><br><span class="line">openstack-config --set /etc/neutron/neutron.conf keystone_authtoken password neutron</span><br></pre></td></tr></table></figure><h3 id="6-1-11配置nova"><a href="#6-1-11配置nova" class="headerlink" title="6.1.11配置nova"></a>6.1.11配置nova</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">openstack-config --set /etc/neutron/neutron.conf DEFAULT notify_nova_on_port_status_changes True</span><br><span class="line">openstack-config --set /etc/neutron/neutron.conf DEFAULT notify_nova_on_port_data_changes True</span><br><span class="line">openstack-config --set /etc/neutron/neutron.conf nova auth_url http://controller:35357</span><br><span class="line">openstack-config --set /etc/neutron/neutron.conf nova auth_type password</span><br><span class="line">openstack-config --set /etc/neutron/neutron.conf nova project_domain_name default</span><br><span class="line">openstack-config --set /etc/neutron/neutron.conf nova user_domain_name default</span><br><span class="line">openstack-config --set /etc/neutron/neutron.conf nova region_name RegionOne</span><br><span class="line">openstack-config --set /etc/neutron/neutron.conf nova project_name service</span><br><span class="line">openstack-config --set /etc/neutron/neutron.conf nova username nova</span><br><span class="line">openstack-config --set /etc/neutron/neutron.conf nova password nova</span><br></pre></td></tr></table></figure><h3 id="6-1-12配置锁路径"><a href="#6-1-12配置锁路径" class="headerlink" title="6.1.12配置锁路径"></a>6.1.12配置锁路径</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack-config --set /etc/neutron/neutron.conf oslo_concurrency lock_path /var/lib/neutron/tmp</span><br></pre></td></tr></table></figure><h3 id="6-1-13配置ml2"><a href="#6-1-13配置ml2" class="headerlink" title="6.1.13配置ml2"></a>6.1.13配置ml2</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2 type_drivers flat,vlan,vxlan</span><br><span class="line">openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2 tenant_network_types vxlan</span><br><span class="line">openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2 mechanism_drivers linuxbridge,l2population</span><br><span class="line">openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2 extension_drivers port_security</span><br><span class="line">openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2_type_flat flat_networks provider</span><br><span class="line">openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2_type_vxlan vni_ranges 1:1000</span><br><span class="line">openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini securitygroup enable_ipset True</span><br></pre></td></tr></table></figure><h3 id="6-1-14配置Linuxbridge代理"><a href="#6-1-14配置Linuxbridge代理" class="headerlink" title="6.1.14配置Linuxbridge代理"></a>6.1.14配置Linuxbridge代理</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">openstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini linux_bridge physical_interface_mappings provider:eth2</span><br><span class="line">openstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini vxlan enable_vxlan True</span><br><span class="line">openstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini vxlan local_ip 10.0.20.10</span><br><span class="line">openstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini vxlan l2_population True</span><br><span class="line">openstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini securitygroup enable_security_group True</span><br><span class="line">openstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini securitygroup firewall_driver neutron.agent.linux.iptables_firewall.IptablesFirewallDriver</span><br></pre></td></tr></table></figure><h3 id="6-1-15配置DHCP代理"><a href="#6-1-15配置DHCP代理" class="headerlink" title="6.1.15配置DHCP代理"></a>6.1.15配置DHCP代理</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">openstack-config --set /etc/neutron/dhcp_agent.ini DEFAULT interface_driver neutron.agent.linux.interface.BridgeInterfaceDriver</span><br><span class="line">openstack-config --set /etc/neutron/dhcp_agent.ini DEFAULT dhcp_driver neutron.agent.linux.dhcp.Dnsmasq</span><br><span class="line">openstack-config --set /etc/neutron/dhcp_agent.ini DEFAULT enable_isolated_metadata True</span><br></pre></td></tr></table></figure><h3 id="6-1-16配置layer－3代理"><a href="#6-1-16配置layer－3代理" class="headerlink" title="6.1.16配置layer－3代理"></a>6.1.16配置layer－3代理</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">openstack-config --set /etc/neutron/l3_agent.ini DEFAULT interface_driver neutron.agent.linux.interface.BridgeInterfaceDriver</span><br><span class="line">openstack-config --set /etc/neutron/l3_agent.ini DEFAULT external_network_bridge</span><br></pre></td></tr></table></figure><h3 id="6-1-17配置nova"><a href="#6-1-17配置nova" class="headerlink" title="6.1.17配置nova"></a>6.1.17配置nova</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">openstack-config --set /etc/nova/nova.conf neutron url http://controller:9696</span><br><span class="line">openstack-config --set /etc/nova/nova.conf neutron auth_url http://controller:35357</span><br><span class="line">openstack-config --set /etc/nova/nova.conf neutron auth_type password</span><br><span class="line">openstack-config --set /etc/nova/nova.conf neutron project_domain_name default</span><br><span class="line">openstack-config --set /etc/nova/nova.conf neutron user_domain_name default</span><br><span class="line">openstack-config --set /etc/nova/nova.conf neutron region_name RegionOne</span><br><span class="line">openstack-config --set /etc/nova/nova.conf neutron project_name service</span><br><span class="line">openstack-config --set /etc/nova/nova.conf neutron username neutron</span><br><span class="line">openstack-config --set /etc/nova/nova.conf neutron password neutron</span><br><span class="line">openstack-config --set /etc/nova/nova.conf neutron service_metadata_proxy True</span><br><span class="line">openstack-config --set /etc/nova/nova.conf neutron metadata_proxy_shared_secret METADATA_SECRET</span><br></pre></td></tr></table></figure><h3 id="6-1-18配置元数据代理"><a href="#6-1-18配置元数据代理" class="headerlink" title="6.1.18配置元数据代理"></a>6.1.18配置元数据代理</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">openstack-config --set /etc/neutron/metadata_agent.ini DEFAULT nova_metadata_ip controller</span><br><span class="line">openstack-config --set /etc/neutron/metadata_agent.ini DEFAULT metadata_proxy_shared_secret METADATA_SECRET</span><br></pre></td></tr></table></figure><h3 id="6-1-19创建软连接"><a href="#6-1-19创建软连接" class="headerlink" title="6.1.19创建软连接"></a>6.1.19创建软连接</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln -s /etc/neutron/plugins/ml2/ml2_conf.ini /etc/neutron/plugin.ini</span><br></pre></td></tr></table></figure><h3 id="6-1-20同步数据库"><a href="#6-1-20同步数据库" class="headerlink" title="6.1.20同步数据库"></a>6.1.20同步数据库</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">su -s /bin/sh -c "neutron-db-manage --config-file /etc/neutron/neutron.conf \</span><br><span class="line">  --config-file /etc/neutron/plugins/ml2/ml2_conf.ini upgrade head" neutron</span><br></pre></td></tr></table></figure><h3 id="6-1-21重启nova-api"><a href="#6-1-21重启nova-api" class="headerlink" title="6.1.21重启nova-api"></a>6.1.21重启nova-api</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart openstack-nova-api.service</span><br></pre></td></tr></table></figure><h3 id="6-1-22启动neutron"><a href="#6-1-22启动neutron" class="headerlink" title="6.1.22启动neutron"></a>6.1.22启动neutron</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable neutron-server.service \</span><br><span class="line">  neutron-linuxbridge-agent.service neutron-dhcp-agent.service \</span><br><span class="line">  neutron-metadata-agent.service</span><br><span class="line">systemctl start neutron-server.service \</span><br><span class="line">  neutron-linuxbridge-agent.service neutron-dhcp-agent.service \</span><br><span class="line">  neutron-metadata-agent.service</span><br><span class="line">systemctl enable neutron-l3-agent.service</span><br><span class="line">systemctl start neutron-l3-agent.service</span><br></pre></td></tr></table></figure><h2 id="6-2安装计算节点（compute）"><a href="#6-2安装计算节点（compute）" class="headerlink" title="6.2安装计算节点（compute）"></a>6.2安装计算节点（compute）</h2><h3 id="6-2-1安装组件"><a href="#6-2-1安装组件" class="headerlink" title="6.2.1安装组件"></a>6.2.1安装组件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y openstack-neutron-linuxbridge ebtables ipset</span><br></pre></td></tr></table></figure><h3 id="6-2-2配置rabbitmq"><a href="#6-2-2配置rabbitmq" class="headerlink" title="6.2.2配置rabbitmq"></a>6.2.2配置rabbitmq</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">openstack-config --set /etc/neutron/neutron.conf DEFAULT rpc_backend rabbit</span><br><span class="line">openstack-config --set /etc/neutron/neutron.conf oslo_messaging_rabbit rabbit_host controller</span><br><span class="line">openstack-config --set /etc/neutron/neutron.conf oslo_messaging_rabbit rabbit_userid openstack</span><br><span class="line">openstack-config --set /etc/neutron/neutron.conf oslo_messaging_rabbit rabbit_password openstack</span><br></pre></td></tr></table></figure><h3 id="6-2-3配置keystone"><a href="#6-2-3配置keystone" class="headerlink" title="6.2.3配置keystone"></a>6.2.3配置keystone</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">openstack-config --set /etc/neutron/neutron.conf DEFAULT auth_strategy keystone</span><br><span class="line">openstack-config --set /etc/neutron/neutron.conf keystone_authtoken auth_uri http://controller:5000</span><br><span class="line">openstack-config --set /etc/neutron/neutron.conf keystone_authtoken auth_url http://controller:35357</span><br><span class="line">openstack-config --set /etc/neutron/neutron.conf keystone_authtoken memcached_servers controller:11211</span><br><span class="line">openstack-config --set /etc/neutron/neutron.conf keystone_authtoken auth_type password</span><br><span class="line">openstack-config --set /etc/neutron/neutron.conf keystone_authtoken project_domain_name default</span><br><span class="line">openstack-config --set /etc/neutron/neutron.conf keystone_authtoken user_domain_name default</span><br><span class="line">openstack-config --set /etc/neutron/neutron.conf keystone_authtoken project_name service</span><br><span class="line">openstack-config --set /etc/neutron/neutron.conf keystone_authtoken username neutron</span><br><span class="line">openstack-config --set /etc/neutron/neutron.conf keystone_authtoken password neutron</span><br></pre></td></tr></table></figure><h3 id="6-2-4配置锁路径"><a href="#6-2-4配置锁路径" class="headerlink" title="6.2.4配置锁路径"></a>6.2.4配置锁路径</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack-config --set /etc/neutron/neutron.conf oslo_concurrency lock_path /var/lib/neutron/tmp</span><br></pre></td></tr></table></figure><h3 id="6-2-5配置Linuxbridge代理"><a href="#6-2-5配置Linuxbridge代理" class="headerlink" title="6.2.5配置Linuxbridge代理"></a>6.2.5配置Linuxbridge代理</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">openstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini linux_bridge physical_interface_mappings provider:eth2</span><br><span class="line">openstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini vxlan enable_vxlan True</span><br><span class="line">openstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini vxlan local_ip 10.0.20.20</span><br><span class="line">openstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini vxlan l2_population True</span><br><span class="line">openstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini securitygroup enable_security_group True</span><br><span class="line">openstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini securitygroup firewall_driver neutron.agent.linux.iptables_firewall.IptablesFirewallDriver</span><br></pre></td></tr></table></figure><h3 id="6-2-6配置nova"><a href="#6-2-6配置nova" class="headerlink" title="6.2.6配置nova"></a>6.2.6配置nova</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">openstack-config --set /etc/nova/nova.conf neutron url http://controller:9696</span><br><span class="line">openstack-config --set /etc/nova/nova.conf neutron auth_url http://controller:35357</span><br><span class="line">openstack-config --set /etc/nova/nova.conf neutron auth_type password</span><br><span class="line">openstack-config --set /etc/nova/nova.conf neutron project_domain_name default</span><br><span class="line">openstack-config --set /etc/nova/nova.conf neutron user_domain_name default</span><br><span class="line">openstack-config --set /etc/nova/nova.conf neutron region_name RegionOne</span><br><span class="line">openstack-config --set /etc/nova/nova.conf neutron project_name service</span><br><span class="line">openstack-config --set /etc/nova/nova.conf neutron username neutron</span><br><span class="line">openstack-config --set /etc/nova/nova.conf neutron password neutron</span><br></pre></td></tr></table></figure><h3 id="6-2-7重启nova-api"><a href="#6-2-7重启nova-api" class="headerlink" title="6.2.7重启nova-api"></a>6.2.7重启nova-api</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart openstack-nova-compute.service</span><br></pre></td></tr></table></figure><h3 id="6-2-8启动Linuxbridge代理"><a href="#6-2-8启动Linuxbridge代理" class="headerlink" title="6.2.8启动Linuxbridge代理"></a>6.2.8启动Linuxbridge代理</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable neutron-linuxbridge-agent.service</span><br><span class="line">systemctl start neutron-linuxbridge-agent.service</span><br></pre></td></tr></table></figure><h3 id="6-2-9-验证安装"><a href="#6-2-9-验证安装" class="headerlink" title="6.2.9 验证安装"></a>6.2.9 验证安装</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@controller ~ 20:04:49 # neutron agent-list</span><br><span class="line">+--------------------------------------+--------------------+------------+-------------------+-------+----------------+---------------------------+</span><br><span class="line">| id                                   | agent_type         | host       | availability_zone | alive | admin_state_up | binary                    |</span><br><span class="line">+--------------------------------------+--------------------+------------+-------------------+-------+----------------+---------------------------+</span><br><span class="line">| 14259fcd-448f-4fb6-ba30-fb5885ebe878 | Metadata agent     | controller |                   | :-)   | True           | neutron-metadata-agent    |</span><br><span class="line">| 1994d93b-f6cf-4dd3-8a2a-3623b473c675 | L3 agent           | controller | nova              | :-)   | True           | neutron-l3-agent          |</span><br><span class="line">| 9c44da60-3e2a-466e-9185-9c30840ab699 | DHCP agent         | controller | nova              | :-)   | True           | neutron-dhcp-agent        |</span><br><span class="line">| afd1d41d-d83d-46ec-b916-e5f9e6d3725e | Linux bridge agent | compute    |                   | :-)   | True           | neutron-linuxbridge-agent |</span><br><span class="line">| e5006fdb-b45d-4d9c-b129-6fefbad8a3d5 | Linux bridge agent | controller |                   | :-)   | True           | neutron-linuxbridge-agent |</span><br><span class="line">+--------------------------------------+--------------------+------------+-------------------+-------+----------------+---------------------------+</span><br></pre></td></tr></table></figure><h3 id="6-2-10创建网络"><a href="#6-2-10创建网络" class="headerlink" title="6.2.10创建网络"></a>6.2.10创建网络</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">neutron net-create --shared --provider:physical_network provider \</span><br><span class="line">  --provider:network_type flat provider</span><br><span class="line">neutron subnet-create --name provider \</span><br><span class="line">  --allocation-pool start=10.0.30.100,end=10.0.30.200 \</span><br><span class="line">  --dns-nameserver 8.8.4.4 --gateway 10.0.30.1 \</span><br><span class="line">  provider 10.0.30.0/24</span><br><span class="line">neutron net-update provider --router:external</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      descriptions
    
    </summary>
    
      <category term="云计算" scheme="http://www.duoyichen.xyz/categories/%E4%BA%91%E8%AE%A1%E7%AE%97/"/>
    
    
      <category term="python" scheme="http://www.duoyichen.xyz/tags/python/"/>
    
      <category term="openstack" scheme="http://www.duoyichen.xyz/tags/openstack/"/>
    
      <category term="云计算" scheme="http://www.duoyichen.xyz/tags/%E4%BA%91%E8%AE%A1%E7%AE%97/"/>
    
  </entry>
  
  <entry>
    <title>OpenStack Mitaka + CentOS7.2 安装部署 03</title>
    <link href="http://www.duoyichen.xyz/2018-10/openstack-m-centos-3/"/>
    <id>http://www.duoyichen.xyz/2018-10/openstack-m-centos-3/</id>
    <published>2018-10-01T20:36:15.000Z</published>
    <updated>2018-10-01T23:22:09.133Z</updated>
    
    <content type="html"><![CDATA[<p><br></p><h1 id="四、镜像服务（glance，在controller）"><a href="#四、镜像服务（glance，在controller）" class="headerlink" title="四、镜像服务（glance，在controller）"></a>四、镜像服务（glance，在controller）</h1><h2 id="4-1创建数据库"><a href="#4-1创建数据库" class="headerlink" title="4.1创建数据库"></a>4.1创建数据库</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -popenstack -e "CREATE DATABASE glance;"</span><br><span class="line">mysql -uroot -popenstack -e "GRANT ALL PRIVILEGES ON glance.* TO 'glance'@'controller' \</span><br><span class="line">  IDENTIFIED BY 'openstack';"</span><br><span class="line">mysql -uroot -popenstack -e "GRANT ALL PRIVILEGES ON glance.* TO 'glance'@'%' \</span><br><span class="line">  IDENTIFIED BY 'openstack';"</span><br></pre></td></tr></table></figure><h2 id="4-2获取admin权限"><a href="#4-2获取admin权限" class="headerlink" title="4.2获取admin权限"></a>4.2获取admin权限</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source ~/admin.rc</span><br></pre></td></tr></table></figure><h2 id="4-3创建服务和api"><a href="#4-3创建服务和api" class="headerlink" title="4.3创建服务和api"></a>4.3创建服务和api</h2><h3 id="4-3-1创建glance用户"><a href="#4-3-1创建glance用户" class="headerlink" title="4.3.1创建glance用户"></a>4.3.1创建glance用户</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack user create --domain default --password=glance glance</span><br></pre></td></tr></table></figure><h3 id="4-3-2添加admin角色到glance用户和service项目上"><a href="#4-3-2添加admin角色到glance用户和service项目上" class="headerlink" title="4.3.2添加admin角色到glance用户和service项目上"></a>4.3.2添加admin角色到glance用户和service项目上</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack role add --project service --user glance admin</span><br></pre></td></tr></table></figure><h3 id="4-3-3创建glance服务"><a href="#4-3-3创建glance服务" class="headerlink" title="4.3.3创建glance服务"></a>4.3.3创建glance服务</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack service create --name glance --description "OpenStack Image" image</span><br></pre></td></tr></table></figure><h3 id="4-3-4创建galnce的api"><a href="#4-3-4创建galnce的api" class="headerlink" title="4.3.4创建galnce的api"></a>4.3.4创建galnce的api</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">openstack endpoint create --region RegionOne image public http://controller:9292</span><br><span class="line">openstack endpoint create --region RegionOne image internal http://controller:9292</span><br><span class="line">openstack endpoint create --region RegionOne image admin http://controller:9292</span><br></pre></td></tr></table></figure><h2 id="4-4安装配置glance"><a href="#4-4安装配置glance" class="headerlink" title="4.4安装配置glance"></a>4.4安装配置glance</h2><h3 id="4-4-1安装glance"><a href="#4-4-1安装glance" class="headerlink" title="4.4.1安装glance"></a>4.4.1安装glance</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y openstack-glance</span><br></pre></td></tr></table></figure><h3 id="4-4-2配置glance-api的数据库连接"><a href="#4-4-2配置glance-api的数据库连接" class="headerlink" title="4.4.2配置glance-api的数据库连接"></a>4.4.2配置glance-api的数据库连接</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">openstack-config --set /etc/glance/glance-api.conf database \</span><br><span class="line">connection mysql+pymysql://glance:openstack@controller/glance</span><br></pre></td></tr></table></figure><h3 id="4-4-3配置glance-api的认证"><a href="#4-4-3配置glance-api的认证" class="headerlink" title="4.4.3配置glance-api的认证"></a>4.4.3配置glance-api的认证</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">openstack-config --set /etc/glance/glance-api.conf keystone_authtoken auth_uri http://controller:5000</span><br><span class="line">openstack-config --set /etc/glance/glance-api.conf keystone_authtoken auth_url http://controller:35357</span><br><span class="line">openstack-config --set /etc/glance/glance-api.conf keystone_authtoken memcached_servers controller:11211</span><br><span class="line">openstack-config --set /etc/glance/glance-api.conf keystone_authtoken auth_type password</span><br><span class="line">openstack-config --set /etc/glance/glance-api.conf keystone_authtoken project_domain_name default</span><br><span class="line">openstack-config --set /etc/glance/glance-api.conf keystone_authtoken user_domain_name default</span><br><span class="line">openstack-config --set /etc/glance/glance-api.conf keystone_authtoken project_name service</span><br><span class="line">openstack-config --set /etc/glance/glance-api.conf keystone_authtoken username glance</span><br><span class="line">openstack-config --set /etc/glance/glance-api.conf keystone_authtoken password glance</span><br><span class="line">openstack-config --set /etc/glance/glance-api.conf paste_deploy flavor keystone</span><br></pre></td></tr></table></figure><h3 id="4-4-4配置镜像存储位置"><a href="#4-4-4配置镜像存储位置" class="headerlink" title="4.4.4配置镜像存储位置"></a>4.4.4配置镜像存储位置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">openstack-config --set /etc/glance/glance-api.conf glance_store stores file,http</span><br><span class="line">openstack-config --set /etc/glance/glance-api.conf glance_store default_store file</span><br><span class="line">openstack-config --set /etc/glance/glance-api.conf glance_store filesystem_store_datadir /var/lib/glance/images/</span><br></pre></td></tr></table></figure><h3 id="4-4-5配置glance-registry的数据库连接"><a href="#4-4-5配置glance-registry的数据库连接" class="headerlink" title="4.4.5配置glance-registry的数据库连接"></a>4.4.5配置glance-registry的数据库连接</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack-config --set /etc/glance/glance-registry.conf database connection mysql+pymysql://glance:openstack@controller/glance</span><br></pre></td></tr></table></figure><h3 id="4-4-6配置glance-registry的认证"><a href="#4-4-6配置glance-registry的认证" class="headerlink" title="4.4.6配置glance-registry的认证"></a>4.4.6配置glance-registry的认证</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">openstack-config --set /etc/glance/glance-registry.conf keystone_authtoken auth_uri http://controller:5000</span><br><span class="line">openstack-config --set /etc/glance/glance-registry.conf keystone_authtoken auth_url http://controller:35357</span><br><span class="line">openstack-config --set /etc/glance/glance-registry.conf keystone_authtoken memcached_servers controller:11211</span><br><span class="line">openstack-config --set /etc/glance/glance-registry.conf keystone_authtoken auth_type password</span><br><span class="line">openstack-config --set /etc/glance/glance-registry.conf keystone_authtoken project_domain_name default</span><br><span class="line">openstack-config --set /etc/glance/glance-registry.conf keystone_authtoken user_domain_name default</span><br><span class="line">openstack-config --set /etc/glance/glance-registry.conf keystone_authtoken project_name service</span><br><span class="line">openstack-config --set /etc/glance/glance-registry.conf keystone_authtoken username glance</span><br><span class="line">openstack-config --set /etc/glance/glance-registry.conf keystone_authtoken password glance</span><br><span class="line">openstack-config --set /etc/glance/glance-registry.conf paste_deploy flavor keystone</span><br></pre></td></tr></table></figure><h2 id="4-5同步数据库"><a href="#4-5同步数据库" class="headerlink" title="4.5同步数据库"></a>4.5同步数据库</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">su -s /bin/sh -c "glance-manage db_sync" glance</span><br></pre></td></tr></table></figure><h2 id="4-6启动glance"><a href="#4-6启动glance" class="headerlink" title="4.6启动glance"></a>4.6启动glance</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable openstack-glance-api.service \</span><br><span class="line">  openstack-glance-registry.service</span><br><span class="line">systemctl start openstack-glance-api.service \</span><br><span class="line">  openstack-glance-registry.service</span><br></pre></td></tr></table></figure><h2 id="4-7验证操作"><a href="#4-7验证操作" class="headerlink" title="4.7验证操作"></a>4.7验证操作</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">openstack image create "cirros" \</span><br><span class="line">  --file cirros-0.3.4-x86_64-disk.img \</span><br><span class="line">  --disk-format qcow2 --container-format bare \</span><br><span class="line">  --public</span><br><span class="line"><span class="meta"> #</span><span class="bash">查看上传镜像</span></span><br><span class="line"> root@controller ~ 08:20:16 # openstack image list</span><br><span class="line">+--------------------------------------+--------+--------+</span><br><span class="line">| ID                                   | Name   | Status |</span><br><span class="line">+--------------------------------------+--------+--------+</span><br><span class="line">| 293a2b7f-7338-4900-90b7-2c1d6df56021 | cirros | active |</span><br><span class="line">+--------------------------------------+--------+--------+</span><br></pre></td></tr></table></figure><p><br></p><h1 id="五、安装compute（计算服务）"><a href="#五、安装compute（计算服务）" class="headerlink" title="五、安装compute（计算服务）"></a>五、安装compute（计算服务）</h1><h2 id="5-1安装配置控制节点（controller）"><a href="#5-1安装配置控制节点（controller）" class="headerlink" title="5.1安装配置控制节点（controller）"></a>5.1安装配置控制节点（controller）</h2><h3 id="5-1-1创建数据库"><a href="#5-1-1创建数据库" class="headerlink" title="5.1.1创建数据库"></a>5.1.1创建数据库</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -popenstack -e "CREATE DATABASE nova_api;"</span><br><span class="line">mysql -uroot -popenstack -e "CREATE DATABASE nova;"</span><br><span class="line">mysql -uroot -popenstack -e "GRANT ALL PRIVILEGES ON nova_api.* TO 'nova'@'controller' IDENTIFIED BY 'openstack';"</span><br><span class="line">mysql -uroot -popenstack -e "GRANT ALL PRIVILEGES ON nova_api.* TO 'nova'@'%' IDENTIFIED BY 'openstack';"</span><br><span class="line">mysql -uroot -popenstack -e "GRANT ALL PRIVILEGES ON nova.* TO 'nova'@'controller' IDENTIFIED BY 'openstack';"</span><br><span class="line">mysql -uroot -popenstack -e "GRANT ALL PRIVILEGES ON nova.* TO 'nova'@'%' IDENTIFIED BY 'openstack';"</span><br></pre></td></tr></table></figure><h3 id="5-1-2创建nova用户"><a href="#5-1-2创建nova用户" class="headerlink" title="5.1.2创建nova用户"></a>5.1.2创建nova用户</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack user create --domain default --password=nova nova</span><br></pre></td></tr></table></figure><h3 id="5-1-3给nova用户添加admn角色"><a href="#5-1-3给nova用户添加admn角色" class="headerlink" title="5.1.3给nova用户添加admn角色"></a>5.1.3给nova用户添加admn角色</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack role add --project service --user nova admin</span><br></pre></td></tr></table></figure><h3 id="5-1-4创建nova服务"><a href="#5-1-4创建nova服务" class="headerlink" title="5.1.4创建nova服务"></a>5.1.4创建nova服务</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack service create --name nova --description "OpenStack Compute" compute</span><br></pre></td></tr></table></figure><h3 id="5-1-5创建nova的api"><a href="#5-1-5创建nova的api" class="headerlink" title="5.1.5创建nova的api"></a>5.1.5创建nova的api</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">openstack endpoint create --region RegionOne compute public http://controller:8774/v2.1/%\(tenant_id\)s</span><br><span class="line">openstack endpoint create --region RegionOne compute internal http://controller:8774/v2.1/%\(tenant_id\)s</span><br><span class="line">openstack endpoint create --region RegionOne compute admin http://controller:8774/v2.1/%\(tenant_id\)s</span><br></pre></td></tr></table></figure><h3 id="5-1-6安装nova"><a href="#5-1-6安装nova" class="headerlink" title="5.1.6安装nova"></a>5.1.6安装nova</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install -y openstack-nova-api openstack-nova-conductor \</span><br><span class="line">  openstack-nova-console openstack-nova-novncproxy \</span><br><span class="line">  openstack-nova-scheduler</span><br></pre></td></tr></table></figure><h3 id="5-1-7配置nova的default"><a href="#5-1-7配置nova的default" class="headerlink" title="5.1.7配置nova的default"></a>5.1.7配置nova的default</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack-config --set /etc/nova/nova.conf DEFAULT enabled_apis osapi_compute,metadata</span><br></pre></td></tr></table></figure><h3 id="5-1-8配合nova数据库连接"><a href="#5-1-8配合nova数据库连接" class="headerlink" title="5.1.8配合nova数据库连接"></a>5.1.8配合nova数据库连接</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">openstack-config --set /etc/nova/nova.conf \</span><br><span class="line">api_database connection mysql+pymysql://nova:openstack@controller/nova_api</span><br><span class="line">openstack-config --set /etc/nova/nova.conf \</span><br><span class="line">database connection mysql+pymysql://nova:openstack@controller/nova</span><br></pre></td></tr></table></figure><h3 id="5-1-9配置rabbitmq"><a href="#5-1-9配置rabbitmq" class="headerlink" title="5.1.9配置rabbitmq"></a>5.1.9配置rabbitmq</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">openstack-config --set /etc/nova/nova.conf DEFAULT rpc_backend rabbit</span><br><span class="line">openstack-config --set /etc/nova/nova.conf oslo_messaging_rabbit rabbit_host controller</span><br><span class="line">openstack-config --set /etc/nova/nova.conf oslo_messaging_rabbit rabbit_userid openstack</span><br><span class="line">openstack-config --set /etc/nova/nova.conf oslo_messaging_rabbit rabbit_password openstack</span><br></pre></td></tr></table></figure><h3 id="5-1-10配置keystone认证"><a href="#5-1-10配置keystone认证" class="headerlink" title="5.1.10配置keystone认证"></a>5.1.10配置keystone认证</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">openstack-config --set /etc/nova/nova.conf DEFAULT auth_strategy keystone</span><br><span class="line">openstack-config --set /etc/nova/nova.conf keystone_authtoken auth_uri http://controller:5000</span><br><span class="line">openstack-config --set /etc/nova/nova.conf keystone_authtoken auth_url http://controller:35357</span><br><span class="line">openstack-config --set /etc/nova/nova.conf keystone_authtoken memcached_servers controller:11211</span><br><span class="line">openstack-config --set /etc/nova/nova.conf keystone_authtoken auth_type password</span><br><span class="line">openstack-config --set /etc/nova/nova.conf keystone_authtoken project_domain_name default</span><br><span class="line">openstack-config --set /etc/nova/nova.conf keystone_authtoken user_domain_name default</span><br><span class="line">openstack-config --set /etc/nova/nova.conf keystone_authtoken project_name service</span><br><span class="line">openstack-config --set /etc/nova/nova.conf keystone_authtoken username nova</span><br><span class="line">openstack-config --set /etc/nova/nova.conf keystone_authtoken password nova</span><br></pre></td></tr></table></figure><h3 id="5-1-11配置ip和网络"><a href="#5-1-11配置ip和网络" class="headerlink" title="5.1.11配置ip和网络"></a>5.1.11配置ip和网络</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">openstack-config --set /etc/nova/nova.conf DEFAULT my_ip 10.0.10.10</span><br><span class="line">openstack-config --set /etc/nova/nova.conf DEFAULT use_neutron True</span><br><span class="line">openstack-config --set /etc/nova/nova.conf DEFAULT firewall_driver nova.virt.firewall.NoopFirewallDriver</span><br></pre></td></tr></table></figure><h3 id="5-1-12配置vnc和glance"><a href="#5-1-12配置vnc和glance" class="headerlink" title="5.1.12配置vnc和glance"></a>5.1.12配置vnc和glance</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">openstack-config --set /etc/nova/nova.conf vnc vncserver_listen 10.0.10.10</span><br><span class="line">openstack-config --set /etc/nova/nova.conf vnc vncserver_proxyclient_address 10.0.10.10</span><br><span class="line">openstack-config --set /etc/nova/nova.conf glance api_servers http://controller:9292</span><br></pre></td></tr></table></figure><h3 id="5-1-13配置锁路径"><a href="#5-1-13配置锁路径" class="headerlink" title="5.1.13配置锁路径"></a>5.1.13配置锁路径</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack-config --set /etc/nova/nova.conf oslo_concurrency lock_path /var/lib/nova/tmp</span><br></pre></td></tr></table></figure><h3 id="5-1-14同步数据库"><a href="#5-1-14同步数据库" class="headerlink" title="5.1.14同步数据库"></a>5.1.14同步数据库</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">su -s /bin/sh -c "nova-manage api_db sync" nova</span><br><span class="line">su -s /bin/sh -c "nova-manage db sync" nova</span><br></pre></td></tr></table></figure><h3 id="5-1-15启动controller上的nova"><a href="#5-1-15启动controller上的nova" class="headerlink" title="5.1.15启动controller上的nova"></a>5.1.15启动controller上的nova</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable openstack-nova-api.service \</span><br><span class="line">  openstack-nova-consoleauth.service openstack-nova-scheduler.service \</span><br><span class="line">  openstack-nova-conductor.service openstack-nova-novncproxy.service</span><br><span class="line">systemctl start openstack-nova-api.service \</span><br><span class="line">  openstack-nova-consoleauth.service openstack-nova-scheduler.service \</span><br><span class="line">  openstack-nova-conductor.service openstack-nova-novncproxy.service</span><br></pre></td></tr></table></figure><h3 id="5-1-16验证"><a href="#5-1-16验证" class="headerlink" title="5.1.16验证"></a>5.1.16验证</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@controller ~ 10:20:52 # openstack compute service list</span><br><span class="line">+----+------------------+------------+----------+---------+-------+----------------------------+</span><br><span class="line">| Id | Binary           | Host       | Zone     | Status  | State | Updated At                 |</span><br><span class="line">+----+------------------+------------+----------+---------+-------+----------------------------+</span><br><span class="line">|  1 | nova-conductor   | controller | internal | enabled | up    | 2017-03-09T02:21:25.000000 |</span><br><span class="line">|  2 | nova-consoleauth | controller | internal | enabled | up    | 2017-03-09T02:21:25.000000 |</span><br><span class="line">|  3 | nova-scheduler   | controller | internal | enabled | up    | 2017-03-09T02:21:25.000000 |</span><br><span class="line">+----+------------------+------------+----------+---------+-------+----------------------------+</span><br><span class="line">root@controller ~ 10:21:31 #</span><br></pre></td></tr></table></figure><h2 id="5-2计算节点安装（compute）"><a href="#5-2计算节点安装（compute）" class="headerlink" title="5.2计算节点安装（compute）"></a>5.2计算节点安装（compute）</h2><h3 id="5-2-1-安装nova-compute"><a href="#5-2-1-安装nova-compute" class="headerlink" title="5.2.1 安装nova-compute"></a>5.2.1 安装nova-compute</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y openstack-nova-compute</span><br></pre></td></tr></table></figure><h3 id="5-2-2配置rabbitmq链接"><a href="#5-2-2配置rabbitmq链接" class="headerlink" title="5.2.2配置rabbitmq链接"></a>5.2.2配置rabbitmq链接</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">openstack-config --set /etc/nova/nova.conf DEFAULT rpc_backend rabbit</span><br><span class="line">openstack-config --set /etc/nova/nova.conf oslo_messaging_rabbit rabbit_host controller</span><br><span class="line">openstack-config --set /etc/nova/nova.conf oslo_messaging_rabbit rabbit_userid openstack</span><br><span class="line">openstack-config --set /etc/nova/nova.conf oslo_messaging_rabbit rabbit_password openstack</span><br></pre></td></tr></table></figure><h3 id="5-2-3配置keystone认证"><a href="#5-2-3配置keystone认证" class="headerlink" title="5.2.3配置keystone认证"></a>5.2.3配置keystone认证</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">openstack-config --set /etc/nova/nova.conf DEFAULT auth_strategy keystone</span><br><span class="line">openstack-config --set /etc/nova/nova.conf keystone_authtoken auth_uri http://controller:5000</span><br><span class="line">openstack-config --set /etc/nova/nova.conf keystone_authtoken auth_url http://controller:35357</span><br><span class="line">openstack-config --set /etc/nova/nova.conf keystone_authtoken memcached_servers controller:11211</span><br><span class="line">openstack-config --set /etc/nova/nova.conf keystone_authtoken auth_type password</span><br><span class="line">openstack-config --set /etc/nova/nova.conf keystone_authtoken project_domain_name default</span><br><span class="line">openstack-config --set /etc/nova/nova.conf keystone_authtoken user_domain_name default</span><br><span class="line">openstack-config --set /etc/nova/nova.conf keystone_authtoken project_name service</span><br><span class="line">openstack-config --set /etc/nova/nova.conf keystone_authtoken username nova</span><br><span class="line">openstack-config --set /etc/nova/nova.conf keystone_authtoken password nova</span><br></pre></td></tr></table></figure><h3 id="5-2-4配置IP和网络"><a href="#5-2-4配置IP和网络" class="headerlink" title="5.2.4配置IP和网络"></a>5.2.4配置IP和网络</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">openstack-config --set /etc/nova/nova.conf DEFAULT my_ip 10.0.10.20</span><br><span class="line">openstack-config --set /etc/nova/nova.conf DEFAULT use_neutron True</span><br><span class="line">openstack-config --set /etc/nova/nova.conf DEFAULT firewall_driver nova.virt.firewall.NoopFirewallDriver</span><br></pre></td></tr></table></figure><h3 id="5-2-5配置vnc"><a href="#5-2-5配置vnc" class="headerlink" title="5.2.5配置vnc"></a>5.2.5配置vnc</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">openstack-config --set /etc/nova/nova.conf vnc enabled True</span><br><span class="line">openstack-config --set /etc/nova/nova.conf vnc vncserver_listen 0.0.0.0</span><br><span class="line">openstack-config --set /etc/nova/nova.conf vnc vncserver_proxyclient_address 10.0.10.20</span><br><span class="line">openstack-config --set /etc/nova/nova.conf vnc novncproxy_base_url http://controller:6080/vnc_auto.html</span><br></pre></td></tr></table></figure><h3 id="5-2-6配置glance"><a href="#5-2-6配置glance" class="headerlink" title="5.2.6配置glance"></a>5.2.6配置glance</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack-config --set /etc/nova/nova.conf glance api_servers http://controller:9292</span><br></pre></td></tr></table></figure><h3 id="5-2-7配置所路径"><a href="#5-2-7配置所路径" class="headerlink" title="5.2.7配置所路径"></a>5.2.7配置所路径</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack-config --set /etc/nova/nova.conf oslo_concurrency lock_path /var/lib/nova/tmp</span><br></pre></td></tr></table></figure><h3 id="5-2-8配置硬件加速"><a href="#5-2-8配置硬件加速" class="headerlink" title="5.2.8配置硬件加速"></a>5.2.8配置硬件加速</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">egrep -c '(vmx|svm)' /proc/cpuinfo</span><br><span class="line"><span class="meta">#</span><span class="bash">如果返回0则执行下面命令非0不做任何操作</span></span><br><span class="line">openstack-config --set /etc/nova/nova.conf libvirt virt_type qemu</span><br></pre></td></tr></table></figure><h3 id="5-2-9启动nova-compute"><a href="#5-2-9启动nova-compute" class="headerlink" title="5.2.9启动nova-compute"></a>5.2.9启动nova-compute</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable libvirtd.service openstack-nova-compute.service</span><br><span class="line">systemctl start libvirtd.service openstack-nova-compute.service</span><br></pre></td></tr></table></figure><h3 id="5-2-10验证安装"><a href="#5-2-10验证安装" class="headerlink" title="5.2.10验证安装"></a>5.2.10验证安装</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">在controller节点执行</span></span><br><span class="line">root@controller ~ 11:10:24 # openstack compute service list      </span><br><span class="line">+----+------------------+------------+----------+---------+-------+----------------------------+</span><br><span class="line">| Id | Binary           | Host       | Zone     | Status  | State | Updated At                 |</span><br><span class="line">+----+------------------+------------+----------+---------+-------+----------------------------+</span><br><span class="line">|  1 | nova-conductor   | controller | internal | enabled | up    | 2017-03-09T03:10:46.000000 |</span><br><span class="line">|  2 | nova-consoleauth | controller | internal | enabled | up    | 2017-03-09T03:10:46.000000 |</span><br><span class="line">|  3 | nova-scheduler   | controller | internal | enabled | up    | 2017-03-09T03:10:55.000000 |</span><br><span class="line">|  6 | nova-compute     | compute    | nova     | enabled | up    | 2017-03-09T03:10:55.000000 |</span><br><span class="line">+----+------------------+------------+----------+---------+-------+----------------------------+</span><br><span class="line">root@controller ~ 11:10:55 #</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      descriptions
    
    </summary>
    
      <category term="云计算" scheme="http://www.duoyichen.xyz/categories/%E4%BA%91%E8%AE%A1%E7%AE%97/"/>
    
    
      <category term="python" scheme="http://www.duoyichen.xyz/tags/python/"/>
    
      <category term="openstack" scheme="http://www.duoyichen.xyz/tags/openstack/"/>
    
      <category term="云计算" scheme="http://www.duoyichen.xyz/tags/%E4%BA%91%E8%AE%A1%E7%AE%97/"/>
    
  </entry>
  
  <entry>
    <title>OpenStack Mitaka + CentOS7.2 安装部署 02</title>
    <link href="http://www.duoyichen.xyz/2018-10/openstack-m-centos-2/"/>
    <id>http://www.duoyichen.xyz/2018-10/openstack-m-centos-2/</id>
    <published>2018-10-01T20:36:14.000Z</published>
    <updated>2018-10-01T23:22:13.728Z</updated>
    
    <content type="html"><![CDATA[<p><br></p><h1 id="三、安装keystone（认证服务，在controller）"><a href="#三、安装keystone（认证服务，在controller）" class="headerlink" title="三、安装keystone（认证服务，在controller）"></a>三、安装keystone（认证服务，在controller）</h1><h2 id="3-1为keystone创建mysql数据库和表"><a href="#3-1为keystone创建mysql数据库和表" class="headerlink" title="3.1为keystone创建mysql数据库和表"></a>3.1为keystone创建mysql数据库和表</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -popenstack -e "CREATE DATABASE keystone;"</span><br><span class="line">mysql -uroot -popenstack -e "GRANT ALL PRIVILEGES ON keystone.* TO 'keystone'@'controller' IDENTIFIED BY 'openstack';"</span><br><span class="line">mysql -uroot -popenstack -e "GRANT ALL PRIVILEGES ON keystone.* TO 'keystone'@'%' IDENTIFIED BY 'openstack';"</span><br></pre></td></tr></table></figure><h2 id="3-2生成随机令牌"><a href="#3-2生成随机令牌" class="headerlink" title="3.2生成随机令牌"></a>3.2生成随机令牌</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ADMIN_TOKEN=$(openssl rand -hex 10)</span><br></pre></td></tr></table></figure><h2 id="3-3安装keystone和相关组件"><a href="#3-3安装keystone和相关组件" class="headerlink" title="3.3安装keystone和相关组件"></a>3.3安装keystone和相关组件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y openstack-keystone httpd mod_wsgi</span><br></pre></td></tr></table></figure><h2 id="3-4配置token"><a href="#3-4配置token" class="headerlink" title="3.4配置token"></a>3.4配置token</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">openstack-config --set /etc/keystone/keystone.conf DEFAULT admin_token $ADMIN_TOKEN</span><br><span class="line">openstack-config --set /etc/keystone/keystone.conf token provider fernet</span><br></pre></td></tr></table></figure><h2 id="3-5配置mysql链接"><a href="#3-5配置mysql链接" class="headerlink" title="3.5配置mysql链接"></a>3.5配置mysql链接</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack-config --set /etc/keystone/keystone.conf database connection mysql+pymysql://keystone:openstack@controller/keystone</span><br></pre></td></tr></table></figure><h2 id="3-6初始化数据库"><a href="#3-6初始化数据库" class="headerlink" title="3.6初始化数据库"></a>3.6初始化数据库</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">su -s /bin/sh -c "keystone-manage db_sync" keystone</span><br></pre></td></tr></table></figure><h2 id="3-7初始化fernet-keys"><a href="#3-7初始化fernet-keys" class="headerlink" title="3.7初始化fernet keys"></a>3.7初始化fernet keys</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keystone-manage fernet_setup --keystone-user keystone --keystone-group keystone</span><br></pre></td></tr></table></figure><h2 id="3-8配置apache"><a href="#3-8配置apache" class="headerlink" title="3.8配置apache"></a>3.8配置apache</h2><h3 id="3-8-1配置servername"><a href="#3-8-1配置servername" class="headerlink" title="3.8.1配置servername"></a>3.8.1配置servername</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i &quot;s@#ServerName www.example.com:80@ServerName controller@g&quot; /etc/httpd/conf/httpd.conf</span><br></pre></td></tr></table></figure><h3 id="3-8-2配置keystone配置文件"><a href="#3-8-2配置keystone配置文件" class="headerlink" title="3.8.2配置keystone配置文件"></a>3.8.2配置keystone配置文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">cat&gt;</span><span class="bash">&gt;/etc/httpd/conf.d/wsgi-keystone.conf&lt;&lt;EOF</span></span><br><span class="line">Listen 5000</span><br><span class="line">Listen 35357</span><br><span class="line"></span><br><span class="line">&lt;VirtualHost *:5000&gt;</span><br><span class="line">    WSGIDaemonProcess keystone-public processes=5 threads=1 user=keystone group=keystone display-name=%&#123;GROUP&#125;</span><br><span class="line">    WSGIProcessGroup keystone-public</span><br><span class="line">    WSGIScriptAlias / /usr/bin/keystone-wsgi-public</span><br><span class="line">    WSGIApplicationGroup %&#123;GLOBAL&#125;</span><br><span class="line">    WSGIPassAuthorization On</span><br><span class="line">    ErrorLogFormat "%&#123;cu&#125;t %M"</span><br><span class="line">    ErrorLog /var/log/httpd/keystone-error.log</span><br><span class="line">    CustomLog /var/log/httpd/keystone-access.log combined</span><br><span class="line"></span><br><span class="line">    &lt;Directory /usr/bin&gt;</span><br><span class="line">        Require all granted</span><br><span class="line">    &lt;/Directory&gt;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">&lt;VirtualHost *:35357&gt;</span><br><span class="line">    WSGIDaemonProcess keystone-admin processes=5 threads=1 user=keystone group=keystone display-name=%&#123;GROUP&#125;</span><br><span class="line">    WSGIProcessGroup keystone-admin</span><br><span class="line">    WSGIScriptAlias / /usr/bin/keystone-wsgi-admin</span><br><span class="line">    WSGIApplicationGroup %&#123;GLOBAL&#125;</span><br><span class="line">    WSGIPassAuthorization On</span><br><span class="line">    ErrorLogFormat "%&#123;cu&#125;t %M"</span><br><span class="line">    ErrorLog /var/log/httpd/keystone-error.log</span><br><span class="line">    CustomLog /var/log/httpd/keystone-access.log combined</span><br><span class="line"></span><br><span class="line">    &lt;Directory /usr/bin&gt;</span><br><span class="line">        Require all granted</span><br><span class="line">    &lt;/Directory&gt;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="3-8-3启动aapche"><a href="#3-8-3启动aapche" class="headerlink" title="3.8.3启动aapche"></a>3.8.3启动aapche</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable httpd.service</span><br><span class="line">systemctl start httpd.service</span><br></pre></td></tr></table></figure><h2 id="3-9创建keyston服务和节点"><a href="#3-9创建keyston服务和节点" class="headerlink" title="3.9创建keyston服务和节点"></a>3.9创建keyston服务和节点</h2><h3 id="3-9-1配置token环境变量"><a href="#3-9-1配置token环境变量" class="headerlink" title="3.9.1配置token环境变量"></a>3.9.1配置token环境变量</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export OS_TOKEN=`echo $ADMIN_TOKEN`</span><br><span class="line">export OS_URL=http://controller:35357/v3</span><br><span class="line">export OS_IDENTITY_API_VERSION=3</span><br></pre></td></tr></table></figure><h3 id="3-9-2创建keystone服务"><a href="#3-9-2创建keystone服务" class="headerlink" title="3.9.2创建keystone服务"></a>3.9.2创建keystone服务</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack service create --name keystone --description "OpenStack Identity" identity</span><br></pre></td></tr></table></figure><h3 id="3-9-3创建api"><a href="#3-9-3创建api" class="headerlink" title="3.9.3创建api"></a>3.9.3创建api</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">openstack endpoint create --region RegionOne identity public http://controller:5000/v3</span><br><span class="line">openstack endpoint create --region RegionOne identity internal http://controller:5000/v3</span><br><span class="line">openstack endpoint create --region RegionOne identity admin http://controller:35357/v3</span><br></pre></td></tr></table></figure><h2 id="3-10创建域、用户和角色"><a href="#3-10创建域、用户和角色" class="headerlink" title="3.10创建域、用户和角色"></a>3.10创建域、用户和角色</h2><h3 id="3-10-1创建默认域"><a href="#3-10-1创建默认域" class="headerlink" title="3.10.1创建默认域"></a>3.10.1创建默认域</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack domain create --description "Default Domain" default</span><br></pre></td></tr></table></figure><h3 id="3-10-2创建admin项目"><a href="#3-10-2创建admin项目" class="headerlink" title="3.10.2创建admin项目"></a>3.10.2创建admin项目</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack project create --domain default --description "Admin Project" admin</span><br></pre></td></tr></table></figure><h3 id="3-10-3创建admin用户"><a href="#3-10-3创建admin用户" class="headerlink" title="3.10.3创建admin用户"></a>3.10.3创建admin用户</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack user create --domain default --password=admin admin</span><br></pre></td></tr></table></figure><h3 id="3-10-4创建admin角色"><a href="#3-10-4创建admin角色" class="headerlink" title="3.10.4创建admin角色"></a>3.10.4创建admin角色</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack role create admin</span><br></pre></td></tr></table></figure><h3 id="3-10-5添加admin角色到admin项目和用户"><a href="#3-10-5添加admin角色到admin项目和用户" class="headerlink" title="3.10.5添加admin角色到admin项目和用户"></a>3.10.5添加admin角色到admin项目和用户</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack role add --project admin --user admin admin</span><br></pre></td></tr></table></figure><h3 id="3-10-6创建service项目"><a href="#3-10-6创建service项目" class="headerlink" title="3.10.6创建service项目"></a>3.10.6创建service项目</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack project create --domain default --description "Service Project" service</span><br></pre></td></tr></table></figure><h3 id="3-10-7创建demo项目"><a href="#3-10-7创建demo项目" class="headerlink" title="3.10.7创建demo项目"></a>3.10.7创建demo项目</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack project create --domain default --description "Demo Project" demo</span><br></pre></td></tr></table></figure><h3 id="3-10-8创建demo用户"><a href="#3-10-8创建demo用户" class="headerlink" title="3.10.8创建demo用户"></a>3.10.8创建demo用户</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack user create --domain default --password=demo demo</span><br></pre></td></tr></table></figure><h3 id="3-10-9创建user角色"><a href="#3-10-9创建user角色" class="headerlink" title="3.10.9创建user角色"></a>3.10.9创建user角色</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack role create user</span><br></pre></td></tr></table></figure><h3 id="3-10-10添加user角色到demo-项目和用户"><a href="#3-10-10添加user角色到demo-项目和用户" class="headerlink" title="3.10.10添加user角色到demo 项目和用户"></a>3.10.10添加user角色到demo 项目和用户</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack role add --project demo --user demo user</span><br></pre></td></tr></table></figure><h2 id="3-11验证"><a href="#3-11验证" class="headerlink" title="3.11验证"></a>3.11验证</h2><h3 id="3-11-1清空环境变量"><a href="#3-11-1清空环境变量" class="headerlink" title="3.11.1清空环境变量"></a>3.11.1清空环境变量</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unset OS_TOKEN OS_URL</span><br></pre></td></tr></table></figure><h3 id="3-11-2验证admin用户请求"><a href="#3-11-2验证admin用户请求" class="headerlink" title="3.11.2验证admin用户请求"></a>3.11.2验证admin用户请求</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">openstack --os-auth-url http://controller:35357/v3 \</span><br><span class="line">  --os-project-domain-name default --os-user-domain-name default \</span><br><span class="line">  --os-project-name admin --os-username admin token issue</span><br></pre></td></tr></table></figure><h3 id="3-11-3验证demo用户请求"><a href="#3-11-3验证demo用户请求" class="headerlink" title="3.11.3验证demo用户请求"></a>3.11.3验证demo用户请求</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">openstack --os-auth-url http://controller:5000/v3 \</span><br><span class="line">  --os-project-domain-name default --os-user-domain-name default \</span><br><span class="line">  --os-project-name demo --os-username demo token issue</span><br></pre></td></tr></table></figure><h3 id="3-11-4生成admin用户脚本"><a href="#3-11-4生成admin用户脚本" class="headerlink" title="3.11.4生成admin用户脚本"></a>3.11.4生成admin用户脚本</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">cat&gt;</span><span class="bash">&gt;~/admin.rc&lt;&lt;EOF</span></span><br><span class="line">export OS_PROJECT_DOMAIN_NAME=default</span><br><span class="line">export OS_USER_DOMAIN_NAME=default</span><br><span class="line">export OS_PROJECT_NAME=admin</span><br><span class="line">export OS_USERNAME=admin</span><br><span class="line">export OS_PASSWORD=admin</span><br><span class="line">export OS_AUTH_URL=http://controller:35357/v3</span><br><span class="line">export OS_IDENTITY_API_VERSION=3</span><br><span class="line">export OS_IMAGE_API_VERSION=2</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="3-11-5生成demo用户脚本"><a href="#3-11-5生成demo用户脚本" class="headerlink" title="3.11.5生成demo用户脚本"></a>3.11.5生成demo用户脚本</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">cat&gt;</span><span class="bash">&gt;~/demo.rc&lt;&lt;EOF</span></span><br><span class="line">export OS_PROJECT_DOMAIN_NAME=default</span><br><span class="line">export OS_USER_DOMAIN_NAME=default</span><br><span class="line">export OS_PROJECT_NAME=demo</span><br><span class="line">export OS_USERNAME=demo</span><br><span class="line">export OS_PASSWORD=DEMO_PASS</span><br><span class="line">export OS_AUTH_URL=http://controller:5000/v3</span><br><span class="line">export OS_IDENTITY_API_VERSION=3</span><br><span class="line">export OS_IMAGE_API_VERSION=2</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      descriptions
    
    </summary>
    
      <category term="云计算" scheme="http://www.duoyichen.xyz/categories/%E4%BA%91%E8%AE%A1%E7%AE%97/"/>
    
    
      <category term="python" scheme="http://www.duoyichen.xyz/tags/python/"/>
    
      <category term="openstack" scheme="http://www.duoyichen.xyz/tags/openstack/"/>
    
      <category term="云计算" scheme="http://www.duoyichen.xyz/tags/%E4%BA%91%E8%AE%A1%E7%AE%97/"/>
    
  </entry>
  
  <entry>
    <title>OpenStack Mitaka + CentOS7.2 安装部署 01</title>
    <link href="http://www.duoyichen.xyz/2018-10/openstack-m-centos/"/>
    <id>http://www.duoyichen.xyz/2018-10/openstack-m-centos/</id>
    <published>2018-10-01T20:36:13.000Z</published>
    <updated>2018-10-01T23:22:18.426Z</updated>
    
    <content type="html"><![CDATA[<p><br></p><h1 id="一、环境约定和基础包安装"><a href="#一、环境约定和基础包安装" class="headerlink" title="一、环境约定和基础包安装"></a>一、环境约定和基础包安装</h1><h2 id="1-1环境约定"><a href="#1-1环境约定" class="headerlink" title="1.1环境约定"></a>1.1环境约定</h2><ul><li>提示：请先初步理解openstack的各组件功能，阅读此部署文档，文档中不做详细介绍。</li></ul><table><thead><tr><th>主机名</th><th style="text-align:center">管理IP</th><th style="text-align:center">私有ip</th><th>公有ip</th><th>操作系统</th></tr></thead><tbody><tr><td>controller</td><td style="text-align:center">eth0:10.0.10.10</td><td style="text-align:center">eth1:10.0.20.10</td><td>eth2:10.0.30.10</td><td>CenOS7.2-x64</td></tr><tr><td>compute</td><td style="text-align:center">eth0:10.0.10.20</td><td style="text-align:center">eth1:10.0.20.20</td><td>eth2:10.0.30.20</td><td>CenOS7.2-x64</td></tr><tr><td>cinder</td><td style="text-align:center">eth0:10.0.10.30</td><td style="text-align:center">eth1:10.0.20.30</td><td>—</td><td>CenOS7.2-x64</td></tr></tbody></table><h2 id="1-2环境配置（在所有节点执行）"><a href="#1-2环境配置（在所有节点执行）" class="headerlink" title="1.2环境配置（在所有节点执行）"></a>1.2环境配置（在所有节点执行）</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld.service</span><br><span class="line">systemctl disable firewalld.service</span><br><span class="line">yum install -y wget</span><br><span class="line">mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.back</span><br><span class="line">wget http://mirrors.aliyun.com/repo/Centos-7.repo  -P /etc/yum.repos.d/</span><br><span class="line">mv /etc/yum.repos.d/Centos-7.repo /etc/yum.repos.d/CentOS-Base.repo</span><br><span class="line">rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-2.el7.elrepo.noarch.rpm</span><br><span class="line">yum install -y epel-release </span><br><span class="line">yum install -y centos-release-openstack-mitaka</span><br><span class="line">sed -i "s@#baseurl@baseurl@g" /etc/yum.repos.d/epel.repo</span><br><span class="line">sed -i "s@mirrorlist@#mirrorlist@g"  /etc/yum.repos.d/epel.repo</span><br><span class="line">sed -i "s#http://download.fedoraproject.org/pub#https://mirrors.tuna.tsinghua.edu.cn#g" /etc/yum.repos.d/epel.repo</span><br><span class="line">sed -i "s#http://elrepo.org/linux#https://mirror.tuna.tsinghua.edu.cn/elrepo#g" /etc/yum.repos.d/elrepo.repo</span><br><span class="line">sed -i "s#mirror.centos.org#mirrors.163.com#g" /etc/yum.repos.d/CentOS-OpenStack-mitaka.repo </span><br><span class="line">yum clean all</span><br><span class="line">yum makecache</span><br><span class="line">yum install -y tree lrzsz nmap python-pip vim net-tools ntp iperf iftop screen zip unzip gcc gcc-c++ cmake</span><br><span class="line">yum install -y python-openstackclient openstack-selinux ntp openstack-utils</span><br><span class="line">systemctl start ntpd</span><br><span class="line">systemctl enable ntpd</span><br><span class="line">setenforce 0</span><br><span class="line">sed -i 's#SELINUX=enforcing#SELINUX=disable#g' /etc/selinux/config</span><br></pre></td></tr></table></figure><h2 id="1-3选择执行（可以不执行）"><a href="#1-3选择执行（可以不执行）" class="headerlink" title="1.3选择执行（可以不执行）"></a>1.3选择执行（可以不执行）</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cp /etc/vimrc /etc/vimrc.back</span><br><span class="line"><span class="meta">cat&gt;</span><span class="bash">&gt;/etc/vimrc&lt;&lt;EOF</span></span><br><span class="line">set nu</span><br><span class="line">set tabstop=2</span><br><span class="line">set fileencodings=utf-8,ucs-bom,gb18030,gbk,gb2312,cp936</span><br><span class="line">set termencoding=utf-8</span><br><span class="line">set encoding=utf-8</span><br><span class="line">EOF</span><br><span class="line">. /etc/vimrc</span><br><span class="line">echo "export LC_ALL=C" &gt;&gt; /etc/profile</span><br><span class="line">echo "unset MAILCHECK" &gt;&gt; /etc/profile</span><br><span class="line">echo "export PS1='\[\e[31;1m\]\u@\[\e[34;1m\]\h \[\e[36;1m\]\w \[\e[33;1m\]\t # \[\e[37;1m\]'" &gt;&gt; /etc/profile</span><br><span class="line">echo "export GREP_OPTIONS='--color=auto' GREP_COLOR='1;33'" &gt;&gt; /etc/profile</span><br><span class="line">echo " *  -  nofile  65536" &gt;&gt; /etc/security/limits.conf</span><br><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure><p><br></p><h1 id="二、controller-控制节点-部署"><a href="#二、controller-控制节点-部署" class="headerlink" title="二、controller(控制节点)部署"></a>二、controller(控制节点)部署</h1><h2 id="2-1安装配置mysql"><a href="#2-1安装配置mysql" class="headerlink" title="2.1安装配置mysql"></a>2.1安装配置mysql</h2><h3 id="2-1-1安装"><a href="#2-1-1安装" class="headerlink" title="2.1.1安装"></a>2.1.1安装</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y mariadb mariadb-server MySQL-python</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">cat&gt;</span><span class="bash">&gt;/etc/my.cnf&lt;&lt;EOF</span></span><br><span class="line">[client-server]</span><br><span class="line">[mysqld]</span><br><span class="line">symbolic-links=0</span><br><span class="line">bind-address = 0.0.0.0</span><br><span class="line">default-storage-engine = innodb</span><br><span class="line">innodb_file_per_table</span><br><span class="line">collation-server = utf8_general_ci</span><br><span class="line">init-connect = 'SET NAMES utf8'</span><br><span class="line">character-set-server = utf8</span><br><span class="line">max_connections=1000</span><br><span class="line">!includedir /etc/my.cnf.d</span><br><span class="line">EOF</span><br><span class="line">openstack-config --set /usr/lib/systemd/system/mariadb.service Service LimitNOFILE 10000</span><br><span class="line">openstack-config --set /usr/lib/systemd/system/mariadb.service Service LimitNPROC 10000</span><br></pre></td></tr></table></figure><h3 id="2-1-2启动mysql"><a href="#2-1-2启动mysql" class="headerlink" title="2.1.2启动mysql"></a>2.1.2启动mysql</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable mariadb.service</span><br><span class="line">systemctl start mariadb.service</span><br></pre></td></tr></table></figure><h3 id="2-1-3配置mysql密码"><a href="#2-1-3配置mysql密码" class="headerlink" title="2.1.3配置mysql密码"></a>2.1.3配置mysql密码</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqladmin -uroot password "openstack"</span><br></pre></td></tr></table></figure><h2 id="2-2安装配置mongodb"><a href="#2-2安装配置mongodb" class="headerlink" title="2.2安装配置mongodb"></a>2.2安装配置mongodb</h2><h3 id="2-2-1安装"><a href="#2-2-1安装" class="headerlink" title="2.2.1安装"></a>2.2.1安装</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y mongodb-server mongodb</span><br></pre></td></tr></table></figure><h3 id="2-2-2配置mongod（-etc-mongod-conf-）"><a href="#2-2-2配置mongod（-etc-mongod-conf-）" class="headerlink" title="2.2.2配置mongod（/etc/mongod.conf ）"></a>2.2.2配置mongod（/etc/mongod.conf ）</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sed -i "s#bind_ip = 127.0.0.1#bind_ip = 0.0.0.0#g" /etc/mongod.conf</span><br><span class="line">sed -i "s@#smallfiles = true@smallfiles = true@g" /etc/mongod.conf</span><br></pre></td></tr></table></figure><h3 id="2-2-3启动mongodb"><a href="#2-2-3启动mongodb" class="headerlink" title="2.2.3启动mongodb"></a>2.2.3启动mongodb</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable mongod.service</span><br><span class="line">systemctl start mongod.service</span><br></pre></td></tr></table></figure><h2 id="2-3安装配置rabbitmq"><a href="#2-3安装配置rabbitmq" class="headerlink" title="2.3安装配置rabbitmq"></a>2.3安装配置rabbitmq</h2><h3 id="2-3-1安装rabbitmq"><a href="#2-3-1安装rabbitmq" class="headerlink" title="2.3.1安装rabbitmq"></a>2.3.1安装rabbitmq</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y rabbitmq-server</span><br></pre></td></tr></table></figure><h3 id="启动rabbitmq"><a href="#启动rabbitmq" class="headerlink" title="启动rabbitmq"></a>启动rabbitmq</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable rabbitmq-server.service</span><br><span class="line">systemctl start rabbitmq-server.service</span><br></pre></td></tr></table></figure><h3 id="2-3-3配置rabbitmq"><a href="#2-3-3配置rabbitmq" class="headerlink" title="2.3.3配置rabbitmq"></a>2.3.3配置rabbitmq</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl add_user openstack openstack</span><br><span class="line">rabbitmqctl set_permissions openstack ".*" ".*" ".*"</span><br></pre></td></tr></table></figure><h2 id="2-4安装memcached"><a href="#2-4安装memcached" class="headerlink" title="2.4安装memcached"></a>2.4安装memcached</h2><h3 id="2-4-1安装memcached"><a href="#2-4-1安装memcached" class="headerlink" title="2.4.1安装memcached"></a>2.4.1安装memcached</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y memcached python-memcached</span><br></pre></td></tr></table></figure><h3 id="启动memcached"><a href="#启动memcached" class="headerlink" title="启动memcached"></a>启动memcached</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable memcached.service</span><br><span class="line">systemctl start memcached.service</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      descriptions
    
    </summary>
    
      <category term="云计算" scheme="http://www.duoyichen.xyz/categories/%E4%BA%91%E8%AE%A1%E7%AE%97/"/>
    
    
      <category term="python" scheme="http://www.duoyichen.xyz/tags/python/"/>
    
      <category term="openstack" scheme="http://www.duoyichen.xyz/tags/openstack/"/>
    
      <category term="云计算" scheme="http://www.duoyichen.xyz/tags/%E4%BA%91%E8%AE%A1%E7%AE%97/"/>
    
  </entry>
  
  <entry>
    <title>Lvs+Keepalived高可用负载均衡</title>
    <link href="http://www.duoyichen.xyz/2018-10/lvs-kl/"/>
    <id>http://www.duoyichen.xyz/2018-10/lvs-kl/</id>
    <published>2018-10-01T20:21:48.000Z</published>
    <updated>2018-10-02T14:13:01.068Z</updated>
    
    <content type="html"><![CDATA[<p><br></p><h2 id="一-ARP协议"><a href="#一-ARP协议" class="headerlink" title="一. ARP协议"></a>一. ARP协议</h2><h4 id="1-1-什么是arp协议"><a href="#1-1-什么是arp协议" class="headerlink" title="1.1 什么是arp协议"></a>1.1 什么是arp协议</h4><p>地址解析协议，即ARP（Address Resolution Protocol），是根据IP地址获取物理地址的一个TCP/IP协议。主机发送信息时将包含目标IP地址的ARP请求广播到网络上的所有主机，并接收返回消息，以此确定目标的物理地址；收到返回消息后将该IP地址和物理地址存入本机ARP缓存中并保留一定时间，下次请求时直接查询ARP缓存以节约资源。地址解析协议是建立在网络中各个主机互相信任的基础上的，网络上的主机可以自主发送ARP应答消息，其他主机收到应答报文时不会检测该报文的真实性就会将其记入本机ARP缓存；由此攻击者就可以向某一主机发送伪ARP应答报文，使其发送的信息无法到达预期的主机或到达错误的主机，这就构成了一个ARP欺骗。ARP命令可用于查询本机ARP缓存中IP地址和MAC地址的对应关系、添加或删除静态对应关系等。相关协议有RARP、代理ARP。NDP用于在IPv6中代替地址解析协议。</p><h4 id="1-2-arp工作原理"><a href="#1-2-arp工作原理" class="headerlink" title="1.2 arp工作原理"></a>1.2 arp工作原理</h4><ul><li>主机A的IP地址为192.168.1.1，MAC地址为0A-11-22-33-44-01；</li><li>主机B的IP地址为192.168.1.2，MAC地址为0A-11-22-33-44-02；</li><li>当主机A要与主机B通信时，地址解析协议可以将主机B的IP地址（192.168.1.2）解析成主机B的MAC地址，以下为工作流程：</li><li>第1步：根据主机A上的路由表内容，IP确定用于访问主机B的转发IP地址是192.168.1.2。然后A主机在自己的本地ARP缓存中检查主机B的匹配MAC地址。</li><li>第2步：如果主机A在ARP缓存中没有找到映射，它将询问192.168.1.2的硬件地址，从而将ARP请求帧广播到本地网络上的所有主机。源主机A的IP地址和MAC地址都包括在ARP请求中。本地网络上的每台主机都接收到ARP请求并且检查是否与自己的IP地址匹配。如果主机发现请求的IP地址与自己的IP地址不匹配，它将丢弃ARP请求。</li><li>第3步：主机B确定ARP请求中的IP地址与自己的IP地址匹配，则将主机A的IP地址和MAC地址映射添加到本地ARP缓存中。</li><li>第4步：主机B将包含其MAC地址的ARP回复消息直接发送回主机A。</li><li>第5步：当主机A收到从主机B发来的ARP回复消息时，会用主机B的IP和MAC地址映射更新ARP缓存。本机缓存是有生存期的，生存期结束后，将再次重复上面的过程。主机B的MAC地址一旦确定，主机A就能向主机B发送IP通信了</li></ul><h4 id="1-3-arp代理"><a href="#1-3-arp代理" class="headerlink" title="1.3 arp代理"></a>1.3 arp代理</h4><p>C1和PC2虽然属于不同的广播域，但它们处于同一网段中，因此PC1会向PC2发出ARP请求广播包，请求获得PC2的MAC地址。由于路由器不会转发广播包，因此ARP请求只能到达路由器，不能到达PC2。当在路由器上启用ARP代理后，路由器会查看ARP请求，发现IP地址172.16.20.100属于它连接的另一个网络，因此路由器用自己的接口MAC地址代替PC2的MAC地址，向PC1发送了一个ARP应答。</p><h2 id="二-LVS简介"><a href="#二-LVS简介" class="headerlink" title="二. LVS简介"></a>二. LVS简介</h2><h4 id="2-1-lvs概念"><a href="#2-1-lvs概念" class="headerlink" title="2.1 lvs概念"></a>2.1 lvs概念</h4><p>LVS集群采用IP负载均衡技术和基于内容请求分发技术。调度器具有很好的吞吐率，将请求均衡地转移到不同的服务器上执行，且调度器自动屏蔽掉服务器的故障，从而将一组服务器构成一个高性能的、高可用的虚拟服务器。整个服务器集群的结构对客户是透明的，而且无需修改客户端和服务器端的程序。为此，在设计时需要考虑系统的透明性、可伸缩性、高可用性和易管理性。</p><h4 id="2-2-lvs三种基本模型"><a href="#2-2-lvs三种基本模型" class="headerlink" title="2.2 lvs三种基本模型"></a>2.2 lvs三种基本模型</h4><h5 id="2-2-1-lvs-DR模型是lvs的默认模型，也是企业中用到的最多的模型"><a href="#2-2-1-lvs-DR模型是lvs的默认模型，也是企业中用到的最多的模型" class="headerlink" title="2.2.1 lvs-DR模型是lvs的默认模型，也是企业中用到的最多的模型"></a>2.2.1 lvs-DR模型是lvs的默认模型，也是企业中用到的最多的模型</h5><p><code>LVS_NAT模型，通常应用与rs较少，rs节点无要求，端口转换的场景</code></p><p><code>解读：地址转换模型，vs通过修改目的ip将报文发送到rs.rs通过dip网关将报文发给vs,vs再将报文的源ip进行修改发送给客户端</code></p><h5 id="2-2-2-LVS-TUN-模式"><a href="#2-2-2-LVS-TUN-模式" class="headerlink" title="2.2.2 LVS-TUN 模式"></a>2.2.2 LVS-TUN 模式</h5><p><code>lvs-TUN模型可以运用于异地机房的负载调度上。</code></p><p><code>解读：隧道模型，跟DR模型比较相似，都是由rs直接回复给cs .跟dr模型不同的是，vs和rs之间可以存在路由，原因是tun模型在报文源ip和目的ip后又加入了一层源ip和目的ip的信息。</code></p><h5 id="2-2-3-LVS-NAT-模式"><a href="#2-2-3-LVS-NAT-模式" class="headerlink" title="2.2.3 LVS-NAT 模式"></a>2.2.3 LVS-NAT 模式</h5><p><code>LVS_NAT模型，通常应用与rs较少，rs节点无要求，端口转换的场景</code></p><p><code>解读：地址转换模型，vs通过修改目的ip将报文发送到rs.rs通过dip网关将报文发给vs,vs再将报文的源ip进行修改发送给客户端。</code></p><h2 id="三-LVS-DR模式详解"><a href="#三-LVS-DR模式详解" class="headerlink" title="三. LVS-DR模式详解"></a>三. LVS-DR模式详解</h2><ul><li><p>场景假设：</p><ul><li>客户端：ip：192.168.1.1，mac：00：00：00：00：00：01</li><li>Lvs：vip：192.168.0.2，mac：00：00：00：00：00：02</li><li>Web服务器：ip：192.168.0.3，mac：00：00：00：00：00：03，lo网卡ip：192.168.0.2</li></ul></li><li><p>Lvs工作流程流程：</p><ul><li>客户向lvs发送一个请求后lvs收到的报文为源IP地址为：192.168.0.1，源mac为：00：00：00：00：00：01。目标IP地址为：192.168.0.2，目标mac地址为：00：00：00：00：00：02</li><li>当lvs收到请求后会根据自身算法选择一个web服务器对报文进行修改并转发给web服务器，此时转发的报文为IP地址为：192.168.0.1，源mac为：00：00：00：00：00：01，目标IP地址为：192.168.0.2，目标mac地址为：00：00：00：00：00：03</li><li>Web服务器收到lvs抓发过来的请求进行回复，此时web参看报文发现自己的lo网卡有目标地址那么进行恢复。回复的报文为源IP地址：192.168.0.2，源mac地址为：00：00：00：00：00：03，目标IP地址为：192.168.0.1，目标Imac、地址为：00：00：00：00：00：01</li></ul></li><li><p>总结：</p><ul><li>整个lvs-的dr模式客户端的计算机可以理解为arp欺骗，是客户的计算机始终认为和同一台计算机通信。</li></ul></li></ul><h2 id="四-LVS的安装"><a href="#四-LVS的安装" class="headerlink" title="四. LVS的安装"></a>四. LVS的安装</h2><h4 id="4-1-升级内核并安装内核开发包开启内核转发"><a href="#4-1-升级内核并安装内核开发包开启内核转发" class="headerlink" title="4.1 升级内核并安装内核开发包开启内核转发"></a>4.1 升级内核并安装内核开发包开启内核转发</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">yum update -y kernel</span><br><span class="line">yum install -y kernel-devel</span><br><span class="line">reboot</span><br><span class="line">ln -s /usr/src/kernels/`uname -r` /usr/src/linux</span><br><span class="line">sed -i 's#net.ipv4.ip_forward = 0#net.ipv4.ip_forward = 1#g' /etc/sysctl.conf  </span><br><span class="line">sysctl -p</span><br></pre></td></tr></table></figure><h4 id="4-2-安装lvs"><a href="#4-2-安装lvs" class="headerlink" title="4.2 安装lvs"></a>4.2 安装lvs</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">yum install popt-devel ipvsadm -y</span><br><span class="line">root@template ~ 23:58:02 # lsmod | grep ip_vs</span><br><span class="line">root@template ~ 23:58:14 # modprobe ip_vs</span><br><span class="line">root@template ~ 23:58:23 # lsmod | grep ip_vs</span><br><span class="line">ip_vs                 126897  0 </span><br><span class="line">libcrc32c               1246  1 ip_vs</span><br><span class="line">ipv6                  336282  282 ip_vs,ip6t_REJECT,nf_conntrack_ipv6,nf_defrag_ipv6</span><br></pre></td></tr></table></figure><h2 id="五-LVS应用案例"><a href="#五-LVS应用案例" class="headerlink" title="五. LVS应用案例"></a>五. LVS应用案例</h2><h4 id="5-1-配置lvs主机"><a href="#5-1-配置lvs主机" class="headerlink" title="5.1 配置lvs主机"></a>5.1 配置lvs主机</h4><p><code>ifconfig eth网卡号:编号 VIP netmask 255.255.255.0 up</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@lvs01 ~]# ifconfig eth0:12 192.168.241.11 netmask 255.255.255.0 up</span><br><span class="line">[root@lvs01 ~]# ip a </span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN </span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</span><br><span class="line">    link/ether 00:0c:29:cc:ec:94 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.241.12/24 brd 192.168.241.255 scope global eth0</span><br><span class="line">    inet 192.168.241.11/24 brd 192.168.241.255 scope global secondary eth0:12</span><br><span class="line">    inet6 fe80::20c:29ff:fecc:ec94/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure><h4 id="5-2-添加转发VIP"><a href="#5-2-添加转发VIP" class="headerlink" title="5.2 添加转发VIP"></a>5.2 添加转发VIP</h4><p><code>ipvsadm -A -t VIP:port -s wrr -p 20</code></p><p>-s 参数使用wrr轮询算法 -p会话保持20秒</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@lvs01 ~]# ipvsadm -A -t 192.168.241.11:80 -s wrr -p 20</span><br><span class="line">[root@lvs01 ~]#</span><br></pre></td></tr></table></figure><h4 id="5-3-添加后端RSV（web）"><a href="#5-3-添加后端RSV（web）" class="headerlink" title="5.3 添加后端RSV（web）"></a>5.3 添加后端RSV（web）</h4><p><code>ipvsadm -a -t VIP:port -r RIP:port -g -w 1</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@lvs01 ~]# ipvsadm -a -t 192.168.241.11:80 -r 192.168.241.15:80 -g -w 1</span><br><span class="line">[root@lvs01 ~]# ipvsadm -a -t 192.168.241.11:80 -r 192.168.241.16:80 -g -w 1</span><br><span class="line">[root@lvs01 ~]#</span><br></pre></td></tr></table></figure><h4 id="5-4-查看设置"><a href="#5-4-查看设置" class="headerlink" title="5.4 查看设置"></a>5.4 查看设置</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@lvs01 ~]# ipvsadm -L -n</span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> RemoteAddress:Port           Forward Weight ActiveConn InActConn</span></span><br><span class="line">TCP  192.168.241.11:80 wrr persistent 20</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 192.168.241.15:80            Route   1      0          0         </span></span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 192.168.241.16:80            Route   1      0          0         </span></span><br><span class="line">[root@lvs01 ~]#</span><br></pre></td></tr></table></figure><h4 id="5-5-配置后端rsv的lo网卡"><a href="#5-5-配置后端rsv的lo网卡" class="headerlink" title="5.5 配置后端rsv的lo网卡"></a>5.5 配置后端rsv的lo网卡</h4><p><code>ifconfig lo:num VIP netmask 255.255.255.255 up</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@apache ~]# ifconfig lo:0 192.168.241.11 netmask 255.255.255.255 up      </span><br><span class="line">[root@apache ~]# ip a </span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 16436 qdisc noqueue state UNKNOWN </span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">    inet 192.168.241.11/32 brd 192.168.241.11 scope global lo:0</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</span><br><span class="line">    link/ether 00:0c:29:d9:fc:b8 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.241.15/24 brd 192.168.241.255 scope global eth0</span><br><span class="line">    inet6 fe80::20c:29ff:fed9:fcb8/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure><h4 id="5-6-抑制rsv的arp"><a href="#5-6-抑制rsv的arp" class="headerlink" title="5.6 抑制rsv的arp"></a>5.6 抑制rsv的arp</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">echo "1" &gt; /proc/sys/net/ipv4/conf/all/arp_ignore</span><br><span class="line">echo "1" &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore</span><br><span class="line">echo "2" &gt; /proc/sys/net/ipv4/conf/lo/arp_announce</span><br><span class="line">echo "2" &gt; /proc/sys/net/ipv4/conf/all/arp_announce</span><br></pre></td></tr></table></figure><h4 id="5-7-用curl命令验证"><a href="#5-7-用curl命令验证" class="headerlink" title="5.7 用curl命令验证"></a>5.7 用curl命令验证</h4><p><code>curl 192.168.241.11</code></p><h2 id="六-KEEPALIVED介绍"><a href="#六-KEEPALIVED介绍" class="headerlink" title="六. KEEPALIVED介绍"></a>六. KEEPALIVED介绍</h2><ul><li>Layer3,4&amp;7工作在IP/TCP协议栈的IP层，TCP层，及应用层,原理分别如下：</li><li>Layer3：Keepalived使用Layer3的方式工作式时，Keepalived会定期向服务器群中的服务器发送一个ICMP的数据包（既我们平时用的Ping程序）,如果发现某台服务的IP地址没有激活，Keepalived便报告这台服务器失效，并将它从服务器群中剔除，这种情况的典型例子是某台服务器被非法关机。Layer3的方式是以服务器的IP地址是否有效作为服务器工作正常与否的标准。</li><li>Layer4:如果您理解了Layer3的方式，Layer4就容易了。Layer4主要以TCP端口的状态来决定服务器工作正常与否。如web server的服务端口一般是80，如果Keepalived检测到80端口没有启动，则Keepalived将把这台服务器从服务器群中剔除。</li><li>Layer7：Layer7就是工作在具体的应用层了，比Layer3,Layer4要复杂一点，在网络上占用的带宽也要大一些。Keepalived将根据用户的设定检查服务器程序的运行是否正常，如果与用户的设定不相符，则Keepalived将把服务器从服务器群中剔除。</li></ul><h2 id="七-安装KEEPALIVED"><a href="#七-安装KEEPALIVED" class="headerlink" title="七. 安装KEEPALIVED"></a>七. 安装KEEPALIVED</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">tar zxf keepalived-1.1.17.tar.gz</span><br><span class="line">cd keepalived-1.1.17</span><br><span class="line">./configure</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line">cp /usr/local/etc/rc.d/init.d/keepalived /etc/init.d  </span><br><span class="line">cp /usr/local/etc/sysconfig/keepalived /etc/sysconfig</span><br><span class="line">cp /usr/local/etc/keepalived/keepalived.conf /etc/keepalived  </span><br><span class="line">cp /usr/local/sbin/keepalive /usr/sbin</span><br><span class="line">chkconfig --add keepalived</span><br><span class="line"><span class="meta">#</span><span class="bash">注：使用lvs+keepalived高可用请在安装keepalived之前安装lvs软件，参见第四章</span></span><br></pre></td></tr></table></figure><h2 id="八-KEEPALIVED配置"><a href="#八-KEEPALIVED配置" class="headerlink" title="八. KEEPALIVED配置"></a>八. KEEPALIVED配置</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">global_defs &#123;</span><br><span class="line">notification_email &#123;</span><br><span class="line">znyang@vip.qq.com</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  notification_email_from Alexandre.Cassen@firewall.loc</span><br><span class="line">smtp_server 127.0.0.1</span><br><span class="line">smtp_connect_timeout 30</span><br><span class="line">router_id LVS_1  #这行是keepalived服务器ID在同一个局域网内一定不能重复</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script nginx_check &#123;   #配置监控脚本</span><br><span class="line">  script &quot;/root/nginx_check.sh&quot;   #监控脚本</span><br><span class="line">  interval 1    ###检测时间间隔 1s###</span><br><span class="line">  weigh -60   ###如果条件成立（脚本返回非0），权重-60###</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">state MASTER  #MASTER 是主 BACKUP是从</span><br><span class="line">interface eth0  #网络接口（需要绑定VIP的网卡）</span><br><span class="line">virtual_router_id 51  #配置实例的表示，在同一个配置文件中每个实例的标识是唯一的，被节点的要和主节点的一致</span><br><span class="line">priority 100  #优先级数值越大优先级越高一般同一个实例中主比从大100</span><br><span class="line"> advert_int 1  #同步检查的时间间隔</span><br><span class="line"></span><br><span class="line">  track_script &#123;</span><br><span class="line">        nginx_check  #使用监控脚本</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> authentication &#123;</span><br><span class="line">   auth_type PASS  #权限类型是密码</span><br><span class="line">   auth_pass 1111  #密码</span><br><span class="line"> &#125;</span><br><span class="line">  </span><br><span class="line"> virtual_ipaddress &#123;</span><br><span class="line"> 192.168.18.200</span><br><span class="line">    #虚拟路由器的地址（ ifconfig eth网卡号:编号 VIP netmask 255.255.255.0 up就是这个虚拟ip）</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">######################若只做VIP切换则不需要下面的转发配置#####################################################</span><br><span class="line"></span><br><span class="line">virtual_server 192.168.18.200 8080 &#123;  #配置虚拟主机</span><br><span class="line">    delay_loop 6</span><br><span class="line">    lb_algo wrr</span><br><span class="line">    lb_kind DR</span><br><span class="line">    nat_mask 255.255.255.0</span><br><span class="line">    persistence_timeout 50</span><br><span class="line">    protocol TCP</span><br><span class="line"></span><br><span class="line">    real_server 192.168.18.203 8080 &#123; #第一个RS</span><br><span class="line">        weight 1</span><br><span class="line">        TCP_CHECK &#123;</span><br><span class="line">            connect_timeout 8</span><br><span class="line">            nb_get_retry 3</span><br><span class="line">            delay_before_retry 3</span><br><span class="line">            connect_port 8080  #健康检查的端口</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    real_server 192.168.18.204 8080 &#123;  #第二个RS</span><br><span class="line">        weight 1</span><br><span class="line">        TCP_CHECK &#123;</span><br><span class="line">          connect_timeout 8</span><br><span class="line">          nb_get_retry 3</span><br><span class="line">          delay_before_retry 3</span><br><span class="line">          connect_port 8080  #健康检查的端口</span><br><span class="line">     &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="九-生产实例"><a href="#九-生产实例" class="headerlink" title="九. 生产实例"></a>九. 生产实例</h2><h4 id="9-1-只做高可用VIP切换"><a href="#9-1-只做高可用VIP切换" class="headerlink" title="9.1 只做高可用VIP切换"></a>9.1 只做高可用VIP切换</h4><h5 id="9-1-1-按照上一章配置文件只复制到VIP切换部分到配置文件"><a href="#9-1-1-按照上一章配置文件只复制到VIP切换部分到配置文件" class="headerlink" title="9.1.1 按照上一章配置文件只复制到VIP切换部分到配置文件"></a>9.1.1 按照上一章配置文件只复制到VIP切换部分到配置文件</h5><p><code>先清空配置文参照上文配置</code></p><h5 id="9-1-2-分别启动主从keepalived"><a href="#9-1-2-分别启动主从keepalived" class="headerlink" title="9.1.2 分别启动主从keepalived"></a>9.1.2 分别启动主从keepalived</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@lvs01 keepalived]# /etc/init.d/keepalived start</span><br><span class="line">Starting keepalived:                                       [  OK  ]</span><br><span class="line">[root@lvs02 keepalived]# /etc/init.d/keepalived start</span><br><span class="line">Starting keepalived:                                       [  OK  ]</span><br></pre></td></tr></table></figure><h5 id="9-1-3-查看主从IP"><a href="#9-1-3-查看主从IP" class="headerlink" title="9.1.3 查看主从IP"></a>9.1.3 查看主从IP</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@lvs01 keepalived]# ip a </span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN </span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</span><br><span class="line">    link/ether 00:0c:29:cc:ec:94 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.241.12/24 brd 192.168.241.255 scope global eth0</span><br><span class="line">    `inet 192.168.44.11/32 scope global eth0`</span><br><span class="line">    inet6 fe80::20c:29ff:fecc:ec94/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">[root@lvs02 keepalived]# ip a </span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN </span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</span><br><span class="line">    link/ether 00:0c:29:f4:f8:ab brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.241.13/24 brd 192.168.241.255 scope global eth0</span><br><span class="line">    inet6 fe80::20c:29ff:fef4:f8ab/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure><h5 id="9-1-4-停止主机keepalived模拟主机故障"><a href="#9-1-4-停止主机keepalived模拟主机故障" class="headerlink" title="9.1.4 停止主机keepalived模拟主机故障"></a>9.1.4 停止主机keepalived模拟主机故障</h5><ul><li><p>主机信息</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@lvs01 keepalived]# ip a </span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN </span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</span><br><span class="line">    link/ether 00:0c:29:cc:ec:94 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.241.12/24 brd 192.168.241.255 scope global eth0</span><br><span class="line">    inet6 fe80::20c:29ff:fecc:ec94/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure></li><li><p>从机信息</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@lvs02 keepalived]# ip a</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN </span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</span><br><span class="line">    link/ether 00:0c:29:f4:f8:ab brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.241.13/24 brd 192.168.241.255 scope global eth0</span><br><span class="line">    `inet 192.168.44.11/32 scope global eth0`</span><br><span class="line">    inet6 fe80::20c:29ff:fef4:f8ab/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure></li></ul><h5 id="9-1-5-启动主机keepalived模拟故障恢复"><a href="#9-1-5-启动主机keepalived模拟故障恢复" class="headerlink" title="9.1.5 启动主机keepalived模拟故障恢复"></a>9.1.5 启动主机keepalived模拟故障恢复</h5><ul><li><p>主机信息</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@lvs01 keepalived]# ip a</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN </span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</span><br><span class="line">    link/ether 00:0c:29:cc:ec:94 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.241.12/24 brd 192.168.241.255 scope global eth0</span><br><span class="line">    `inet 192.168.44.11/32 scope global eth0`</span><br><span class="line">    inet6 fe80::20c:29ff:fecc:ec94/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure></li><li><p>从机信息</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@lvs02 keepalived]# ip a </span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN </span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</span><br><span class="line">    link/ether 00:0c:29:f4:f8:ab brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.241.13/24 brd 192.168.241.255 scope global eth0</span><br><span class="line">    inet6 fe80::20c:29ff:fef4:f8ab/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure></li></ul><h4 id="9-2-结合lvs做4成负载均衡"><a href="#9-2-结合lvs做4成负载均衡" class="headerlink" title="9.2 结合lvs做4成负载均衡"></a>9.2 结合lvs做4成负载均衡</h4><h5 id="9-2-1-修改主从两台主机的配置文件添加lvs部分"><a href="#9-2-1-修改主从两台主机的配置文件添加lvs部分" class="headerlink" title="9.2.1 修改主从两台主机的配置文件添加lvs部分"></a>9.2.1 修改主从两台主机的配置文件添加lvs部分</h5><p><code>参见上文</code></p><h5 id="9-2-2-重启keepalived查看ipvs信息"><a href="#9-2-2-重启keepalived查看ipvs信息" class="headerlink" title="9.2.2 重启keepalived查看ipvs信息"></a>9.2.2 重启keepalived查看ipvs信息</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@lvs01 keepalived]# /etc/init.d/keepalived restart</span><br><span class="line">Stopping keepalived:                                       [  OK  ]</span><br><span class="line">Starting keepalived:                                       [  OK  ]</span><br><span class="line">[root@lvs01 keepalived]# ipvsadm</span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> RemoteAddress:Port           Forward Weight ActiveConn InActConn</span></span><br><span class="line">TCP  192.168.241.11:http wrr persistent 50</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 192.168.241.15:http          Route   1      0          0         </span></span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 192.168.241.16:http          Route   1      0          0</span></span><br></pre></td></tr></table></figure><h5 id="9-2-3-模拟主机故障"><a href="#9-2-3-模拟主机故障" class="headerlink" title="9.2.3 模拟主机故障"></a>9.2.3 模拟主机故障</h5><ul><li><p>主机信息</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@lvs01 keepalived]# /etc/init.d/keepalived stop</span><br><span class="line">Stopping keepalived:                                       [  OK  ]</span><br><span class="line">[root@lvs01 keepalived]# ipvsadm -L -n</span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> RemoteAddress:Port           Forward Weight ActiveConn InActConn</span></span><br></pre></td></tr></table></figure></li><li><p>从机信息</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@lvs02 keepalived]# ipvsadm -L -n</span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> RemoteAddress:Port           Forward Weight ActiveConn InActConn</span></span><br><span class="line">TCP  192.168.241.11:80 wrr persistent 50</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 192.168.241.15:80            Route   1      0          0         </span></span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 192.168.241.16:80            Route   1      0          0         </span></span><br><span class="line">注：即使主故障，从接管，ipvs信息在从上并不会被删除，只会做VIP的切换</span><br></pre></td></tr></table></figure></li></ul><h5 id="9-2-3-模拟故障恢复"><a href="#9-2-3-模拟故障恢复" class="headerlink" title="9.2.3 模拟故障恢复"></a>9.2.3 模拟故障恢复</h5><ul><li><p>主机信息</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@lvs01 keepalived]# ip a </span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN </span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</span><br><span class="line">    link/ether 00:0c:29:cc:ec:94 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.241.12/24 brd 192.168.241.255 scope global eth0</span><br><span class="line">    inet 192.168.44.11/32 scope global eth0</span><br><span class="line">    inet6 fe80::20c:29ff:fecc:ec94/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure></li><li><p>从机信息</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@lvs02 keepalived]# ip a </span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN </span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</span><br><span class="line">    link/ether 00:0c:29:f4:f8:ab brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.241.13/24 brd 192.168.241.255 scope global eth0</span><br><span class="line">    inet6 fe80::20c:29ff:fef4:f8ab/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure></li></ul><h2 id="十-配置脚本触发主从切换"><a href="#十-配置脚本触发主从切换" class="headerlink" title="十. 配置脚本触发主从切换"></a>十. 配置脚本触发主从切换</h2><h4 id="10-1-添加监控脚本部分"><a href="#10-1-添加监控脚本部分" class="headerlink" title="10.1 添加监控脚本部分"></a>10.1 添加监控脚本部分</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vrrp_script mysql_check &#123;   #配置监控脚本</span><br><span class="line">  script &quot;/root/mysql_check.sh&quot;   #监控脚本</span><br><span class="line">  interval 1    ###检测时间间隔 1s###</span><br><span class="line">  weigh -100   ###如果条件成立（脚本返回非0），权重-100###</span><br><span class="line">&#125;</span><br><span class="line">#添加位置见第八章</span><br></pre></td></tr></table></figure><h4 id="10-2-给虚拟主机添加使用的脚本"><a href="#10-2-给虚拟主机添加使用的脚本" class="headerlink" title="10.2 给虚拟主机添加使用的脚本"></a>10.2 给虚拟主机添加使用的脚本</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">  track_script &#123;</span><br><span class="line">        mysql_check  #使用监控脚本</span><br><span class="line">  &#125;</span><br><span class="line">#添加位置见第八章</span><br></pre></td></tr></table></figure><h4 id="10-3-以mysql为例编写监控脚本"><a href="#10-3-以mysql为例编写监控脚本" class="headerlink" title="10.3 以mysql为例编写监控脚本"></a>10.3 以mysql为例编写监控脚本</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"> mysqladmin ping &gt; /dev/null 2&gt;&amp;1</span><br><span class="line"> if [ $? -eq 0 ]; then</span><br><span class="line">   exit 0</span><br><span class="line"> fi</span><br><span class="line"> exit 1</span><br></pre></td></tr></table></figure><h4 id="10-4-重启两个keepalived"><a href="#10-4-重启两个keepalived" class="headerlink" title="10.4 重启两个keepalived"></a>10.4 重启两个keepalived</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@lvs01 keepalived]# /etc/init.d/keepalived restart</span><br><span class="line">Stopping keepalived:                                       [  OK  ]</span><br><span class="line">Starting keepalived:                                       [  OK  ]</span><br><span class="line">[root@lvs02 keepalived]# /etc/init.d/keepalived restart</span><br><span class="line">Stopping keepalived:                                       [  OK  ]</span><br><span class="line">Starting keepalived:                                       [  OK  ]</span><br></pre></td></tr></table></figure><h4 id="10-5-查看VIP"><a href="#10-5-查看VIP" class="headerlink" title="10.5 查看VIP"></a>10.5 查看VIP</h4><ul><li><p>主机</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@lvs01 keepalived]# ip a </span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN </span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</span><br><span class="line">    link/ether 00:0c:29:cc:ec:94 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.241.12/24 brd 192.168.241.255 scope global eth0</span><br><span class="line">    inet 192.168.44.11/32 scope global eth0</span><br><span class="line">    inet6 fe80::20c:29ff:fecc:ec94/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure></li><li><p>从机</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@lvs02 keepalived]# ip a</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN </span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</span><br><span class="line">    link/ether 00:0c:29:f4:f8:ab brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.241.13/24 brd 192.168.241.255 scope global eth0</span><br><span class="line">    inet6 fe80::20c:29ff:fef4:f8ab/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure></li></ul><h4 id="10-6-停止主机mysql查看VIP"><a href="#10-6-停止主机mysql查看VIP" class="headerlink" title="10.6 停止主机mysql查看VIP"></a>10.6 停止主机mysql查看VIP</h4><ul><li><p>主机</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@lvs01 keepalived]# /etc/init.d/mysqld stop </span><br><span class="line">Stopping mysqld:                                           [  OK  ]</span><br><span class="line">[root@lvs01 keepalived]# ip a</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN </span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</span><br><span class="line">    link/ether 00:0c:29:cc:ec:94 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.241.12/24 brd 192.168.241.255 scope global eth0</span><br><span class="line">    inet6 fe80::20c:29ff:fecc:ec94/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure></li><li><p>从机</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@lvs02 keepalived]# ip a</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN </span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</span><br><span class="line">    link/ether 00:0c:29:f4:f8:ab brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.241.13/24 brd 192.168.241.255 scope global eth0</span><br><span class="line">    `inet 192.168.44.11/32 scope global eth0`</span><br><span class="line">    inet6 fe80::20c:29ff:fef4:f8ab/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure></li></ul><h4 id="10-7-启动主机mysql恢复测试"><a href="#10-7-启动主机mysql恢复测试" class="headerlink" title="10.7 启动主机mysql恢复测试"></a>10.7 启动主机mysql恢复测试</h4><ul><li><p>主机</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@lvs01 keepalived]# /etc/init.d/mysqld start</span><br><span class="line">Starting mysqld:                                           [  OK  ]</span><br><span class="line">[root@lvs01 keepalived]# ip a</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN </span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</span><br><span class="line">    link/ether 00:0c:29:cc:ec:94 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.241.12/24 brd 192.168.241.255 scope global eth0</span><br><span class="line">    `inet 192.168.44.11/32 scope global eth0`</span><br><span class="line">    inet6 fe80::20c:29ff:fecc:ec94/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure></li><li><p>从机</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@lvs02 keepalived]# ip a</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN </span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</span><br><span class="line">    link/ether 00:0c:29:f4:f8:ab brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.241.13/24 brd 192.168.241.255 scope global eth0</span><br><span class="line">    inet6 fe80::20c:29ff:fef4:f8ab/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure></li></ul>]]></content>
    
    <summary type="html">
    
      descriptions
    
    </summary>
    
      <category term="运维" scheme="http://www.duoyichen.xyz/categories/%E8%BF%90%E7%BB%B4/"/>
    
    
      <category term="keepalived" scheme="http://www.duoyichen.xyz/tags/keepalived/"/>
    
      <category term="lvs" scheme="http://www.duoyichen.xyz/tags/lvs/"/>
    
      <category term="负载均衡" scheme="http://www.duoyichen.xyz/tags/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/"/>
    
  </entry>
  
  <entry>
    <title>Kubernets集群安装部署 06</title>
    <link href="http://www.duoyichen.xyz/2018-10/k8s-6/"/>
    <id>http://www.duoyichen.xyz/2018-10/k8s-6/</id>
    <published>2018-10-01T20:19:57.000Z</published>
    <updated>2018-10-01T23:24:07.593Z</updated>
    
    <content type="html"><![CDATA[<p><br></p><h2 id="七、部署Flannel"><a href="#七、部署Flannel" class="headerlink" title="七、部署Flannel"></a>七、部署Flannel</h2><h3 id="7-1-为Flannel生成证书"><a href="#7-1-为Flannel生成证书" class="headerlink" title="7.1 为Flannel生成证书"></a>7.1 为Flannel生成证书</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/src/ssl</span><br><span class="line">cat &gt;flanneld-csr.json&lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;flanneld&quot;,</span><br><span class="line">  &quot;hosts&quot;: [],</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">      &quot;ST&quot;: &quot;TianJin&quot;,</span><br><span class="line">      &quot;L&quot;: &quot;TianJin&quot;,</span><br><span class="line">      &quot;O&quot;: &quot;k8s&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;System&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="7-2-生成证书"><a href="#7-2-生成证书" class="headerlink" title="7.2 生成证书"></a>7.2 生成证书</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert -ca=/opt/kubernetes/ssl/ca.pem \</span><br><span class="line">   -ca-key=/opt/kubernetes/ssl/ca-key.pem \</span><br><span class="line">   -config=/opt/kubernetes/ssl/ca-config.json \</span><br><span class="line">   -profile=kubernetes flanneld-csr.json | cfssljson -bare flanneld</span><br></pre></td></tr></table></figure><h3 id="7-3-分发证书"><a href="#7-3-分发证书" class="headerlink" title="7.3 分发证书"></a>7.3 分发证书</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cp flanneld*.pem /opt/kubernetes/ssl/</span><br><span class="line">scp flanneld*.pem k8s-node1:/opt/kubernetes/ssl/</span><br><span class="line">scp flanneld*.pem k8s-node2:/opt/kubernetes/ssl/</span><br></pre></td></tr></table></figure><h3 id="7-4安装Flannel"><a href="#7-4安装Flannel" class="headerlink" title="7.4安装Flannel"></a>7.4安装Flannel</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">tar zxf flannel-v0.10.0-linux-amd64.tar.gz</span><br><span class="line">cp flanneld mk-docker-opts.sh /opt/kubernetes/bin/</span><br><span class="line">scp flanneld mk-docker-opts.sh k8s-node1:/opt/kubernetes/bin/</span><br><span class="line">scp flanneld mk-docker-opts.sh k8s-node2:/opt/kubernetes/bin/</span><br><span class="line">cd /usr/local/src/kubernetes/cluster/centos/node/bin/</span><br><span class="line">cp remove-docker0.sh /opt/kubernetes/bin/</span><br><span class="line">scp remove-docker0.sh k8s-node1:/opt/kubernetes/bin/</span><br><span class="line">scp remove-docker0.sh k8s-node2:/opt/kubernetes/bin/</span><br></pre></td></tr></table></figure><h3 id="7-5-配置Flannel"><a href="#7-5-配置Flannel" class="headerlink" title="7.5 配置Flannel"></a>7.5 配置Flannel</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;/opt/kubernetes/cfg/flannel&lt;&lt;EOF</span><br><span class="line">FLANNEL_ETCD=&quot;-etcd-endpoints=https://192.168.217.10:2379,https://192.168.217.20:2379,https://192.168.217.30:2379&quot;</span><br><span class="line">FLANNEL_ETCD_KEY=&quot;-etcd-prefix=/kubernetes/network&quot;</span><br><span class="line">FLANNEL_ETCD_CAFILE=&quot;--etcd-cafile=/opt/kubernetes/ssl/ca.pem&quot;</span><br><span class="line">FLANNEL_ETCD_CERTFILE=&quot;--etcd-certfile=/opt/kubernetes/ssl/flanneld.pem&quot;</span><br><span class="line">FLANNEL_ETCD_KEYFILE=&quot;--etcd-keyfile=/opt/kubernetes/ssl/flanneld-key.pem&quot;</span><br><span class="line">EOF</span><br><span class="line">scp /opt/kubernetes/cfg/flannel k8s-node1:/opt/kubernetes/cfg/</span><br><span class="line">scp /opt/kubernetes/cfg/flannel k8s-node2:/opt/kubernetes/cfg/</span><br></pre></td></tr></table></figure><h3 id="7-6-设置Flannel系统服务"><a href="#7-6-设置Flannel系统服务" class="headerlink" title="7.6 设置Flannel系统服务"></a>7.6 设置Flannel系统服务</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;/usr/lib/systemd/system/flannel.service&lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Flanneld overlay address etcd agent</span><br><span class="line">After=network.target</span><br><span class="line">Before=docker.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/opt/kubernetes/cfg/flannel</span><br><span class="line">ExecStartPre=/opt/kubernetes/bin/remove-docker0.sh</span><br><span class="line">ExecStart=/opt/kubernetes/bin/flanneld \$&#123;FLANNEL_ETCD&#125; \$&#123;FLANNEL_ETCD_KEY&#125; \$&#123;FLANNEL_ETCD_CAFILE&#125; \$&#123;FLANNEL_ETCD_CERTFILE&#125; \$&#123;FLANNEL_ETCD_KEYFILE&#125;</span><br><span class="line">ExecStartPost=/opt/kubernetes/bin/mk-docker-opts.sh -d /run/flannel/docker</span><br><span class="line"></span><br><span class="line">Type=notify</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">RequiredBy=docker.service</span><br><span class="line">EOF</span><br><span class="line">scp /usr/lib/systemd/system/flannel.service k8s-node1:/usr/lib/systemd/system/</span><br><span class="line">scp /usr/lib/systemd/system/flannel.service k8s-node2:/usr/lib/systemd/system/</span><br></pre></td></tr></table></figure><h3 id="7-7-Flannel-CNI集成"><a href="#7-7-Flannel-CNI集成" class="headerlink" title="7.7 Flannel CNI集成"></a>7.7 Flannel CNI集成</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/src/</span><br><span class="line">mkdir /opt/kubernetes/bin/cni</span><br><span class="line">tar zxf cni-plugins-amd64-v0.7.1.tgz -C /opt/kubernetes/bin/cni</span><br><span class="line">scp -r /opt/kubernetes/bin/cni/* k8s-node1:/opt/kubernetes/bin/cni/</span><br><span class="line">scp -r /opt/kubernetes/bin/cni/* k8s-node2:/opt/kubernetes/bin/cni/</span><br></pre></td></tr></table></figure><h3 id="7-8-创建Etcd的key"><a href="#7-8-创建Etcd的key" class="headerlink" title="7.8 创建Etcd的key"></a>7.8 创建Etcd的key</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/opt/kubernetes/bin/etcdctl --ca-file /opt/kubernetes/ssl/ca.pem --cert-file /opt/kubernetes/ssl/flanneld.pem --key-file /opt/kubernetes/ssl/flanneld-key.pem \</span><br><span class="line">      --no-sync -C https://192.168.217.10:2379,https://192.168.217.20:2379,https://192.168.217.30:2379 \</span><br><span class="line">mk /kubernetes/network/config &apos;&#123; &quot;Network&quot;: &quot;10.2.0.0/16&quot;, &quot;Backend&quot;: &#123; &quot;Type&quot;: &quot;vxlan&quot;, &quot;VNI&quot;: 1 &#125;&#125;&apos; &gt;/dev/null 2&gt;&amp;1</span><br></pre></td></tr></table></figure><h3 id="7-9-修改docker启动文件-再所有节点执行"><a href="#7-9-修改docker启动文件-再所有节点执行" class="headerlink" title="7.9 修改docker启动文件(再所有节点执行)"></a>7.9 修改docker启动文件(再所有节点执行)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]# vim /usr/lib/systemd/system/docker.service</span><br><span class="line">[Unit] #在Unit下面修改After和增加Requires</span><br><span class="line">After=network-online.target firewalld.service flannel.service</span><br><span class="line">Wants=network-online.target</span><br><span class="line">Requires=flannel.service</span><br><span class="line"></span><br><span class="line">[Service] #增加EnvironmentFile=-/run/flannel/docker</span><br><span class="line">Type=notify</span><br><span class="line">EnvironmentFile=-/run/flannel/docker</span><br><span class="line">ExecStart=/usr/bin/dockerd $DOCKER_OPTS</span><br></pre></td></tr></table></figure><h3 id="7-10-分发docker启动文件"><a href="#7-10-分发docker启动文件" class="headerlink" title="7.10 分发docker启动文件"></a>7.10 分发docker启动文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scp /usr/lib/systemd/system/docker.service k8s-node1:/usr/lib/systemd/system/</span><br><span class="line">scp /usr/lib/systemd/system/docker.service k8s-node2:/usr/lib/systemd/system/</span><br></pre></td></tr></table></figure><h3 id="7-11重启docker-再所有节点执行"><a href="#7-11重启docker-再所有节点执行" class="headerlink" title="7.11重启docker(再所有节点执行)"></a>7.11重启docker(再所有节点执行)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      descriptions
    
    </summary>
    
      <category term="运维" scheme="http://www.duoyichen.xyz/categories/%E8%BF%90%E7%BB%B4/"/>
    
    
      <category term="kubernets" scheme="http://www.duoyichen.xyz/tags/kubernets/"/>
    
      <category term="docker" scheme="http://www.duoyichen.xyz/tags/docker/"/>
    
      <category term="容器" scheme="http://www.duoyichen.xyz/tags/%E5%AE%B9%E5%99%A8/"/>
    
  </entry>
  
  <entry>
    <title>Kubernets集群安装部署 05</title>
    <link href="http://www.duoyichen.xyz/2018-10/k8s-5/"/>
    <id>http://www.duoyichen.xyz/2018-10/k8s-5/</id>
    <published>2018-10-01T20:18:57.000Z</published>
    <updated>2018-10-01T23:23:52.324Z</updated>
    
    <content type="html"><![CDATA[<p><br></p><h2 id="六、部署node节点"><a href="#六、部署node节点" class="headerlink" title="六、部署node节点"></a>六、部署node节点</h2><h3 id="6-1-安装软件-在master执行"><a href="#6-1-安装软件-在master执行" class="headerlink" title="6.1 安装软件(在master执行)"></a>6.1 安装软件(在master执行)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tar zxf kubernetes-node-linux-amd64.tar.gz.tar </span><br><span class="line">cd /usr/local/src/kubernetes/server/bin/</span><br><span class="line">scp kubelet kube-proxy k8s-node1:/opt/kubernetes/bin/</span><br><span class="line">scp kubelet kube-proxy k8s-node2:/opt/kubernetes/bin/</span><br></pre></td></tr></table></figure><h3 id="6-2-创建角色-在master执行"><a href="#6-2-创建角色-在master执行" class="headerlink" title="6.2 创建角色(在master执行)"></a>6.2 创建角色(在master执行)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create clusterrolebinding kubelet-bootstrap --clusterrole=system:node-bootstrapper --user=kubelet-bootstrap</span><br></pre></td></tr></table></figure><h3 id="6-3-创建-kubelet-bootstrapping-kubeconfig-文件-设置集群参数-在master执行"><a href="#6-3-创建-kubelet-bootstrapping-kubeconfig-文件-设置集群参数-在master执行" class="headerlink" title="6.3 创建 kubelet bootstrapping kubeconfig 文件 设置集群参数(在master执行)"></a>6.3 创建 kubelet bootstrapping kubeconfig 文件 设置集群参数(在master执行)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl config set-cluster kubernetes \</span><br><span class="line">   --certificate-authority=/opt/kubernetes/ssl/ca.pem \</span><br><span class="line">   --embed-certs=true \</span><br><span class="line">   --server=https://192.168.217.10:6443 \</span><br><span class="line">   --kubeconfig=bootstrap.kubeconfig</span><br></pre></td></tr></table></figure><h3 id="6-4-设置客户端认证参数-在master执行"><a href="#6-4-设置客户端认证参数-在master执行" class="headerlink" title="6.4 设置客户端认证参数(在master执行)"></a>6.4 设置客户端认证参数(在master执行)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl config set-credentials kubelet-bootstrap \</span><br><span class="line">   --token=$token\</span><br><span class="line">   --kubeconfig=bootstrap.kubeconfig</span><br></pre></td></tr></table></figure><h3 id="6-5-设置上下文参数-在master执行"><a href="#6-5-设置上下文参数-在master执行" class="headerlink" title="6.5 设置上下文参数(在master执行)"></a>6.5 设置上下文参数(在master执行)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl config set-context default \</span><br><span class="line">   --cluster=kubernetes \</span><br><span class="line">   --user=kubelet-bootstrap \</span><br><span class="line">   --kubeconfig=bootstrap.kubeconfig</span><br></pre></td></tr></table></figure><h3 id="6-6-默认选择上下文-在master执行"><a href="#6-6-默认选择上下文-在master执行" class="headerlink" title="6.6 默认选择上下文(在master执行)"></a>6.6 默认选择上下文(在master执行)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl config use-context default --kubeconfig=bootstrap.kubeconfig</span><br><span class="line">scp bootstrap.kubeconfig k8s-node1:/opt/kubernetes/cfg</span><br><span class="line">scp bootstrap.kubeconfig k8s-node2:/opt/kubernetes/cfg</span><br></pre></td></tr></table></figure><h3 id="6-7-设置CNI支持-在所有node执行"><a href="#6-7-设置CNI支持-在所有node执行" class="headerlink" title="6.7 设置CNI支持(在所有node执行)"></a>6.7 设置CNI支持(在所有node执行)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /etc/cni/net.d</span><br><span class="line">cat &gt;/etc/cni/net.d/10-default.conf&lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">        &quot;name&quot;: &quot;flannel&quot;,</span><br><span class="line">        &quot;type&quot;: &quot;flannel&quot;,</span><br><span class="line">        &quot;delegate&quot;: &#123;</span><br><span class="line">            &quot;bridge&quot;: &quot;docker0&quot;,</span><br><span class="line">            &quot;isDefaultGateway&quot;: true,</span><br><span class="line">            &quot;mtu&quot;: 1400</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="6-8-创建kubelet目录-在所有node执行"><a href="#6-8-创建kubelet目录-在所有node执行" class="headerlink" title="6.8 创建kubelet目录(在所有node执行)"></a>6.8 创建kubelet目录(在所有node执行)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir /var/lib/kubelet</span><br></pre></td></tr></table></figure><h3 id="6-9-创建kubelet服务配置"><a href="#6-9-创建kubelet服务配置" class="headerlink" title="6.9 创建kubelet服务配置"></a>6.9 创建kubelet服务配置</h3><h4 id="node1"><a href="#node1" class="headerlink" title="node1"></a>node1</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;/usr/lib/systemd/system/kubelet.service&lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kubelet</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line">After=docker.service</span><br><span class="line">Requires=docker.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">WorkingDirectory=/var/lib/kubelet</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kubelet \</span><br><span class="line">  --address=192.168.217.20 \</span><br><span class="line">  --hostname-override=192.168.217.20 \</span><br><span class="line">  --pod-infra-container-image=mirrorgooglecontainers/pause-amd64:3.0 \</span><br><span class="line">  --experimental-bootstrap-kubeconfig=/opt/kubernetes/cfg/bootstrap.kubeconfig \</span><br><span class="line">  --kubeconfig=/opt/kubernetes/cfg/kubelet.kubeconfig \</span><br><span class="line">  --cert-dir=/opt/kubernetes/ssl \</span><br><span class="line">  --network-plugin=cni \</span><br><span class="line">  --cni-conf-dir=/etc/cni/net.d \</span><br><span class="line">  --cni-bin-dir=/opt/kubernetes/bin/cni \</span><br><span class="line">  --cluster-dns=10.1.0.2 \</span><br><span class="line">  --cluster-domain=cluster.local. \</span><br><span class="line">  --hairpin-mode hairpin-veth \</span><br><span class="line">  --allow-privileged=true \</span><br><span class="line">  --fail-swap-on=false \</span><br><span class="line">  --logtostderr=true \</span><br><span class="line">  --v=2 \</span><br><span class="line">  --logtostderr=false \</span><br><span class="line">  --log-dir=/opt/kubernetes/log</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="node2"><a href="#node2" class="headerlink" title="node2"></a>node2</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;/usr/lib/systemd/system/kubelet.service&lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kubelet</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line">After=docker.service</span><br><span class="line">Requires=docker.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">WorkingDirectory=/var/lib/kubelet</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kubelet \</span><br><span class="line">  --address=192.168.217.30 \</span><br><span class="line">  --hostname-override=192.168.217.30 \</span><br><span class="line">  --pod-infra-container-image=mirrorgooglecontainers/pause-amd64:3.0 \</span><br><span class="line">  --experimental-bootstrap-kubeconfig=/opt/kubernetes/cfg/bootstrap.kubeconfig \</span><br><span class="line">  --kubeconfig=/opt/kubernetes/cfg/kubelet.kubeconfig \</span><br><span class="line">  --cert-dir=/opt/kubernetes/ssl \</span><br><span class="line">  --network-plugin=cni \</span><br><span class="line">  --cni-conf-dir=/etc/cni/net.d \</span><br><span class="line">  --cni-bin-dir=/opt/kubernetes/bin/cni \</span><br><span class="line">  --cluster-dns=10.1.0.2 \</span><br><span class="line">  --cluster-domain=cluster.local. \</span><br><span class="line">  --hairpin-mode hairpin-veth \</span><br><span class="line">  --allow-privileged=true \</span><br><span class="line">  --fail-swap-on=false \</span><br><span class="line">  --logtostderr=true \</span><br><span class="line">  --v=2 \</span><br><span class="line">  --logtostderr=false \</span><br><span class="line">  --log-dir=/opt/kubernetes/log</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="6-10-启动kubelet-在所有node执行"><a href="#6-10-启动kubelet-在所有node执行" class="headerlink" title="6.10 启动kubelet(在所有node执行)"></a>6.10 启动kubelet(在所有node执行)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable kubelet</span><br><span class="line">systemctl start kubelet</span><br></pre></td></tr></table></figure><h3 id="6-11-验证kubelet-在所有node执行"><a href="#6-11-验证kubelet-在所有node执行" class="headerlink" title="6.11 验证kubelet(在所有node执行)"></a>6.11 验证kubelet(在所有node执行)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-node2 ~]# systemctl status kubelet</span><br><span class="line">● kubelet.service - Kubernetes Kubelet</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/kubelet.service; static; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since 四 2018-06-07 13:34:07 CST; 32s ago</span><br><span class="line">     Docs: https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line"> Main PID: 25392 (kubelet)</span><br><span class="line">    Tasks: 6</span><br><span class="line">   Memory: 12.6M</span><br><span class="line">   CGroup: /system.slice/kubelet.service</span><br><span class="line">           └─25392 /opt/kubernetes/bin/kubelet --address=192.168.217.30 --hostname-override=192.168.217.30 --pod-infra-container-image=mirrorgooglecontainers/pause-amd64:3.0 --experimental-bootstrap-kubeconfig=/opt/kubernetes/cfg...</span><br><span class="line"></span><br><span class="line">6月 07 13:34:07 k8s-node2 systemd[1]: kubelet.service holdoff time over, scheduling restart.</span><br><span class="line">6月 07 13:34:07 k8s-node2 systemd[1]: Started Kubernetes Kubelet.</span><br><span class="line">6月 07 13:34:07 k8s-node2 systemd[1]: Starting Kubernetes Kubelet...</span><br><span class="line">6月 07 13:34:08 k8s-node2 kubelet[25392]: Flag --address has been deprecated, This parameter should be set via the config file specified by the Kubelet&apos;s --config flag. See https://kubernetes.io/docs/tasks/admini...ore information.</span><br><span class="line">6月 07 13:34:08 k8s-node2 kubelet[25392]: Flag --cluster-dns has been deprecated, This parameter should be set via the config file specified by the Kubelet&apos;s --config flag. See https://kubernetes.io/docs/tasks/ad...ore information.</span><br><span class="line">6月 07 13:34:08 k8s-node2 kubelet[25392]: Flag --cluster-domain has been deprecated, This parameter should be set via the config file specified by the Kubelet&apos;s --config flag. See https://kubernetes.io/docs/tasks...ore information.</span><br><span class="line">6月 07 13:34:08 k8s-node2 kubelet[25392]: Flag --hairpin-mode has been deprecated, This parameter should be set via the config file specified by the Kubelet&apos;s --config flag. See https://kubernetes.io/docs/tasks/a...ore information.</span><br><span class="line">6月 07 13:34:08 k8s-node2 kubelet[25392]: Flag --allow-privileged has been deprecated, will be removed in a future version</span><br><span class="line">6月 07 13:34:08 k8s-node2 kubelet[25392]: Flag --fail-swap-on has been deprecated, This parameter should be set via the config file specified by the Kubelet&apos;s --config flag. See https://kubernetes.io/docs/tasks/a...ore information.</span><br><span class="line">Hint: Some lines were ellipsized, use -l to show in full.</span><br><span class="line">[root@k8s-node2 ~]#</span><br></pre></td></tr></table></figure><h3 id="6-12-查看csr请求-在master执行"><a href="#6-12-查看csr请求-在master执行" class="headerlink" title="6.12 查看csr请求(在master执行)"></a>6.12 查看csr请求(在master执行)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master /usr/local/src/kubernetes/server/bin 13:34:07]# kubectl get csr                         </span><br><span class="line">NAME                                                   AGE       REQUESTOR           CONDITION</span><br><span class="line">node-csr-VKSZrqXu0FOwgkcrWKgb2LsTngcCJfV8xJ4GjLC65r4   48s       kubelet-bootstrap   Pending</span><br><span class="line">node-csr-nzkrupg8ngY7em9qSpSJ5QRJCcwcdk0alyNDuRnyCNE   52s       kubelet-bootstrap   Pending</span><br></pre></td></tr></table></figure><h3 id="6-13-批准kubelet-的-TLS-证书请求-在master执行"><a href="#6-13-批准kubelet-的-TLS-证书请求-在master执行" class="headerlink" title="6.13 批准kubelet 的 TLS 证书请求(在master执行)"></a>6.13 批准kubelet 的 TLS 证书请求(在master执行)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get csr|grep &apos;Pending&apos; | awk &apos;NR&gt;0&#123;print $1&#125;&apos;| xargs kubectl certificate approve</span><br></pre></td></tr></table></figure><h3 id="6-14-安装lvs-在所有node执行"><a href="#6-14-安装lvs-在所有node执行" class="headerlink" title="6.14 安装lvs(在所有node执行)"></a>6.14 安装lvs(在所有node执行)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y ipvsadm ipset conntrack</span><br></pre></td></tr></table></figure><h3 id="6-15-创建-kube-proxy-证书请求-在master执行"><a href="#6-15-创建-kube-proxy-证书请求-在master执行" class="headerlink" title="6.15 创建 kube-proxy 证书请求(在master执行)"></a>6.15 创建 kube-proxy 证书请求(在master执行)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/src/ssl/</span><br><span class="line">cat &gt;kube-proxy-csr.json&lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;system:kube-proxy&quot;,</span><br><span class="line">  &quot;hosts&quot;: [],</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">      &quot;ST&quot;: &quot;TianJin&quot;,</span><br><span class="line">      &quot;L&quot;: &quot;TianJin&quot;,</span><br><span class="line">      &quot;O&quot;: &quot;k8s&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;System&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="6-16-生成kube-proxy证书-在master执行"><a href="#6-16-生成kube-proxy证书-在master执行" class="headerlink" title="6.16 生成kube-proxy证书(在master执行)"></a>6.16 生成kube-proxy证书(在master执行)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert -ca=/opt/kubernetes/ssl/ca.pem \</span><br><span class="line">   -ca-key=/opt/kubernetes/ssl/ca-key.pem \</span><br><span class="line">   -config=/opt/kubernetes/ssl/ca-config.json \</span><br><span class="line">   -profile=kubernetes  kube-proxy-csr.json | cfssljson -bare kube-proxy</span><br><span class="line">cp kube-proxy*.pem /opt/kubernetes/ssl/</span><br><span class="line">scp kube-proxy*.pem k8s-node1:/opt/kubernetes/ssl/</span><br><span class="line">scp kube-proxy*.pem k8s-node2:/opt/kubernetes/ssl/</span><br></pre></td></tr></table></figure><h3 id="6-17-创建kube-proxy配置文件-在master执行"><a href="#6-17-创建kube-proxy配置文件-在master执行" class="headerlink" title="6.17 创建kube-proxy配置文件(在master执行)"></a>6.17 创建kube-proxy配置文件(在master执行)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">kubectl config set-cluster kubernetes \</span><br><span class="line">   --certificate-authority=/opt/kubernetes/ssl/ca.pem \</span><br><span class="line">   --embed-certs=true \</span><br><span class="line">   --server=https://192.168.217.10:6443 \</span><br><span class="line">   --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line">kubectl config set-credentials kube-proxy \</span><br><span class="line">   --client-certificate=/opt/kubernetes/ssl/kube-proxy.pem \</span><br><span class="line">   --client-key=/opt/kubernetes/ssl/kube-proxy-key.pem \</span><br><span class="line">   --embed-certs=true \</span><br><span class="line">   --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line">kubectl config set-context default \</span><br><span class="line">   --cluster=kubernetes \</span><br><span class="line">   --user=kube-proxy \</span><br><span class="line">   --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line">kubectl config use-context default --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line">cp kube-proxy.kubeconfig /opt/kubernetes/cfg/</span><br><span class="line">scp kube-proxy.kubeconfig k8s-node1:/opt/kubernetes/cfg/</span><br><span class="line">scp kube-proxy.kubeconfig k8s-node2:/opt/kubernetes/cfg/</span><br></pre></td></tr></table></figure><h3 id="6-18-创建kube-proxy服务配置"><a href="#6-18-创建kube-proxy服务配置" class="headerlink" title="6.18 创建kube-proxy服务配置"></a>6.18 创建kube-proxy服务配置</h3><h4 id="node1-1"><a href="#node1-1" class="headerlink" title="node1"></a>node1</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">mkdir /var/lib/kube-proxy</span><br><span class="line">cat &gt;/usr/lib/systemd/system/kube-proxy.service&lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kube-Proxy Server</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">WorkingDirectory=/var/lib/kube-proxy</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kube-proxy \</span><br><span class="line">  --bind-address=192.168.217.20 \</span><br><span class="line">  --hostname-override=192.168.217.20 \</span><br><span class="line">  --kubeconfig=/opt/kubernetes/cfg/kube-proxy.kubeconfig \</span><br><span class="line">--masquerade-all \</span><br><span class="line">  --feature-gates=SupportIPVSProxyMode=true \</span><br><span class="line">  --proxy-mode=ipvs \</span><br><span class="line">  --ipvs-min-sync-period=5s \</span><br><span class="line">  --ipvs-sync-period=5s \</span><br><span class="line">  --ipvs-scheduler=rr \</span><br><span class="line">  --logtostderr=true \</span><br><span class="line">  --v=2 \</span><br><span class="line">  --logtostderr=false \</span><br><span class="line">  --log-dir=/opt/kubernetes/log</span><br><span class="line"></span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="node2-1"><a href="#node2-1" class="headerlink" title="node2"></a>node2</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">mkdir /var/lib/kube-proxy</span><br><span class="line">cat &gt;/usr/lib/systemd/system/kube-proxy.service&lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kube-Proxy Server</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">WorkingDirectory=/var/lib/kube-proxy</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kube-proxy \</span><br><span class="line">  --bind-address=192.168.217.30 \</span><br><span class="line">  --hostname-override=192.168.217.30 \</span><br><span class="line">  --kubeconfig=/opt/kubernetes/cfg/kube-proxy.kubeconfig \</span><br><span class="line">--masquerade-all \</span><br><span class="line">  --feature-gates=SupportIPVSProxyMode=true \</span><br><span class="line">  --proxy-mode=ipvs \</span><br><span class="line">  --ipvs-min-sync-period=5s \</span><br><span class="line">  --ipvs-sync-period=5s \</span><br><span class="line">  --ipvs-scheduler=rr \</span><br><span class="line">  --logtostderr=true \</span><br><span class="line">  --v=2 \</span><br><span class="line">  --logtostderr=false \</span><br><span class="line">  --log-dir=/opt/kubernetes/log</span><br><span class="line"></span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="6-19-启动kube-proxy-在所有node执行"><a href="#6-19-启动kube-proxy-在所有node执行" class="headerlink" title="6.19 启动kube-proxy(在所有node执行)"></a>6.19 启动kube-proxy(在所有node执行)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable kube-proxy</span><br><span class="line">systemctl start kube-proxy</span><br></pre></td></tr></table></figure><h3 id="6-20-验证-在master执行"><a href="#6-20-验证-在master执行" class="headerlink" title="6.20 验证(在master执行)"></a>6.20 验证(在master执行)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master /usr/local/src/ssl 13:46:34]# kubectl get node</span><br><span class="line">NAME             STATUS    ROLES     AGE       VERSION</span><br><span class="line">192.168.217.20   Ready     &lt;none&gt;    12m       v1.10.3</span><br><span class="line">192.168.217.30   Ready     &lt;none&gt;    12m       v1.10.3</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      descriptions
    
    </summary>
    
      <category term="运维" scheme="http://www.duoyichen.xyz/categories/%E8%BF%90%E7%BB%B4/"/>
    
    
      <category term="kubernets" scheme="http://www.duoyichen.xyz/tags/kubernets/"/>
    
      <category term="docker" scheme="http://www.duoyichen.xyz/tags/docker/"/>
    
      <category term="容器" scheme="http://www.duoyichen.xyz/tags/%E5%AE%B9%E5%99%A8/"/>
    
  </entry>
  
  <entry>
    <title>Kubernets集群安装部署 04</title>
    <link href="http://www.duoyichen.xyz/2018-10/k8s-4/"/>
    <id>http://www.duoyichen.xyz/2018-10/k8s-4/</id>
    <published>2018-10-01T20:16:57.000Z</published>
    <updated>2018-10-01T23:24:05.179Z</updated>
    
    <content type="html"><![CDATA[<p><br></p><h3 id="5-7-启动API-Server服务"><a href="#5-7-启动API-Server服务" class="headerlink" title="5.7 启动API Server服务"></a>5.7 启动API Server服务</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable kube-apiserver</span><br><span class="line">systemctl start kube-apiserver</span><br></pre></td></tr></table></figure><h3 id="5-8-验证API-Server"><a href="#5-8-验证API-Server" class="headerlink" title="5.8 验证API Server"></a>5.8 验证API Server</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master /usr/local/src/kubernetes 11:19:42]# systemctl status kube-apiserver             </span><br><span class="line">● kube-apiserver.service - Kubernetes API Server</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/kube-apiserver.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since 四 2018-06-07 11:19:42 CST; 8s ago</span><br><span class="line">     Docs: https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line"> Main PID: 22837 (kube-apiserver)</span><br><span class="line">    Tasks: 7</span><br><span class="line">   Memory: 303.5M</span><br><span class="line">   CGroup: /system.slice/kube-apiserver.service</span><br><span class="line">           └─22837 /opt/kubernetes/bin/kube-apiserver --admission-control=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,ResourceQuota,NodeRestriction --bind-address=192.168.217.10 --insecure-bind-address=127.0...</span><br><span class="line"></span><br><span class="line">6月 07 11:19:35 k8s-master systemd[1]: kube-apiserver.service holdoff time over, scheduling restart.</span><br><span class="line">6月 07 11:19:35 k8s-master systemd[1]: Starting Kubernetes API Server...</span><br><span class="line">6月 07 11:19:36 k8s-master kube-apiserver[22837]: Flag --admission-control has been deprecated, Use --enable-admission-plugins or --disable-admission-plugins instead. Will be removed in a future version.</span><br><span class="line">6月 07 11:19:36 k8s-master kube-apiserver[22837]: Flag --insecure-bind-address has been deprecated, This flag will be removed in a future version.</span><br><span class="line">6月 07 11:19:38 k8s-master kube-apiserver[22837]: [restful] 2018/06/07 11:19:38 log.go:33: [restful/swagger] listing is available at https://192.168.217.10:6443/swaggerapi</span><br><span class="line">6月 07 11:19:38 k8s-master kube-apiserver[22837]: [restful] 2018/06/07 11:19:38 log.go:33: [restful/swagger] https://192.168.217.10:6443/swaggerui/ is mapped to folder /swagger-ui/</span><br><span class="line">6月 07 11:19:39 k8s-master kube-apiserver[22837]: [restful] 2018/06/07 11:19:39 log.go:33: [restful/swagger] listing is available at https://192.168.217.10:6443/swaggerapi</span><br><span class="line">6月 07 11:19:39 k8s-master kube-apiserver[22837]: [restful] 2018/06/07 11:19:39 log.go:33: [restful/swagger] https://192.168.217.10:6443/swaggerui/ is mapped to folder /swagger-ui/</span><br><span class="line">6月 07 11:19:42 k8s-master systemd[1]: Started Kubernetes API Server.</span><br><span class="line">[root@k8s-master /usr/local/src/kubernetes 11:19:50]#</span><br></pre></td></tr></table></figure><h3 id="5-9-部署Controller-Manager服务"><a href="#5-9-部署Controller-Manager服务" class="headerlink" title="5.9 部署Controller Manager服务"></a>5.9 部署Controller Manager服务</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;/usr/lib/systemd/system/kube-controller-manager.service&lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Controller Manager</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kube-controller-manager \</span><br><span class="line">  --address=127.0.0.1 \</span><br><span class="line">  --master=http://127.0.0.1:8080 \</span><br><span class="line">  --allocate-node-cidrs=true \</span><br><span class="line">  --service-cluster-ip-range=10.1.0.0/16 \</span><br><span class="line">  --cluster-cidr=10.2.0.0/16 \</span><br><span class="line">  --cluster-name=kubernetes \</span><br><span class="line">  --cluster-signing-cert-file=/opt/kubernetes/ssl/ca.pem \</span><br><span class="line">  --cluster-signing-key-file=/opt/kubernetes/ssl/ca-key.pem \</span><br><span class="line">  --service-account-private-key-file=/opt/kubernetes/ssl/ca-key.pem \</span><br><span class="line">  --root-ca-file=/opt/kubernetes/ssl/ca.pem \</span><br><span class="line">  --leader-elect=true \</span><br><span class="line">  --v=2 \</span><br><span class="line">  --logtostderr=false \</span><br><span class="line">  --log-dir=/opt/kubernetes/log</span><br><span class="line"></span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="5-10-启动Controller-Manager服务"><a href="#5-10-启动Controller-Manager服务" class="headerlink" title="5.10 启动Controller Manager服务"></a>5.10 启动Controller Manager服务</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable kube-controller-manager</span><br><span class="line">systemctl start kube-controller-manager</span><br></pre></td></tr></table></figure><h3 id="5-11-验证Controller-Manager服务"><a href="#5-11-验证Controller-Manager服务" class="headerlink" title="5.11 验证Controller Manager服务"></a>5.11 验证Controller Manager服务</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master /usr/local/src/kubernetes 11:45:24]# systemctl status kube-controller-manager</span><br><span class="line">● kube-controller-manager.service - Kubernetes Controller Manager</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/kube-controller-manager.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since 四 2018-06-07 11:45:24 CST; 8s ago</span><br><span class="line">     Docs: https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line"> Main PID: 22894 (kube-controller)</span><br><span class="line">    Tasks: 7</span><br><span class="line">   Memory: 10.1M</span><br><span class="line">   CGroup: /system.slice/kube-controller-manager.service</span><br><span class="line">           └─22894 /opt/kubernetes/bin/kube-controller-manager --address=127.0.0.1 --master=http://127.0.0.1:8080 --allocate-node-cidrs=true --service-cluster-ip-range=10.1.0.0/16 --cluster-cidr=10.2.0.0/16 --cluster-name=kuberne...</span><br><span class="line"></span><br><span class="line">6月 07 11:45:24 k8s-master systemd[1]: Started Kubernetes Controller Manager.</span><br><span class="line">6月 07 11:45:24 k8s-master systemd[1]: Starting Kubernetes Controller Manager...</span><br><span class="line">6月 07 11:45:26 k8s-master kube-controller-manager[22894]: E0607 11:45:26.105012   22894 core.go:75] Failed to start service controller: WARNING: no cloud provider provided, services of type LoadBalancer will fail</span><br></pre></td></tr></table></figure><h3 id="5-12-部署Kubernetes-Scheduler"><a href="#5-12-部署Kubernetes-Scheduler" class="headerlink" title="5.12 部署Kubernetes Scheduler"></a>5.12 部署Kubernetes Scheduler</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;/usr/lib/systemd/system/kube-scheduler.service&lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Scheduler</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kube-scheduler \</span><br><span class="line">  --address=127.0.0.1 \</span><br><span class="line">  --master=http://127.0.0.1:8080 \</span><br><span class="line">  --leader-elect=true \</span><br><span class="line">  --v=2 \</span><br><span class="line">  --logtostderr=false \</span><br><span class="line">  --log-dir=/opt/kubernetes/log</span><br><span class="line"></span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="5-13-启动Kubernetes-Scheduler"><a href="#5-13-启动Kubernetes-Scheduler" class="headerlink" title="5.13 启动Kubernetes Scheduler"></a>5.13 启动Kubernetes Scheduler</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable kube-scheduler</span><br><span class="line">systemctl start kube-scheduler</span><br></pre></td></tr></table></figure><h3 id="5-14-验证Kubernetes-Scheduler"><a href="#5-14-验证Kubernetes-Scheduler" class="headerlink" title="5.14 验证Kubernetes Scheduler"></a>5.14 验证Kubernetes Scheduler</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master /usr/local/src/kubernetes 11:48:35]# systemctl status kube-scheduler</span><br><span class="line">● kube-scheduler.service - Kubernetes Scheduler</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/kube-scheduler.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since 四 2018-06-07 11:48:35 CST; 7s ago</span><br><span class="line">     Docs: https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line"> Main PID: 22942 (kube-scheduler)</span><br><span class="line">    Tasks: 6</span><br><span class="line">   Memory: 8.2M</span><br><span class="line">   CGroup: /system.slice/kube-scheduler.service</span><br><span class="line">           └─22942 /opt/kubernetes/bin/kube-scheduler --address=127.0.0.1 --master=http://127.0.0.1:8080 --leader-elect=true --v=2 --logtostderr=false --log-dir=/opt/kubernetes/log</span><br><span class="line"></span><br><span class="line">6月 07 11:48:35 k8s-master systemd[1]: Started Kubernetes Scheduler.</span><br><span class="line">6月 07 11:48:35 k8s-master systemd[1]: Starting Kubernetes Scheduler...</span><br><span class="line">[root@k8s-master /usr/local/src/kubernetes 11:48:42]#</span><br></pre></td></tr></table></figure><h3 id="5-15-部署kubectl命令"><a href="#5-15-部署kubectl命令" class="headerlink" title="5.15 部署kubectl命令"></a>5.15 部署kubectl命令</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tar zxf kubernetes-client-linux-amd64.tar.gz.tar </span><br><span class="line">cd /usr/local/src/kubernetes/client/bin</span><br><span class="line">cp kubectl /opt/kubernetes/bin/</span><br></pre></td></tr></table></figure><h3 id="5-16-创建-admin-证书签名请求"><a href="#5-16-创建-admin-证书签名请求" class="headerlink" title="5.16 创建 admin 证书签名请求"></a>5.16 创建 admin 证书签名请求</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/src/ssl/</span><br><span class="line">cat &gt; admin-csr.json&lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;admin&quot;,</span><br><span class="line">  &quot;hosts&quot;: [],</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">      &quot;ST&quot;: &quot;TianJin&quot;,</span><br><span class="line">      &quot;L&quot;: &quot;TianJin&quot;,</span><br><span class="line">      &quot;O&quot;: &quot;system:masters&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;System&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="5-17-生成admin证书、私钥"><a href="#5-17-生成admin证书、私钥" class="headerlink" title="5.17 生成admin证书、私钥"></a>5.17 生成admin证书、私钥</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert -ca=/opt/kubernetes/ssl/ca.pem \</span><br><span class="line">   -ca-key=/opt/kubernetes/ssl/ca-key.pem \</span><br><span class="line">   -config=/opt/kubernetes/ssl/ca-config.json \</span><br><span class="line">   -profile=kubernetes admin-csr.json | cfssljson -bare admin</span><br><span class="line">mv admin*.pem /opt/kubernetes/ssl/</span><br></pre></td></tr></table></figure><h3 id="5-18-设置集群参数"><a href="#5-18-设置集群参数" class="headerlink" title="5.18 设置集群参数"></a>5.18 设置集群参数</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl config set-cluster kubernetes \</span><br><span class="line">   --certificate-authority=/opt/kubernetes/ssl/ca.pem \</span><br><span class="line">   --embed-certs=true \</span><br><span class="line">   --server=https://192.168.217.10:6443</span><br></pre></td></tr></table></figure><h3 id="5-19-设置客户端认证参数"><a href="#5-19-设置客户端认证参数" class="headerlink" title="5.19 设置客户端认证参数"></a>5.19 设置客户端认证参数</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl config set-credentials admin \</span><br><span class="line">   --client-certificate=/opt/kubernetes/ssl/admin.pem \</span><br><span class="line">   --embed-certs=true \</span><br><span class="line">   --client-key=/opt/kubernetes/ssl/admin-key.pem</span><br></pre></td></tr></table></figure><h3 id="5-20-设置上下文参数"><a href="#5-20-设置上下文参数" class="headerlink" title="5.20 设置上下文参数"></a>5.20 设置上下文参数</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl config set-context kubernetes \</span><br><span class="line">   --cluster=kubernetes \</span><br><span class="line">   --user=admin</span><br></pre></td></tr></table></figure><h3 id="5-21-设置默认上下文"><a href="#5-21-设置默认上下文" class="headerlink" title="5.21 设置默认上下文"></a>5.21 设置默认上下文</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl config use-context kubernetes</span><br></pre></td></tr></table></figure><h3 id="5-22-使用kubectl命令验证"><a href="#5-22-使用kubectl命令验证" class="headerlink" title="5.22 使用kubectl命令验证"></a>5.22 使用kubectl命令验证</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master /usr/local/src/ssl 11:58:48]# kubectl get cs</span><br><span class="line">NAME                 STATUS    MESSAGE             ERROR</span><br><span class="line">scheduler            Healthy   ok                  </span><br><span class="line">etcd-1               Healthy   &#123;&quot;health&quot;:&quot;true&quot;&#125;   </span><br><span class="line">etcd-2               Healthy   &#123;&quot;health&quot;:&quot;true&quot;&#125;   </span><br><span class="line">controller-manager   Healthy   ok                  </span><br><span class="line">etcd-0               Healthy   &#123;&quot;health&quot;:&quot;true&quot;&#125;   </span><br><span class="line">[root@k8s-master /usr/local/src/ssl 11:58:58]#</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      descriptions
    
    </summary>
    
      <category term="运维" scheme="http://www.duoyichen.xyz/categories/%E8%BF%90%E7%BB%B4/"/>
    
    
      <category term="kubernets" scheme="http://www.duoyichen.xyz/tags/kubernets/"/>
    
      <category term="docker" scheme="http://www.duoyichen.xyz/tags/docker/"/>
    
      <category term="容器" scheme="http://www.duoyichen.xyz/tags/%E5%AE%B9%E5%99%A8/"/>
    
  </entry>
  
  <entry>
    <title>Kubernets集群安装部署 03</title>
    <link href="http://www.duoyichen.xyz/2018-10/k8s-3/"/>
    <id>http://www.duoyichen.xyz/2018-10/k8s-3/</id>
    <published>2018-10-01T20:15:57.000Z</published>
    <updated>2018-10-01T23:24:01.653Z</updated>
    
    <content type="html"><![CDATA[<p><br></p><h2 id="五、安装Master"><a href="#五、安装Master" class="headerlink" title="五、安装Master"></a>五、安装Master</h2><h3 id="5-1-安装软件"><a href="#5-1-安装软件" class="headerlink" title="5.1 安装软件"></a>5.1 安装软件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tar zxf kubernetes-server-linux-amd64.tar.gz.tar</span><br><span class="line">cd kubernetes</span><br><span class="line">cp server/bin/kube-apiserver /opt/kubernetes/bin/</span><br><span class="line">cp server/bin/kube-controller-manager /opt/kubernetes/bin/</span><br><span class="line">cp server/bin/kube-scheduler /opt/kubernetes/bin/</span><br></pre></td></tr></table></figure><h3 id="5-2-创建生成CSR的-JSON-配置文件"><a href="#5-2-创建生成CSR的-JSON-配置文件" class="headerlink" title="5.2 创建生成CSR的 JSON 配置文件"></a>5.2 创建生成CSR的 JSON 配置文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&gt;kubernetes-csr.json&lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;kubernetes&quot;,</span><br><span class="line">  &quot;hosts&quot;: [</span><br><span class="line">    &quot;127.0.0.1&quot;,</span><br><span class="line">    &quot;192.168.217.10&quot;,</span><br><span class="line">    &quot;10.1.0.1&quot;,</span><br><span class="line">    &quot;kubernetes&quot;,</span><br><span class="line">    &quot;kubernetes.default&quot;,</span><br><span class="line">    &quot;kubernetes.default.svc&quot;,</span><br><span class="line">    &quot;kubernetes.default.svc.cluster&quot;,</span><br><span class="line">    &quot;kubernetes.default.svc.cluster.local&quot;</span><br><span class="line">  ],</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">      &quot;ST&quot;: &quot;TianJin&quot;,</span><br><span class="line">      &quot;L&quot;: &quot;TianJin&quot;,</span><br><span class="line">      &quot;O&quot;: &quot;k8s&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;System&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="5-3-生成-kubernetes-证书和私钥"><a href="#5-3-生成-kubernetes-证书和私钥" class="headerlink" title="5.3 生成 kubernetes 证书和私钥"></a>5.3 生成 kubernetes 证书和私钥</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert -ca=/opt/kubernetes/ssl/ca.pem \</span><br><span class="line">   -ca-key=/opt/kubernetes/ssl/ca-key.pem \</span><br><span class="line">   -config=/opt/kubernetes/ssl/ca-config.json \</span><br><span class="line">   -profile=kubernetes kubernetes-csr.json | cfssljson -bare kubernetes</span><br><span class="line">cp kubernetes*.pem /opt/kubernetes/ssl/</span><br><span class="line">scp kubernetes*.pem k8s-node1:/opt/kubernetes/ssl/</span><br><span class="line">scp kubernetes*.pem k8s-node2:/opt/kubernetes/ssl/</span><br></pre></td></tr></table></figure><h3 id="5-4-创建-kube-apiserver-使用的客户端-token-文件"><a href="#5-4-创建-kube-apiserver-使用的客户端-token-文件" class="headerlink" title="5.4 创建 kube-apiserver 使用的客户端 token 文件"></a>5.4 创建 kube-apiserver 使用的客户端 token 文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">token=$(head -c 16 /dev/urandom | od -An -t x | tr -d &apos; &apos;) </span><br><span class="line">echo &quot;$token,kubelet-bootstrap,10001,\&quot;system:kubelet-bootstrap\&quot;&quot; &gt; /opt/kubernetes/ssl/bootstrap-token.csv</span><br></pre></td></tr></table></figure><h3 id="5-5-创建基础用户名-密码认证配置"><a href="#5-5-创建基础用户名-密码认证配置" class="headerlink" title="5.5 创建基础用户名/密码认证配置"></a>5.5 创建基础用户名/密码认证配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;/opt/kubernetes/ssl/basic-auth.csv&lt;&lt;EOF</span><br><span class="line">admin,admin,1</span><br><span class="line">readonly,readonly,2</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="5-6-创建API-Server服务"><a href="#5-6-创建API-Server服务" class="headerlink" title="5.6 创建API Server服务"></a>5.6 创建API Server服务</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;/usr/lib/systemd/system/kube-apiserver.service&lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes API Server</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kube-apiserver \</span><br><span class="line">  --admission-control=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,ResourceQuota,NodeRestriction \</span><br><span class="line">  --bind-address=192.168.217.10 \</span><br><span class="line">  --insecure-bind-address=127.0.0.1 \</span><br><span class="line">  --authorization-mode=Node,RBAC \</span><br><span class="line">  --runtime-config=rbac.authorization.k8s.io/v1 \</span><br><span class="line">  --kubelet-https=true \</span><br><span class="line">  --anonymous-auth=false \</span><br><span class="line">  --basic-auth-file=/opt/kubernetes/ssl/basic-auth.csv \</span><br><span class="line">  --enable-bootstrap-token-auth \</span><br><span class="line">  --token-auth-file=/opt/kubernetes/ssl/bootstrap-token.csv \</span><br><span class="line">  --service-cluster-ip-range=10.1.0.0/16 \</span><br><span class="line">  --service-node-port-range=20000-40000 \</span><br><span class="line">  --tls-cert-file=/opt/kubernetes/ssl/kubernetes.pem \</span><br><span class="line">  --tls-private-key-file=/opt/kubernetes/ssl/kubernetes-key.pem \</span><br><span class="line">  --client-ca-file=/opt/kubernetes/ssl/ca.pem \</span><br><span class="line">  --service-account-key-file=/opt/kubernetes/ssl/ca-key.pem \</span><br><span class="line">  --etcd-cafile=/opt/kubernetes/ssl/ca.pem \</span><br><span class="line">  --etcd-certfile=/opt/kubernetes/ssl/kubernetes.pem \</span><br><span class="line">  --etcd-keyfile=/opt/kubernetes/ssl/kubernetes-key.pem \</span><br><span class="line">  --etcd-servers=https://192.168.217.10:2379,https://192.168.217.20:2379,https://192.168.217.30:2379 \</span><br><span class="line">  --enable-swagger-ui=true \</span><br><span class="line">  --allow-privileged=true \</span><br><span class="line">  --audit-log-maxage=30 \</span><br><span class="line">  --audit-log-maxbackup=3 \</span><br><span class="line">  --audit-log-maxsize=100 \</span><br><span class="line">  --audit-log-path=/opt/kubernetes/log/api-audit.log \</span><br><span class="line">  --event-ttl=1h \</span><br><span class="line">  --v=2 \</span><br><span class="line">  --logtostderr=false \</span><br><span class="line">  --log-dir=/opt/kubernetes/log</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line">Type=notify</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      descriptions
    
    </summary>
    
      <category term="运维" scheme="http://www.duoyichen.xyz/categories/%E8%BF%90%E7%BB%B4/"/>
    
    
      <category term="kubernets" scheme="http://www.duoyichen.xyz/tags/kubernets/"/>
    
      <category term="docker" scheme="http://www.duoyichen.xyz/tags/docker/"/>
    
      <category term="容器" scheme="http://www.duoyichen.xyz/tags/%E5%AE%B9%E5%99%A8/"/>
    
  </entry>
  
  <entry>
    <title>Kubernets集群安装部署 02</title>
    <link href="http://www.duoyichen.xyz/2018-10/k8s-2/"/>
    <id>http://www.duoyichen.xyz/2018-10/k8s-2/</id>
    <published>2018-10-01T20:14:57.000Z</published>
    <updated>2018-10-01T23:23:59.041Z</updated>
    
    <content type="html"><![CDATA[<p><br></p><h2 id="四、部署ETCD集群"><a href="#四、部署ETCD集群" class="headerlink" title="四、部署ETCD集群"></a>四、部署ETCD集群</h2><h3 id="4-1安装ETCD-在master执行"><a href="#4-1安装ETCD-在master执行" class="headerlink" title="4.1安装ETCD(在master执行)"></a>4.1安装ETCD(在master执行)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tar zxf etcd-v3.3.6-linux-amd64.tar.gz </span><br><span class="line">cd etcd-v3.3.6-linux-amd64</span><br><span class="line">cp etcd etcdctl /opt/kubernetes/bin/ </span><br><span class="line">scp etcd etcdctl k8s-node1:/opt/kubernetes/bin/</span><br><span class="line">scp etcd etcdctl k8s-node2:/opt/kubernetes/bin/</span><br></pre></td></tr></table></figure><h3 id="4-2-创建etcd证书签名请求-在master执行"><a href="#4-2-创建etcd证书签名请求-在master执行" class="headerlink" title="4.2 创建etcd证书签名请求(在master执行)"></a>4.2 创建etcd证书签名请求(在master执行)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&gt;etcd-csr.json&lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;etcd&quot;,</span><br><span class="line">  &quot;hosts&quot;: [</span><br><span class="line">    &quot;127.0.0.1&quot;,</span><br><span class="line">&quot;192.168.217.10&quot;,</span><br><span class="line">&quot;192.168.217.20&quot;,</span><br><span class="line">&quot;192.168.217.30&quot;</span><br><span class="line">  ],</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">      &quot;ST&quot;: &quot;TianJin&quot;,</span><br><span class="line">      &quot;L&quot;: &quot;TianJin&quot;,</span><br><span class="line">      &quot;O&quot;: &quot;k8s&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;System&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="4-3-生成-etcd-证书和私钥-在master执行"><a href="#4-3-生成-etcd-证书和私钥-在master执行" class="headerlink" title="4.3 生成 etcd 证书和私钥(在master执行)"></a>4.3 生成 etcd 证书和私钥(在master执行)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master /usr/local/src/ssl 09:40:24]# cfssl gencert -ca=/opt/kubernetes/ssl/ca.pem \</span><br><span class="line">   -ca-key=/opt/kubernetes/ssl/ca-key.pem \</span><br><span class="line">   -config=/opt/kubernetes/ssl/ca-config.json \</span><br><span class="line">   -profile=kubernetes etcd-csr.json | cfssljson -bare etcd</span><br><span class="line">2018/06/07 09:41:02 [INFO] generate received request</span><br><span class="line">2018/06/07 09:41:02 [INFO] received CSR</span><br><span class="line">2018/06/07 09:41:02 [INFO] generating key: rsa-2048</span><br><span class="line">2018/06/07 09:41:02 [INFO] encoded CSR</span><br><span class="line">2018/06/07 09:41:02 [INFO] signed certificate with serial number 572998794032319495782221835898884368761935481424</span><br><span class="line">2018/06/07 09:41:02 [WARNING] This certificate lacks a &quot;hosts&quot; field. This makes it unsuitable for</span><br><span class="line">websites. For more information see the Baseline Requirements for the Issuance and Management</span><br><span class="line">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);</span><br><span class="line">specifically, section 10.2.3 (&quot;Information Requirements&quot;).</span><br><span class="line">[root@k8s-master /usr/local/src/ssl 09:41:02]# ls -l etcd*</span><br><span class="line">-rw-r--r--. 1 root root 1086 6月   7 09:41 etcd.csr</span><br><span class="line">-rw-r--r--. 1 root root  288 6月   7 09:38 etcd-csr.json</span><br><span class="line">-rw-------. 1 root root 1675 6月   7 09:41 etcd-key.pem</span><br><span class="line">-rw-r--r--. 1 root root 1456 6月   7 09:41 etcd.pem</span><br></pre></td></tr></table></figure><h3 id="4-4-将证书移动到-opt-kubernetes-ssl目录下-在master执行"><a href="#4-4-将证书移动到-opt-kubernetes-ssl目录下-在master执行" class="headerlink" title="4.4 将证书移动到/opt/kubernetes/ssl目录下(在master执行)"></a>4.4 将证书移动到/opt/kubernetes/ssl目录下(在master执行)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cp etcd*.pem /opt/kubernetes/ssl</span><br><span class="line">scp etcd*.pem k8s-node1:/opt/kubernetes/ssl</span><br><span class="line">scp etcd*.pem k8s-node2:/opt/kubernetes/ssl</span><br><span class="line">rm -f etcd.csr etcd-csr.json</span><br></pre></td></tr></table></figure><h3 id="4-5-设置ETCD配置文件"><a href="#4-5-设置ETCD配置文件" class="headerlink" title="4.5 设置ETCD配置文件"></a>4.5 设置ETCD配置文件</h3><h4 id="master配置"><a href="#master配置" class="headerlink" title="master配置"></a>master配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&gt;/opt/kubernetes/cfg/etcd.conf&lt;&lt;EOF</span><br><span class="line">#[member]</span><br><span class="line">ETCD_NAME=&quot;etcd-node1&quot;</span><br><span class="line">ETCD_DATA_DIR=&quot;/var/lib/etcd/default.etcd&quot;</span><br><span class="line">#ETCD_SNAPSHOT_COUNTER=&quot;10000&quot;</span><br><span class="line">#ETCD_HEARTBEAT_INTERVAL=&quot;100&quot;</span><br><span class="line">#ETCD_ELECTION_TIMEOUT=&quot;1000&quot;</span><br><span class="line">ETCD_LISTEN_PEER_URLS=&quot;https://192.168.217.10:2380&quot;</span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=&quot;https://192.168.217.10:2379,https://127.0.0.1:2379&quot;</span><br><span class="line">#ETCD_MAX_SNAPSHOTS=&quot;5&quot;</span><br><span class="line">#ETCD_MAX_WALS=&quot;5&quot;</span><br><span class="line">#ETCD_CORS=&quot;&quot;</span><br><span class="line">#[cluster]</span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=&quot;https://192.168.217.10:2380&quot;</span><br><span class="line"># if you use different ETCD_NAME (e.g. test),</span><br><span class="line"># set ETCD_INITIAL_CLUSTER value for this name, i.e. &quot;test=http://...&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER=&quot;etcd-node1=https://192.168.217.10:2380,etcd-node2=https://192.168.217.20:2380,etcd-node3=https://192.168.217.30:2380&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=&quot;new&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=&quot;k8s-etcd-cluster&quot;</span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=&quot;https://192.168.217.10:2379&quot;</span><br><span class="line">#[security]</span><br><span class="line">CLIENT_CERT_AUTH=&quot;true&quot;</span><br><span class="line">ETCD_CA_FILE=&quot;/opt/kubernetes/ssl/ca.pem&quot;</span><br><span class="line">ETCD_CERT_FILE=&quot;/opt/kubernetes/ssl/etcd.pem&quot;</span><br><span class="line">ETCD_KEY_FILE=&quot;/opt/kubernetes/ssl/etcd-key.pem&quot;</span><br><span class="line">PEER_CLIENT_CERT_AUTH=&quot;true&quot;</span><br><span class="line">ETCD_PEER_CA_FILE=&quot;/opt/kubernetes/ssl/ca.pem&quot;</span><br><span class="line">ETCD_PEER_CERT_FILE=&quot;/opt/kubernetes/ssl/etcd.pem&quot;</span><br><span class="line">ETCD_PEER_KEY_FILE=&quot;/opt/kubernetes/ssl/etcd-key.pem&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="node1而配置"><a href="#node1而配置" class="headerlink" title="node1而配置"></a>node1而配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&gt;/opt/kubernetes/cfg/etcd.conf&lt;&lt;EOF</span><br><span class="line">#[member]</span><br><span class="line">ETCD_NAME=&quot;etcd-node2&quot;</span><br><span class="line">ETCD_DATA_DIR=&quot;/var/lib/etcd/default.etcd&quot;</span><br><span class="line">#ETCD_SNAPSHOT_COUNTER=&quot;10000&quot;</span><br><span class="line">#ETCD_HEARTBEAT_INTERVAL=&quot;100&quot;</span><br><span class="line">#ETCD_ELECTION_TIMEOUT=&quot;1000&quot;</span><br><span class="line">ETCD_LISTEN_PEER_URLS=&quot;https://192.168.217.20:2380&quot;</span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=&quot;https://192.168.217.20:2379,https://127.0.0.1:2379&quot;</span><br><span class="line">#ETCD_MAX_SNAPSHOTS=&quot;5&quot;</span><br><span class="line">#ETCD_MAX_WALS=&quot;5&quot;</span><br><span class="line">#ETCD_CORS=&quot;&quot;</span><br><span class="line">#[cluster]</span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=&quot;https://192.168.217.20:2380&quot;</span><br><span class="line"># if you use different ETCD_NAME (e.g. test),</span><br><span class="line"># set ETCD_INITIAL_CLUSTER value for this name, i.e. &quot;test=http://...&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER=&quot;etcd-node1=https://192.168.217.10:2380,etcd-node2=https://192.168.217.20:2380,etcd-node3=https://192.168.217.30:2380&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=&quot;new&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=&quot;k8s-etcd-cluster&quot;</span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=&quot;https://192.168.217.20:2379&quot;</span><br><span class="line">#[security]</span><br><span class="line">CLIENT_CERT_AUTH=&quot;true&quot;</span><br><span class="line">ETCD_CA_FILE=&quot;/opt/kubernetes/ssl/ca.pem&quot;</span><br><span class="line">ETCD_CERT_FILE=&quot;/opt/kubernetes/ssl/etcd.pem&quot;</span><br><span class="line">ETCD_KEY_FILE=&quot;/opt/kubernetes/ssl/etcd-key.pem&quot;</span><br><span class="line">PEER_CLIENT_CERT_AUTH=&quot;true&quot;</span><br><span class="line">ETCD_PEER_CA_FILE=&quot;/opt/kubernetes/ssl/ca.pem&quot;</span><br><span class="line">ETCD_PEER_CERT_FILE=&quot;/opt/kubernetes/ssl/etcd.pem&quot;</span><br><span class="line">ETCD_PEER_KEY_FILE=&quot;/opt/kubernetes/ssl/etcd-key.pem&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="node2配置"><a href="#node2配置" class="headerlink" title="node2配置"></a>node2配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&gt;/opt/kubernetes/cfg/etcd.conf&lt;&lt;EOF</span><br><span class="line">#[member]</span><br><span class="line">ETCD_NAME=&quot;etcd-node3&quot;</span><br><span class="line">ETCD_DATA_DIR=&quot;/var/lib/etcd/default.etcd&quot;</span><br><span class="line">#ETCD_SNAPSHOT_COUNTER=&quot;10000&quot;</span><br><span class="line">#ETCD_HEARTBEAT_INTERVAL=&quot;100&quot;</span><br><span class="line">#ETCD_ELECTION_TIMEOUT=&quot;1000&quot;</span><br><span class="line">ETCD_LISTEN_PEER_URLS=&quot;https://192.168.217.30:2380&quot;</span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=&quot;https://192.168.217.30:2379,https://127.0.0.1:2379&quot;</span><br><span class="line">#ETCD_MAX_SNAPSHOTS=&quot;5&quot;</span><br><span class="line">#ETCD_MAX_WALS=&quot;5&quot;</span><br><span class="line">#ETCD_CORS=&quot;&quot;</span><br><span class="line">#[cluster]</span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=&quot;https://192.168.217.30:2380&quot;</span><br><span class="line"># if you use different ETCD_NAME (e.g. test),</span><br><span class="line"># set ETCD_INITIAL_CLUSTER value for this name, i.e. &quot;test=http://...&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER=&quot;etcd-node1=https://192.168.217.10:2380,etcd-node2=https://192.168.217.20:2380,etcd-node3=https://192.168.217.30:2380&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=&quot;new&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=&quot;k8s-etcd-cluster&quot;</span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=&quot;https:/192.168.217.30:2379&quot;</span><br><span class="line">#[security]</span><br><span class="line">CLIENT_CERT_AUTH=&quot;true&quot;</span><br><span class="line">ETCD_CA_FILE=&quot;/opt/kubernetes/ssl/ca.pem&quot;</span><br><span class="line">ETCD_CERT_FILE=&quot;/opt/kubernetes/ssl/etcd.pem&quot;</span><br><span class="line">ETCD_KEY_FILE=&quot;/opt/kubernetes/ssl/etcd-key.pem&quot;</span><br><span class="line">PEER_CLIENT_CERT_AUTH=&quot;true&quot;</span><br><span class="line">ETCD_PEER_CA_FILE=&quot;/opt/kubernetes/ssl/ca.pem&quot;</span><br><span class="line">ETCD_PEER_CERT_FILE=&quot;/opt/kubernetes/ssl/etcd.pem&quot;</span><br><span class="line">ETCD_PEER_KEY_FILE=&quot;/opt/kubernetes/ssl/etcd-key.pem&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="4-4-创建etcd服务-在所有节点执行"><a href="#4-4-创建etcd服务-在所有节点执行" class="headerlink" title="4.4 创建etcd服务(在所有节点执行)"></a>4.4 创建etcd服务(在所有节点执行)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&gt;/etc/systemd/system/etcd.service&lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Etcd Server</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">WorkingDirectory=/var/lib/etcd</span><br><span class="line">EnvironmentFile=-/opt/kubernetes/cfg/etcd.conf</span><br><span class="line"># set GOMAXPROCS to number of processors</span><br><span class="line">ExecStart=/bin/bash -c &quot;GOMAXPROCS=$(nproc) /opt/kubernetes/bin/etcd&quot;</span><br><span class="line">Type=notify</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="4-5-启动ectd集群-在所有节点执行"><a href="#4-5-启动ectd集群-在所有节点执行" class="headerlink" title="4.5 启动ectd集群(在所有节点执行)"></a>4.5 启动ectd集群(在所有节点执行)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable etcd</span><br><span class="line">mkdir /var/lib/etcd</span><br><span class="line">systemctl start etcd</span><br></pre></td></tr></table></figure><h3 id="4-6-检查集群状态-在master执行"><a href="#4-6-检查集群状态-在master执行" class="headerlink" title="4.6 检查集群状态(在master执行)"></a>4.6 检查集群状态(在master执行)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master /usr/local/src/ssl 10:56:14]# etcdctl --endpoints=https://192.168.217.10:2379 \</span><br><span class="line">   --ca-file=/opt/kubernetes/ssl/ca.pem \</span><br><span class="line">   --cert-file=/opt/kubernetes/ssl/etcd.pem \</span><br><span class="line">   --key-file=/opt/kubernetes/ssl/etcd-key.pem cluster-health</span><br><span class="line">member 3c012a87c4e193ac is healthy: got healthy result from https://192.168.217.20:2379</span><br><span class="line">member 3cb279d5dff870db is healthy: got healthy result from https://192.168.217.30:2379</span><br><span class="line">member 92b780d24fec7c16 is healthy: got healthy result from https://192.168.217.10:2379</span><br><span class="line">cluster is healthy</span><br><span class="line">[root@k8s-master /usr/local/src/ssl 10:56:26]#</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      descriptions
    
    </summary>
    
      <category term="运维" scheme="http://www.duoyichen.xyz/categories/%E8%BF%90%E7%BB%B4/"/>
    
    
      <category term="kubernets" scheme="http://www.duoyichen.xyz/tags/kubernets/"/>
    
      <category term="docker" scheme="http://www.duoyichen.xyz/tags/docker/"/>
    
      <category term="容器" scheme="http://www.duoyichen.xyz/tags/%E5%AE%B9%E5%99%A8/"/>
    
  </entry>
  
  <entry>
    <title>Kubernets集群安装部署 01</title>
    <link href="http://www.duoyichen.xyz/2018-10/k8s/"/>
    <id>http://www.duoyichen.xyz/2018-10/k8s/</id>
    <published>2018-10-01T20:13:57.000Z</published>
    <updated>2018-10-01T23:23:56.868Z</updated>
    
    <content type="html"><![CDATA[<p><br></p><h2 id="一、环境约定"><a href="#一、环境约定" class="headerlink" title="一、环境约定"></a>一、环境约定</h2><table><thead><tr><th>主机名</th><th style="text-align:center">IP</th><th style="text-align:center">安装的软件</th></tr></thead><tbody><tr><td>kube-master</td><td style="text-align:center">192.168.217.10</td><td style="text-align:center">etcd、kube-apiserver、kube-controller、kube-scheduler、kubectl</td></tr><tr><td>kube-node1</td><td style="text-align:center">192.168.217.20</td><td style="text-align:center">etcd、kube-node、kube-proxy</td></tr><tr><td>kube-node2</td><td style="text-align:center">192.168.217.30</td><td style="text-align:center">etcd、kube-node、kube-proxy</td></tr></tbody></table><h2 id="二、环境准备"><a href="#二、环境准备" class="headerlink" title="二、环境准备"></a>二、环境准备</h2><h3 id="2-1-创建目录添加PATH-在所有节点执行"><a href="#2-1-创建目录添加PATH-在所有节点执行" class="headerlink" title="2.1 创建目录添加PATH(在所有节点执行)"></a>2.1 创建目录添加PATH(在所有节点执行)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /opt/kubernetes/&#123;cfg,bin,ssl,log&#125;</span><br><span class="line">echo &quot;export PATH=/opt/kubernetes/bin:\$PATH&quot; &gt;&gt; /root/.bash_profile  </span><br><span class="line">source /root/.bash_profile</span><br></pre></td></tr></table></figure><h3 id="2-2-安装docker-在所有节点执行"><a href="#2-2-安装docker-在所有节点执行" class="headerlink" title="2.2 安装docker(在所有节点执行)"></a>2.2 安装docker(在所有节点执行)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -sSL https://get.daocloud.io/docker | sh</span><br><span class="line">systemctl start docker.service </span><br><span class="line">systemctl enable docker.service</span><br></pre></td></tr></table></figure><h3 id="2-3-修改host-在所有节点执行"><a href="#2-3-修改host-在所有节点执行" class="headerlink" title="2.3 修改host(在所有节点执行)"></a>2.3 修改host(在所有节点执行)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&gt;/etc/hosts/&lt;&lt;EOF</span><br><span class="line">192.168.217.10  k8s-master</span><br><span class="line">192.168.217.20  k8s-node1</span><br><span class="line">192.168.217.30  k8s-node2</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="2-4拉取测试镜像-可不执行"><a href="#2-4拉取测试镜像-可不执行" class="headerlink" title="2.4拉取测试镜像(可不执行)"></a>2.4拉取测试镜像(可不执行)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker pull daocloud.io/library/nginx:1.13.2</span><br><span class="line">docker pull daocloud.io/library/nginx:1.10.2</span><br></pre></td></tr></table></figure><h3 id="2-5-配置免密码登录-在master执行"><a href="#2-5-配置免密码登录-在master执行" class="headerlink" title="2.5 配置免密码登录(在master执行)"></a>2.5 配置免密码登录(在master执行)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa</span><br><span class="line">ssh-copy-id k8s-node1</span><br><span class="line">ssh-copy-id k8s-node2</span><br></pre></td></tr></table></figure><h2 id="三、制作CA证书-在master节点操作"><a href="#三、制作CA证书-在master节点操作" class="headerlink" title="三、制作CA证书(在master节点操作)"></a>三、制作CA证书(在master节点操作)</h2><h3 id="3-1-将程序拷贝到相应目录并授权执行"><a href="#3-1-将程序拷贝到相应目录并授权执行" class="headerlink" title="3.1 将程序拷贝到相应目录并授权执行"></a>3.1 将程序拷贝到相应目录并授权执行</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">chmod +x cfssl*</span><br><span class="line">mv cfssl-certinfo_linux-amd64 /opt/kubernetes/bin/cfssl-certinfo</span><br><span class="line">mv cfssljson_linux-amd64  /opt/kubernetes/bin/cfssljson</span><br><span class="line">mv cfssl_linux-amd64  /opt/kubernetes/bin/cfssl</span><br></pre></td></tr></table></figure><h3 id="3-2-拷贝文件到其他节点"><a href="#3-2-拷贝文件到其他节点" class="headerlink" title="3.2 拷贝文件到其他节点"></a>3.2 拷贝文件到其他节点</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scp /opt/kubernetes/bin/cfssl* k8s-node1:/opt/kubernetes/bin</span><br><span class="line">scp /opt/kubernetes/bin/cfssl* k8s-node2:/opt/kubernetes/bin</span><br></pre></td></tr></table></figure><h3 id="3-3-初始化"><a href="#3-3-初始化" class="headerlink" title="3.3 初始化"></a>3.3 初始化</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir ssl &amp;&amp; cd ssl</span><br><span class="line">cfssl print-defaults config &gt; config.json</span><br><span class="line">cfssl print-defaults csr &gt; csr.json</span><br></pre></td></tr></table></figure><h3 id="3-4-创建用来生成-CA-文件的-JSON-配置文件"><a href="#3-4-创建用来生成-CA-文件的-JSON-配置文件" class="headerlink" title="3.4 创建用来生成 CA 文件的 JSON 配置文件"></a>3.4 创建用来生成 CA 文件的 JSON 配置文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&gt;ca-config.json&lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;signing&quot;: &#123;</span><br><span class="line">    &quot;default&quot;: &#123;</span><br><span class="line">      &quot;expiry&quot;: &quot;8760h&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;profiles&quot;: &#123;</span><br><span class="line">      &quot;kubernetes&quot;: &#123;</span><br><span class="line">        &quot;usages&quot;: [</span><br><span class="line">            &quot;signing&quot;,</span><br><span class="line">            &quot;key encipherment&quot;,</span><br><span class="line">            &quot;server auth&quot;,</span><br><span class="line">            &quot;client auth&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;expiry&quot;: &quot;8760h&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="3-5-创建用来生成-CA-证书签名请求（CSR）的-JSON-配置文件"><a href="#3-5-创建用来生成-CA-证书签名请求（CSR）的-JSON-配置文件" class="headerlink" title="3.5 创建用来生成 CA 证书签名请求（CSR）的 JSON 配置文件"></a>3.5 创建用来生成 CA 证书签名请求（CSR）的 JSON 配置文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&gt;ca-csr.json&lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;kubernetes&quot;,</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">      &quot;ST&quot;: &quot;TianJin&quot;,</span><br><span class="line">      &quot;L&quot;: &quot;TianJin&quot;,</span><br><span class="line">      &quot;O&quot;: &quot;k8s&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;System&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="3-6生成CA证书（ca-pem）和密钥（ca-key-pem）"><a href="#3-6生成CA证书（ca-pem）和密钥（ca-key-pem）" class="headerlink" title="3.6生成CA证书（ca.pem）和密钥（ca-key.pem）"></a>3.6生成CA证书（ca.pem）和密钥（ca-key.pem）</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ssl]# cfssl gencert -initca ca-csr.json | cfssljson -bare ca</span><br><span class="line">2018/06/07 09:30:16 [INFO] generating a new CA key and certificate from CSR</span><br><span class="line">2018/06/07 09:30:16 [INFO] generate received request</span><br><span class="line">2018/06/07 09:30:16 [INFO] received CSR</span><br><span class="line">2018/06/07 09:30:16 [INFO] generating key: rsa-2048</span><br><span class="line">2018/06/07 09:30:17 [INFO] encoded CSR</span><br><span class="line">2018/06/07 09:30:17 [INFO] signed certificate with serial number 442587652045208440377444170631446076181330771637</span><br><span class="line">[root@k8s-master ssl]# ls -l ca*</span><br><span class="line">-rw-r--r--. 1 root root  290 6月   7 09:11 ca-config.json</span><br><span class="line">-rw-r--r--. 1 root root 1001 6月   7 09:30 ca.csr</span><br><span class="line">-rw-r--r--. 1 root root  208 6月   7 09:12 ca-csr.json</span><br><span class="line">-rw-------. 1 root root 1675 6月   7 09:30 ca-key.pem</span><br><span class="line">-rw-r--r--. 1 root root 1359 6月   7 09:30 ca.pem</span><br></pre></td></tr></table></figure><h3 id="3-7-颁发证书"><a href="#3-7-颁发证书" class="headerlink" title="3.7 颁发证书"></a>3.7 颁发证书</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cp ca.csr ca.pem ca-key.pem ca-config.json /opt/kubernetes/ssl</span><br><span class="line">scp ca.csr ca.pem ca-key.pem ca-config.json k8s-node1:/opt/kubernetes/ssl </span><br><span class="line">scp ca.csr ca.pem ca-key.pem ca-config.json k8s-node2:/opt/kubernetes/ssl</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      descriptions
    
    </summary>
    
      <category term="运维" scheme="http://www.duoyichen.xyz/categories/%E8%BF%90%E7%BB%B4/"/>
    
    
      <category term="kubernets" scheme="http://www.duoyichen.xyz/tags/kubernets/"/>
    
      <category term="docker" scheme="http://www.duoyichen.xyz/tags/docker/"/>
    
      <category term="容器" scheme="http://www.duoyichen.xyz/tags/%E5%AE%B9%E5%99%A8/"/>
    
  </entry>
  
  <entry>
    <title>CMDB资产管理系统</title>
    <link href="http://www.duoyichen.xyz/2018-10/cmdb/"/>
    <id>http://www.duoyichen.xyz/2018-10/cmdb/</id>
    <published>2018-10-01T20:02:22.000Z</published>
    <updated>2018-10-01T23:25:51.534Z</updated>
    
    <content type="html"><![CDATA[<p><br><br>随着互联网的进步与发展，企业的IT环境越来越复杂，数量庞大、品类繁多。如何有效地管理IT设备，降低成本，并为业提供高效的IT服务，成为很多企业面临的问题。CMDB正是来解决这些问题的，同时为运维自动化，监控报警等提供支持。<br><br><br></p><ul><li>开发环境：Windows10 + Python3.5 + PyCharm5<br></li><li>项目架构：Python3.5 + sqlite3 + Django2.1 + AdminLTE<br><br></li></ul><h4 id="1-登录界面："><a href="#1-登录界面：" class="headerlink" title="1. 登录界面："></a>1. 登录界面：</h4><p><img src="/images/P20180928002224.png" alt="P20180928002224.png"></p><h4 id="2-Django后台管理："><a href="#2-Django后台管理：" class="headerlink" title="2. Django后台管理："></a>2. Django后台管理：</h4><p><img src="/images/P20180928002341.png" alt="P20180928002341.png"></p><h4 id="3-资产审批："><a href="#3-资产审批：" class="headerlink" title="3. 资产审批："></a>3. 资产审批：</h4><p><img src="/images/P20180928002444.png" alt="P20180928002444.png"><br><img src="/images/P20180928002515.png" alt="P20180928002515.png"></p><h4 id="4-仪表盘："><a href="#4-仪表盘：" class="headerlink" title="4. 仪表盘："></a>4. 仪表盘：</h4><p><img src="/images/P20180928010934.png" alt="P20180928010934.png"></p><h4 id="5-资产总表："><a href="#5-资产总表：" class="headerlink" title="5. 资产总表："></a>5. 资产总表：</h4><p><img src="/images/P20180928011206.png" alt="P20180928011206.png"></p><h4 id="6-资产详情："><a href="#6-资产详情：" class="headerlink" title="6. 资产详情："></a>6. 资产详情：</h4><p><img src="/images/P20180928011648.png" alt="P20180928011648.png"><br><img src="/images/P20180928011653.png" alt="P20180928011653.png"></p><h4 id="7-代码架构："><a href="#7-代码架构：" class="headerlink" title="7. 代码架构："></a>7. 代码架构：</h4><p><img src="/images/P20180928011927.png" alt="P20180928011927.png"></p>]]></content>
    
    <summary type="html">
    
      descriptions
    
    </summary>
    
      <category term="开发" scheme="http://www.duoyichen.xyz/categories/%E5%BC%80%E5%8F%91/"/>
    
    
      <category term="python" scheme="http://www.duoyichen.xyz/tags/python/"/>
    
      <category term="cmdb" scheme="http://www.duoyichen.xyz/tags/cmdb/"/>
    
  </entry>
  
  <entry>
    <title>Hexo静态博客搭建指南</title>
    <link href="http://www.duoyichen.xyz/2018-10/firsr-blog/"/>
    <id>http://www.duoyichen.xyz/2018-10/firsr-blog/</id>
    <published>2018-10-01T01:27:47.000Z</published>
    <updated>2018-10-01T20:48:11.597Z</updated>
    
    <content type="html"><![CDATA[<p>GitHub Pages 本用于介绍托管在 GitHub 的项目，也可以用来搭建博客，有300M免费空间。</p><p>hexo是一个基于Node.js的静态博客程序，可以方便的生成静态网页托管在github和Heroku上。作者是来自台湾的 <a href="https://github.com/hexojs/hexo" title="hexo" target="_blank" rel="noopener">tommy351</a> 。</p><h3 id="优势："><a href="#优势：" class="headerlink" title="优势："></a>优势：</h3><ul><li>生成静态页面快</li><li>支持 Markdown</li><li>兼容于 Windows, Mac &amp; Linux</li><li>部署方便。日常使用仅需五个命令。</li><li>高扩展性、自订性，文件少、小，易理解</li></ul><h3 id="1-安装-amp-搭建"><a href="#1-安装-amp-搭建" class="headerlink" title="1. 安装 &amp; 搭建"></a>1. 安装 &amp; 搭建</h3><ul><li>安装 <a href="http://git-scm.com/" title="git" target="_blank" rel="noopener">Git</a>：安装后，注册 Github 账号，配置 SSH（具体见下一步）,打开 Git Bash,接下来的命令均在Git Bash中执行</li><li>安装 <a href="https://nodejs.org/en/" title="nodejs" target="_blank" rel="noopener">Node.js</a></li><li>安装 Hexo : <code>$ npm install -g hexo</code></li><li>安装依赖包： <code>$ npm install</code></li><li>新建博客文件夹：cd到该文件夹，执行$hexo init</li><li>新建Github仓库：仓库名必须为你的 Github名.github.io，要不然就不能使用Github Pages服务了。。。</li></ul><h3 id="2-配置-SSH"><a href="#2-配置-SSH" class="headerlink" title="2. 配置 SSH"></a>2. 配置 SSH</h3><p>　　关于什么是 SSH，请自行百度（我懒）这里直接讲一下配置步骤。  </p><ul><li>本地生成公钥私钥<br>　<code>$ ssh-keygen -t rsa -C &quot;你的邮件地址&quot;</code></li><li>添加公钥到 Github <ul><li>根据上一步的提示，找到公钥文件（默认为id_rsa.pub），用记事本打开，全选并复制。</li><li>登录 Github，右上角 头像 -&gt; Settings —&gt; SSH keys —&gt; Add SSH key。把公钥粘贴到key中，填好title并点击 Add key。</li><li>git bash中输入命令 <code>$ ssh -T git@github.com</code> ，选yes，等待片刻可看到成功提示。</li></ul></li></ul><h3 id="3-NexT主题下载"><a href="#3-NexT主题下载" class="headerlink" title="3. NexT主题下载"></a>3. NexT主题下载</h3><p>　　NexT 主题是由 <a href="https://github.com/iissnan" target="_blank" rel="noopener">iissnan</a> 大神所制作的一款简洁美观不失逼格的主题。下载方法有以下两种：  </p><ul><li>进入博客根目录/themes/, 执行<code>$ git clone https://github.com/iissnan/hexo-theme-next.git</code></li><li>直接进入上面的链接，在项目主页download zip文件，然后解压到博客根目录/themes/ 文件夹</li></ul><h3 id="4-发布"><a href="#4-发布" class="headerlink" title="4. 发布"></a>4. 发布</h3><p>  使用以下两条命令进行发布，发布成功后可在浏览器中使用你的github名.github.io进入你的博客~</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ hexo clean</span><br><span class="line">$ hexo d -g</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      descriptions
    
    </summary>
    
      <category term="其他" scheme="http://www.duoyichen.xyz/categories/%E5%85%B6%E4%BB%96/"/>
    
    
      <category term="其他" scheme="http://www.duoyichen.xyz/tags/%E5%85%B6%E4%BB%96/"/>
    
  </entry>
  
  <entry>
    <title>Hello World</title>
    <link href="http://www.duoyichen.xyz/2018-10/hello-world/"/>
    <id>http://www.duoyichen.xyz/2018-10/hello-world/</id>
    <published>2018-10-01T01:07:47.000Z</published>
    <updated>2018-10-01T19:06:13.090Z</updated>
    
    <content type="html"><![CDATA[<p><br><br>前几天，开发了一套 CMDB系统 ，上传到github 。 为了展示效果，开发的时候也涉及到前端的一些东西。最近，打算搞一下 python 运维开发。开发项目，前端也很重要。正好趁十一这几天，在家研究一下前端设计以及网站制作方面的东西。<br><br></p><p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>]]></content>
    
    <summary type="html">
    
      descriptions
    
    </summary>
    
      <category term="其他" scheme="http://www.duoyichen.xyz/categories/%E5%85%B6%E4%BB%96/"/>
    
    
      <category term="其他" scheme="http://www.duoyichen.xyz/tags/%E5%85%B6%E4%BB%96/"/>
    
  </entry>
  
</feed>
